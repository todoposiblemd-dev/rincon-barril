<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Rinc√≥n del Barril - Inventario v8.3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%); min-height: 100vh; padding: 10px; }
        .container { max-width: 700px; margin: 0 auto; }
        .header { background: white; border-radius: 15px 15px 0 0; padding: 15px; text-align: center; border-bottom: 3px solid #8B0000; }
        .header h1 { color: #8B0000; font-size: 20px; margin-bottom: 5px; }
        .user-section { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f0f0f0; border-radius: 6px; font-size: 11px; margin-top: 10px; gap: 8px; flex-wrap: wrap; }
        .user-badge { background: #8B0000; color: white; padding: 4px 10px; border-radius: 15px; font-weight: 600; cursor: pointer; }
        .status-badge { display: inline-block; background: #4CAF50; color: white; padding: 4px 10px; border-radius: 15px; font-weight: 600; font-size: 10px; }
        .sync-btn { background: #2196F3; color: white; padding: 4px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 10px; font-weight: 600; }
        .tabs { display: flex; background: white; padding: 0 10px; border-bottom: 1px solid #DDD; overflow-x: auto; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 10px 6px; background: none; border: none; cursor: pointer; font-weight: 600; color: #999; border-bottom: 3px solid transparent; font-size: 9px; min-width: 45px; white-space: nowrap; }
        .tab-btn.active { color: #8B0000; border-bottom-color: #8B0000; }
        .content { background: white; padding: 15px; border-radius: 0 0 15px 15px; min-height: 600px; max-height: 80vh; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .search-box { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #DDD; border-radius: 6px; font-size: 13px; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .filter-btn { padding: 6px 10px; border: 1px solid #DDD; background: white; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 600; color: #666; }
        .filter-btn.active { background: #8B0000; color: white; border-color: #8B0000; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 11px; font-weight: 600; margin-bottom: 4px; color: #333; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #DDD; border-radius: 4px; font-size: 12px; font-family: inherit; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; }
        .btn-primary { background: #8B0000; color: white; width: 100%; }
        .btn-secondary { background: #f0f0f0; color: #333; width: 100%; border: 1px solid #DDD; }
        .btn-small { padding: 4px 8px; font-size: 10px; }
        .producto-card { background: #f9f9f9; border: 1px solid #EEE; border-radius: 6px; padding: 10px; margin-bottom: 8px; }
        .producto-nombre { font-weight: 600; font-size: 12px; }
        .producto-categoria { font-size: 10px; color: #999; margin-top: 2px; }
        .producto-saldo { font-size: 13px; font-weight: 600; color: #8B0000; text-align: right; }
        .alerta { padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 12px; font-weight: 600; }
        .alerta.success { background: #E8F5E9; color: #2E7D32; }
        .alerta.error { background: #FFEBEE; color: #C62828; }
        .lista-item { background: #f9f9f9; padding: 8px; margin-bottom: 6px; border-radius: 4px; font-size: 11px; border-left: 3px solid #8B0000; }
        .scroll-section { max-height: 300px; overflow-y: auto; }
        .estado-btn { padding: 6px 12px; border: 1px solid #DDD; background: white; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; }
        .estado-btn.active { background: #8B0000; color: white; border-color: #8B0000; }
        h3 { color: #8B0000; font-size: 12px; margin-bottom: 10px; border-bottom: 2px solid #8B0000; padding-bottom: 8px; }
        .admin-item { background: #f0f0f0; padding: 8px; margin-bottom: 6px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 11px; }
        .btn-delete { background: #FF5252; color: white; padding: 2px 6px; border: none; border-radius: 3px; cursor: pointer; font-size: 10px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçñ El Rinc√≥n del Barril</h1>
            <p>Gesti√≥n de Inventario v8.3</p>
            <div class="user-section">
                <div style="flex: 1;"><span class="user-badge" onclick="cambiarUsuario()">üë§ <span id="usuario-actual">Bodega</span></span></div>
                <div style="flex: 1;"><span class="status-badge">‚úÖ Mov: <span id="contador">0</span></span></div>
                <button class="sync-btn" onclick="sincronizarGoogleSheets()">üì§ Sincronizar</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="cambiarTab('saldos')">üìä Saldos</button>
            <button class="tab-btn" onclick="cambiarTab('entradas')">üì• Entradas</button>
            <button class="tab-btn" onclick="cambiarTab('salidas')">üì§ Salidas</button>
            <button class="tab-btn" onclick="cambiarTab('reportes')">üìà Reportes</button>
            <button class="tab-btn" onclick="cambiarTab('admin')">‚öôÔ∏è Admin</button>
        </div>

        <div class="content">
            <div id="alerta"></div>

            <!-- TAB SALDOS -->
            <div id="saldos" class="tab-content active">
                <input type="text" id="buscar-saldos" class="search-box" placeholder="üîç Buscar producto...">
                <h3>Filtrar por Categor√≠a</h3>
                <div class="filter-buttons" id="filter-buttons"><button class="filter-btn active" onclick="filtrarSaldos('todos')">Todos</button></div>
                <div id="lista-saldos"></div>
            </div>

            <!-- TAB ENTRADAS -->
            <div id="entradas" class="tab-content">
                <h3>Registrar Entrada (Compra)</h3>
                <div class="form-group"><label>Responsable *</label><select id="responsable-entrada"></select></div>
                <div class="form-group"><label>Proveedor *</label><select id="proveedor-entrada"></select></div>
                <div class="form-group"><label>Producto *</label><select id="producto-entrada" onchange="actualizarEstadoEntrada()"></select></div>
                <div id="estado-entrada-grupo" style="display: none;">
                    <label style="font-size: 11px; font-weight: 600; margin-bottom: 8px; display: block;">Estado</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoEntrada('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoEntrada('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-entrada" value="cocido">
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidad-entrada" placeholder="0.00" step="0.01" required></div>
                    <div class="form-group"><label>Costo *</label><input type="number" id="costo-entrada" placeholder="0.00" step="0.01" required></div>
                </div>
                <div class="form-row" style="gap: 8px;"><button class="btn btn-primary" onclick="registrarEntrada()">‚úÖ Registrar</button><button class="btn btn-secondary" onclick="limpiarFormEntrada()">üîÑ Limpiar</button></div>
                <h3 style="margin-top: 15px;">√öltimas Entradas</h3>
                <div class="scroll-section" id="lista-entradas"></div>
            </div>

            <!-- TAB SALIDAS -->
            <div id="salidas" class="tab-content">
                <h3>Registrar Salida</h3>
                <div class="form-group"><label>Responsable *</label><select id="responsable-salida"></select></div>
                <div class="form-group"><label>Destino *</label><select id="destino-salida"><option value="">-- Selecciona --</option><option value="cocina">üë®‚Äçüç≥ Cocina</option><option value="caja">üí∞ Caja</option><option value="barril">üçñ Barril</option><option value="consumo">ü•ò Consumo</option><option value="merma">üìâ Merma</option><option value="danio">üî• Da√±o</option></select></div>
                <div class="form-group"><label>Producto *</label><select id="producto-salida" onchange="actualizarEstadoSalida()"></select></div>
                <div id="estado-salida-grupo" style="display: none;">
                    <label style="font-size: 11px; font-weight: 600; margin-bottom: 8px; display: block;">Estado</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoSalida('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoSalida('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-salida" value="cocido">
                </div>
                <div class="form-group"><label>Cantidad *</label><input type="number" id="cantidad-salida" placeholder="0.00" step="0.01" required></div>
                <div class="form-row" style="gap: 8px;"><button class="btn btn-primary" onclick="registrarSalida()">‚úÖ Registrar</button><button class="btn btn-secondary" onclick="limpiarFormSalida()">üîÑ Limpiar</button></div>
                <h3 style="margin-top: 15px;">√öltimas Salidas</h3>
                <div class="scroll-section" id="lista-salidas"></div>
            </div>

            <!-- TAB REPORTES -->
            <div id="reportes" class="tab-content">
                <h3>Movimientos de Hoy</h3>
                <div class="scroll-section" id="lista-reportes"></div>
            </div>

            <!-- TAB ADMIN -->
            <div id="admin" class="tab-content">
                <h3>Administrar Responsables</h3>
                <div class="form-row"><input type="text" id="nuevo-responsable" placeholder="Nuevo responsable"><button class="btn btn-primary btn-small" onclick="agregarResponsable()">Agregar</button></div>
                <div id="lista-responsables"></div>

                <h3 style="margin-top: 20px;">Administrar Proveedores</h3>
                <div class="form-row"><input type="text" id="nuevo-proveedor" placeholder="Nuevo proveedor"><button class="btn btn-primary btn-small" onclick="agregarProveedor()">Agregar</button></div>
                <div id="lista-proveedores"></div>

                <h3 style="margin-top: 20px;">Administrar Categor√≠as</h3>
                <div class="form-row"><input type="text" id="nueva-categoria" placeholder="Nueva categor√≠a"><button class="btn btn-primary btn-small" onclick="agregarCategoria()">Agregar</button></div>
                <div id="lista-categorias"></div>

                <h3 style="margin-top: 20px;">Administrar Productos</h3>
                <div class="form-group"><label>Nombre *</label><input type="text" id="nuevo-producto-nombre" placeholder="Ej: Papa"></div>
                <div class="form-group"><label>Categor√≠a *</label><select id="nuevo-producto-categoria"></select></div>
                <div class="form-group"><label>Stock M√≠nimo</label><input type="number" id="nuevo-producto-minimo" placeholder="10" step="0.01"></div>
                <button class="btn btn-primary" onclick="agregarProducto()">‚úÖ Agregar Producto</button>
                <h3 style="margin-top: 15px;">Productos Existentes</h3>
                <div class="scroll-section" id="lista-productos"></div>
            </div>
        </div>
    </div>

    <script>
        let responsables = ['Bodega', 'Cocinero', 'Cajero', 'Gerente'];
        let proveedores = ['Atlantic', 'mis tres amores', 'Carnes xyz', 'Distribuidora Local'];
        let categorias = ['üçñ Prote√≠nas', 'üßÄ L√°cteos', '‚ùÑÔ∏è Congelados', 'üåæ Secos', 'ü•¨ Verduras'];
        let saldos = [
            {id: 1, nombre: 'Costilla de cerdo', categoria: 'üçñ Prote√≠nas', saldoCrudo: 3.95, saldoCocido: 0, unidad: 'kg', minimo: 5},
            {id: 2, nombre: 'Pollo', categoria: 'üçñ Prote√≠nas', saldoCrudo: 16, saldoCocido: 0, unidad: 'kg', minimo: 7},
            {id: 3, nombre: 'Queso paisa', categoria: 'üßÄ L√°cteos', saldoCrudo: 0.52, saldoCocido: 0, unidad: 'kg', minimo: 1},
            {id: 4, nombre: 'Papa', categoria: '‚ùÑÔ∏è Congelados', saldoCrudo: 12.5, saldoCocido: 0, unidad: 'kg', minimo: 10},
            {id: 5, nombre: 'Chicharr√≥n', categoria: 'üçñ Prote√≠nas', saldoCrudo: 7.7, saldoCocido: 0, unidad: 'kg', minimo: 7},
            {id: 6, nombre: 'Lomo de cerdo', categoria: 'üçñ Prote√≠nas', saldoCrudo: 9.71, saldoCocido: 0, unidad: 'kg', minimo: 4},
            {id: 7, nombre: 'Punta de anca', categoria: 'üçñ Prote√≠nas', saldoCrudo: 3.04, saldoCocido: 0, unidad: 'kg', minimo: 2},
            {id: 8, nombre: 'Carne molida CAB', categoria: 'üçñ Prote√≠nas', saldoCrudo: 17.47, saldoCocido: 0, unidad: 'kg', minimo: 0},
            {id: 9, nombre: 'Carne molida regular', categoria: 'üçñ Prote√≠nas', saldoCrudo: 24.6, saldoCocido: 0, unidad: 'kg', minimo: 4},
            {id: 10, nombre: 'Croquetas de carne', categoria: 'üçñ Prote√≠nas', saldoCrudo: 74, saldoCocido: 0, unidad: 'kg', minimo: 70},
            {id: 11, nombre: 'Pecho de res', categoria: 'üçñ Prote√≠nas', saldoCrudo: 0, saldoCocido: 0, unidad: 'kg', minimo: 0},
            {id: 12, nombre: 'Contramuslo de pollo', categoria: 'üçñ Prote√≠nas', saldoCrudo: 0, saldoCocido: 0, unidad: 'kg', minimo: 0},
            {id: 13, nombre: 'Colita de cadera', categoria: 'üçñ Prote√≠nas', saldoCrudo: 0, saldoCocido: 0, unidad: 'kg', minimo: 3},
            {id: 14, nombre: 'Morcilla', categoria: 'üçñ Prote√≠nas', saldoCrudo: 1.84, saldoCocido: 0, unidad: 'kg', minimo: 0},
            {id: 15, nombre: 'Chorizo', categoria: 'üçñ Prote√≠nas', saldoCrudo: 1.27, saldoCocido: 0, unidad: 'kg', minimo: 5},
            {id: 16, nombre: 'Queso cheddar', categoria: 'üßÄ L√°cteos', saldoCrudo: 207, saldoCocido: 0, unidad: 'kg', minimo: 80},
            {id: 17, nombre: 'Tocineta', categoria: 'üçñ Prote√≠nas', saldoCrudo: 7.6, saldoCocido: 0, unidad: 'kg', minimo: 3},
            {id: 18, nombre: 'Salchichas', categoria: 'üçñ Prote√≠nas', saldoCrudo: 19, saldoCocido: 0, unidad: 'kg', minimo: 15},
            {id: 19, nombre: 'Pan brioche de hamburguesa', categoria: 'üåæ Secos', saldoCrudo: 46, saldoCocido: 0, unidad: 'kg', minimo: 30},
            {id: 20, nombre: 'Pan brioche de perro', categoria: 'üåæ Secos', saldoCrudo: 13, saldoCocido: 0, unidad: 'kg', minimo: 10},
            {id: 21, nombre: 'Papa pastusa', categoria: 'ü•¨ Verduras', saldoCrudo: 14, saldoCocido: 0, unidad: 'kg', minimo: 4},
            {id: 22, nombre: 'Cebolla cabezona', categoria: 'ü•¨ Verduras', saldoCrudo: 18, saldoCocido: 0, unidad: 'kg', minimo: 10},
            {id: 23, nombre: 'Tomate', categoria: 'ü•¨ Verduras', saldoCrudo: 12, saldoCocido: 0, unidad: 'kg', minimo: 5},
            {id: 24, nombre: 'Panela', categoria: 'üåæ Secos', saldoCrudo: 10, saldoCocido: 0, unidad: 'kg', minimo: 5},
            {id: 25, nombre: 'Mayonesa Natucampo', categoria: 'üåæ Secos', saldoCrudo: 5, saldoCocido: 0, unidad: 'kg', minimo: 2},
            {id: 26, nombre: 'Arroz Zulia', categoria: 'üåæ Secos', saldoCrudo: 3, saldoCocido: 0, unidad: 'kg', minimo: 2},
            {id: 27, nombre: 'Frijol Bol√≥n Rojo', categoria: 'üåæ Secos', saldoCrudo: 1, saldoCocido: 0, unidad: 'kg', minimo: 1},
            {id: 28, nombre: 'Aceite Sinai', categoria: 'üåæ Secos', saldoCrudo: 2, saldoCocido: 0, unidad: 'kg', minimo: 1},
        ];
        let movimientos = [];
        let usuarioActual = 'Bodega';
        let filtroActual = 'todos';
        let proximoId = 5;

        function inicializar() {
            cargarDatos();
            actualizarSelectos();
            actualizarFiltros();
            actualizarListaSaldos();
            actualizarListaEntradas();
            actualizarListaSalidas();
            actualizarReportes();
            actualizarAdmin();
            document.getElementById('buscar-saldos').addEventListener('input', buscarSaldos);
            document.getElementById('usuario-actual').textContent = usuarioActual;
            actualizarContador();
        }

        function cargarDatos() {
            const datos = localStorage.getItem('inventario_el_rincon_v8');
            if (datos) {
                const d = JSON.parse(datos);
                responsables = d.responsables || responsables;
                proveedores = d.proveedores || proveedores;
                categorias = d.categorias || categorias;
                saldos = d.saldos || saldos;
                movimientos = d.movimientos || [];
                usuarioActual = d.usuarioActual || 'Bodega';
                proximoId = d.proximoId || 5;
            }
        }

        function guardarDatos() {
            localStorage.setItem('inventario_el_rincon_v8', JSON.stringify({responsables, proveedores, categorias, saldos, movimientos, usuarioActual, proximoId}));
        }

        function actualizarSelectos() {
            const resp = responsables.map(r => `<option value="${r}">${r}</option>`).join('');
            const prov = proveedores.map(p => `<option value="${p}">${p}</option>`).join('');
            const prod = saldos.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            const cat = categorias.map(c => `<option value="${c}">${c}</option>`).join('');

            document.getElementById('responsable-entrada').innerHTML = `<option value="">-- Selecciona --</option>${resp}`;
            document.getElementById('responsable-salida').innerHTML = `<option value="">-- Selecciona --</option>${resp}`;
            document.getElementById('proveedor-entrada').innerHTML = `<option value="">-- Selecciona --</option>${prov}`;
            document.getElementById('producto-entrada').innerHTML = `<option value="">-- Selecciona --</option>${prod}`;
            document.getElementById('producto-salida').innerHTML = `<option value="">-- Selecciona --</option>${prod}`;
            document.getElementById('nuevo-producto-categoria').innerHTML = cat;
        }

        function actualizarFiltros() {
            const fb = document.getElementById('filter-buttons');
            fb.innerHTML = '<button class="filter-btn active" onclick="filtrarSaldos(\'todos\')">Todos</button>';
            const cats = [...new Set(saldos.map(p => p.categoria))].sort();
            cats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                btn.textContent = cat;
                btn.onclick = () => filtrarSaldos(cat);
                fb.appendChild(btn);
            });
        }

        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'reportes') actualizarReportes();
            if (tab === 'admin') actualizarAdmin();
        }

        function cambiarUsuario() {
            const opciones = responsables.map((r, i) => `${i + 1}. ${r}`).join('\n');
            const seleccion = prompt(`Selecciona responsable:\n${opciones}`);
            const idx = parseInt(seleccion) - 1;
            if (idx >= 0 && idx < responsables.length) {
                usuarioActual = responsables[idx];
                document.getElementById('usuario-actual').textContent = usuarioActual;
                guardarDatos();
            }
        }

        function filtrarSaldos(categoria) {
            filtroActual = categoria;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            actualizarListaSaldos();
        }

        function buscarSaldos(e) {
            const termino = e.target.value.toLowerCase();
            const productos = obtenerProductosParaMostrar();
            const resultados = productos.filter(p => p.nombre.toLowerCase().includes(termino));
            mostrarProductos(resultados);
        }

        function obtenerProductosParaMostrar() {
            if (filtroActual === 'todos') return saldos;
            return saldos.filter(p => p.categoria === filtroActual);
        }

        function actualizarListaSaldos() {
            mostrarProductos(obtenerProductosParaMostrar());
        }

        function mostrarProductos(productos) {
            const lista = document.getElementById('lista-saldos');
            if (productos.length === 0) {
                lista.innerHTML = '<p style="color: #999; text-align: center;">Sin productos</p>';
                return;
            }
            lista.innerHTML = productos.map(p => {
                const total = p.saldoCrudo + p.saldoCocido;
                const alerta = total < p.minimo ? ' style="background: #FFEBEE;"' : '';
                return `<div class="producto-card"${alerta}>
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <div class="producto-nombre">${p.nombre}</div>
                            <div class="producto-categoria">${p.categoria}</div>
                            ${p.categoria.includes('Prote√≠na') ? 
                                `<div style="font-size: 10px; color: #666; margin-top: 4px;">üîµ ${p.saldoCrudo.toFixed(2)} | üî¥ ${p.saldoCocido.toFixed(2)} kg</div>` : 
                                `<div style="font-size: 10px; color: #666; margin-top: 4px;">Total: ${total.toFixed(2)} ${p.unidad}</div>`
                            }
                        </div>
                        <div class="producto-saldo">${total.toFixed(2)}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function actualizarEstadoEntrada() {
            const pid = document.getElementById('producto-entrada').value;
            const p = saldos.find(s => s.id === parseInt(pid));
            document.getElementById('estado-entrada-grupo').style.display = p?.categoria.includes('Prote√≠na') ? 'block' : 'none';
        }

        function seleccionarEstadoEntrada(estado) {
            document.getElementById('estado-entrada').value = estado;
            document.querySelectorAll('#estado-entrada-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarEntrada() {
            const resp = document.getElementById('responsable-entrada').value;
            const prov = document.getElementById('proveedor-entrada').value;
            const pid = document.getElementById('producto-entrada').value;
            const cant = parseFloat(document.getElementById('cantidad-entrada').value);
            const costo = parseFloat(document.getElementById('costo-entrada').value);

            if (!resp || !prov || !pid || isNaN(cant) || isNaN(costo)) {
                mostrarAlerta('‚ö†Ô∏è Completa todos los campos', 'error');
                return;
            }

            const p = saldos.find(s => s.id === parseInt(pid));
            const estado = p?.categoria.includes('Prote√≠na') ? document.getElementById('estado-entrada').value : '';
            
            if (estado === 'crudo') p.saldoCrudo += cant;
            else if (estado === 'cocido') p.saldoCocido += cant;
            else p.saldoCrudo += cant;

            movimientos.push({
                fecha: new Date().toISOString().split('T')[0],
                hora: new Date().toTimeString().slice(0, 5),
                tipo: 'entrada',
                cantidadCrudo: estado === 'crudo' ? cant : 0,
                cantidadCocido: estado === 'cocido' ? cant : 0,
                producto: p?.nombre,
                estado: estado,
                responsable: resp,
                costo: costo,
                proveedor: prov
            });

            guardarDatos();
            mostrarAlerta('‚úÖ Entrada registrada', 'success');
            limpiarFormEntrada();
            actualizarListaSaldos();
            actualizarListaEntradas();
            actualizarContador();
        }

        function actualizarListaEntradas() {
            const lista = document.getElementById('lista-entradas');
            const ultimas = movimientos.filter(m => m.tipo === 'entrada').slice(-10).reverse();
            if (ultimas.length === 0) { lista.innerHTML = '<p style="color: #999;">Sin entradas</p>'; return; }
            lista.innerHTML = ultimas.map(m => `<div class="lista-item"><strong>${m.producto}</strong><br>${m.cantidadCrudo > 0 ? m.cantidadCrudo.toFixed(2) + ' crudo | ' : ''}${m.cantidadCocido > 0 ? m.cantidadCocido.toFixed(2) + ' cocido | ' : ''}${m.proveedor} | $${m.costo}</div>`).join('');
        }

        function limpiarFormEntrada() {
            document.getElementById('responsable-entrada').value = '';
            document.getElementById('proveedor-entrada').value = '';
            document.getElementById('producto-entrada').value = '';
            document.getElementById('cantidad-entrada').value = '';
            document.getElementById('costo-entrada').value = '';
        }

        function actualizarEstadoSalida() {
            const pid = document.getElementById('producto-salida').value;
            const p = saldos.find(s => s.id === parseInt(pid));
            document.getElementById('estado-salida-grupo').style.display = p?.categoria.includes('Prote√≠na') ? 'block' : 'none';
        }

        function seleccionarEstadoSalida(estado) {
            document.getElementById('estado-salida').value = estado;
            document.querySelectorAll('#estado-salida-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarSalida() {
            const resp = document.getElementById('responsable-salida').value;
            const dest = document.getElementById('destino-salida').value;
            const pid = document.getElementById('producto-salida').value;
            const cant = parseFloat(document.getElementById('cantidad-salida').value);

            if (!resp || !dest || !pid || isNaN(cant)) {
                mostrarAlerta('‚ö†Ô∏è Completa todos los campos', 'error');
                return;
            }

            const p = saldos.find(s => s.id === parseInt(pid));
            const estado = p?.categoria.includes('Prote√≠na') ? document.getElementById('estado-salida').value : '';
            const disponible = estado === 'crudo' ? p.saldoCrudo : estado === 'cocido' ? p.saldoCocido : p.saldoCrudo + p.saldoCocido;

            if (cant > disponible) {
                mostrarAlerta(`‚ö†Ô∏è Stock insuficiente: ${disponible.toFixed(2)}`, 'error');
                return;
            }

            if (estado === 'crudo') p.saldoCrudo -= cant;
            else if (estado === 'cocido') p.saldoCocido -= cant;
            else p.saldoCrudo -= cant;

            movimientos.push({
                fecha: new Date().toISOString().split('T')[0],
                hora: new Date().toTimeString().slice(0, 5),
                tipo: 'salida',
                cantidadCrudo: estado === 'crudo' ? cant : 0,
                cantidadCocido: estado === 'cocido' ? cant : 0,
                producto: p?.nombre,
                estado: estado,
                responsable: resp,
                destinoOrigen: dest,
                costo: 0,
                proveedor: ''
            });

            guardarDatos();
            mostrarAlerta('‚úÖ Salida registrada', 'success');
            limpiarFormSalida();
            actualizarListaSaldos();
            actualizarListaSalidas();
            actualizarContador();
        }

        function actualizarListaSalidas() {
            const lista = document.getElementById('lista-salidas');
            const ultimas = movimientos.filter(m => m.tipo === 'salida').slice(-10).reverse();
            if (ultimas.length === 0) { lista.innerHTML = '<p style="color: #999;">Sin salidas</p>'; return; }
            const dest = {'cocina': 'üë®‚Äçüç≥', 'barril': 'üçñ', 'caja': 'üí∞', 'consumo': 'ü•ò', 'merma': 'üìâ', 'danio': 'üî•'};
            lista.innerHTML = ultimas.map(m => `<div class="lista-item"><strong>${m.producto}</strong><br>${dest[m.destinoOrigen] || ''} ${m.cantidadCrudo > 0 ? m.cantidadCrudo.toFixed(2) + ' crudo' : ''}${m.cantidadCocido > 0 ? ' / ' + m.cantidadCocido.toFixed(2) + ' cocido' : ''} | ${m.responsable}</div>`).join('');
        }

        function limpiarFormSalida() {
            document.getElementById('responsable-salida').value = '';
            document.getElementById('destino-salida').value = '';
            document.getElementById('producto-salida').value = '';
            document.getElementById('cantidad-salida').value = '';
        }

        function actualizarReportes() {
            const hoy = new Date().toISOString().split('T')[0];
            const lista = document.getElementById('lista-reportes');
            const hoyMov = movimientos.filter(m => m.fecha === hoy);
            if (hoyMov.length === 0) { lista.innerHTML = '<p style="color: #999;">Sin movimientos hoy</p>'; return; }
            const dest = {'cocina': 'üë®‚Äçüç≥', 'barril': 'üçñ', 'caja': 'üí∞', 'consumo': 'ü•ò', 'merma': 'üìâ', 'danio': 'üî•'};
            lista.innerHTML = hoyMov.map(m => {
                const icono = m.tipo === 'entrada' ? 'üì•' : 'üì§';
                return `<div class="lista-item"><strong>${icono} ${m.hora} - ${m.producto}</strong><br>${m.cantidadCrudo > 0 ? m.cantidadCrudo.toFixed(2) + ' crudo' : ''}${m.cantidadCocido > 0 ? ' / ' + m.cantidadCocido.toFixed(2) + ' cocido' : ''} | ${m.responsable}${m.tipo === 'entrada' ? ` | $${m.costo}` : ''}</div>`;
            }).join('');
        }

        function actualizarContador() {
            const hoy = new Date().toISOString().split('T')[0];
            const cont = movimientos.filter(m => m.fecha === hoy).length;
            document.getElementById('contador').textContent = cont;
        }

        function mostrarAlerta(msg, tipo) {
            const div = document.getElementById('alerta');
            div.innerHTML = `<div class="alerta ${tipo}">${msg}</div>`;
            setTimeout(() => { div.innerHTML = ''; }, 3000);
        }

        function agregarResponsable() {
            const nombre = document.getElementById('nuevo-responsable').value.trim();
            if (!nombre) { mostrarAlerta('‚ö†Ô∏è Nombre requerido', 'error'); return; }
            if (responsables.includes(nombre)) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }
            responsables.push(nombre);
            guardarDatos();
            actualizarSelectos();
            actualizarAdmin();
            document.getElementById('nuevo-responsable').value = '';
            mostrarAlerta('‚úÖ Responsable agregado', 'success');
        }

        function agregarProveedor() {
            const nombre = document.getElementById('nuevo-proveedor').value.trim();
            if (!nombre) { mostrarAlerta('‚ö†Ô∏è Nombre requerido', 'error'); return; }
            if (proveedores.includes(nombre)) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }
            proveedores.push(nombre);
            guardarDatos();
            actualizarSelectos();
            actualizarAdmin();
            document.getElementById('nuevo-proveedor').value = '';
            mostrarAlerta('‚úÖ Proveedor agregado', 'success');
        }

        function agregarCategoria() {
            const nombre = document.getElementById('nueva-categoria').value.trim();
            if (!nombre) { mostrarAlerta('‚ö†Ô∏è Nombre requerido', 'error'); return; }
            if (categorias.includes(nombre)) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }
            categorias.push(nombre);
            guardarDatos();
            actualizarSelectos();
            actualizarFiltros();
            actualizarAdmin();
            document.getElementById('nueva-categoria').value = '';
            mostrarAlerta('‚úÖ Categor√≠a agregada', 'success');
        }

        function agregarProducto() {
            const nombre = document.getElementById('nuevo-producto-nombre').value.trim();
            const cat = document.getElementById('nuevo-producto-categoria').value;
            const min = parseFloat(document.getElementById('nuevo-producto-minimo').value) || 0;

            if (!nombre || !cat) { mostrarAlerta('‚ö†Ô∏è Completa los campos', 'error'); return; }
            if (saldos.find(p => p.nombre === nombre)) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }

            saldos.push({id: proximoId++, nombre, categoria: cat, saldoCrudo: 0, saldoCocido: 0, unidad: 'kg', minimo: min});
            guardarDatos();
            actualizarSelectos();
            actualizarFiltros();
            actualizarAdmin();
            document.getElementById('nuevo-producto-nombre').value = '';
            document.getElementById('nuevo-producto-minimo').value = '';
            mostrarAlerta('‚úÖ Producto agregado', 'success');
        }

        function eliminarResponsable(r) { responsables = responsables.filter(x => x !== r); guardarDatos(); actualizarSelectos(); actualizarAdmin(); mostrarAlerta('‚úÖ Eliminado', 'success'); }
        function eliminarProveedor(p) { proveedores = proveedores.filter(x => x !== p); guardarDatos(); actualizarSelectos(); actualizarAdmin(); mostrarAlerta('‚úÖ Eliminado', 'success'); }
        function eliminarCategoria(c) { categorias = categorias.filter(x => x !== c); saldos = saldos.filter(p => p.categoria !== c); guardarDatos(); actualizarSelectos(); actualizarFiltros(); actualizarAdmin(); mostrarAlerta('‚úÖ Eliminado', 'success'); }
        function eliminarProducto(id) { saldos = saldos.filter(p => p.id !== id); guardarDatos(); actualizarSelectos(); actualizarAdmin(); mostrarAlerta('‚úÖ Eliminado', 'success'); }

        function actualizarAdmin() {
            document.getElementById('lista-responsables').innerHTML = responsables.map(r => `<div class="admin-item">${r} <button class="btn-delete" onclick="eliminarResponsable('${r}')">‚ùå</button></div>`).join('');
            document.getElementById('lista-proveedores').innerHTML = proveedores.map(p => `<div class="admin-item">${p} <button class="btn-delete" onclick="eliminarProveedor('${p}')">‚ùå</button></div>`).join('');
            document.getElementById('lista-categorias').innerHTML = categorias.map(c => `<div class="admin-item">${c} <button class="btn-delete" onclick="eliminarCategoria('${c}')">‚ùå</button></div>`).join('');
            document.getElementById('lista-productos').innerHTML = saldos.map(p => `<div class="admin-item">${p.nombre} (${(p.saldoCrudo + p.saldoCocido).toFixed(2)}) <button class="btn-delete" onclick="eliminarProducto(${p.id})">‚ùå</button></div>`).join('');
        }

        async function sincronizarGoogleSheets() {
            mostrarAlerta('‚è≥ Sincronizando con Google Sheets...', 'loading');
            
            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdHh4WaksLtEA0jg0x9T_GNlKp7JlAwbd5-uZ6SjUT8DAJKtaOuD9RVV-CsUzujkuV-w/exec';
                
                // PASO 1: Enviar datos
                console.log('üì§ Enviando datos a Google Sheets...');
                const responseSend = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sincronizarCompleto',
                        productos: saldos,
                        movimientos: movimientos
                    })
                });

                const resultadoSend = await responseSend.json();
                
                if (!resultadoSend.success) {
                    throw new Error(resultadoSend.error);
                }
                
                console.log('‚úÖ Datos enviados');
                
                // PASO 2: Recargar datos desde Google Sheets
                console.log('üì• Recargando datos desde Google Sheets...');
                await cargarDatosDeGoogleSheets();
                
                mostrarAlerta(`‚úÖ ¬°Sincronizado!\nüìä ${resultadoSend.movimientosSync} movimientos\nüì¶ ${resultadoSend.productosSync} productos\n‚ú® Datos actualizados para todos`, 'success');
                
                actualizarListaSaldos();
                actualizarListaEntradas();
                actualizarListaSalidas();
                actualizarReportes();
                actualizarContador();
                
            } catch(error) {
                mostrarAlerta('‚ùå Error: ' + error.message, 'error');
                console.error('‚ùå Error:', error);
            }
        }

        async function cargarDatosDeGoogleSheets() {
            try {
                const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwdHh4WaksLtEA0jg0x9T_GNlKp7JlAwbd5-uZ6SjUT8DAJKtaOuD9RVV-CsUzujkuV-w/exec';
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({action: 'getDatos'})
                });

                const resultado = await response.json();
                
                if (resultado.success) {
                    saldos = resultado.productos;
                    movimientos = resultado.movimientos;
                    guardarDatos();
                    console.log('‚úÖ Datos recargados desde Google Sheets');
                    return true;
                } else {
                    throw new Error(resultado.error);
                }
            } catch(error) {
                console.error('‚ö†Ô∏è No se pudo recargar desde Google Sheets:', error);
                return false;
            }
        }

        window.addEventListener('load', inicializar);
</body>
</html>
