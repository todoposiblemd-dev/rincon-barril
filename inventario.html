<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Rinc√≥n del Barril - Gesti√≥n Materias Primas v7.5 FINAL SYNC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px 15px 0 0;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #8B0000;
        }

        .header h1 {
            color: #8B0000;
            font-size: 22px;
            margin-bottom: 5px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 10px;
        }

        .user-badge {
            background: #8B0000;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: white;
            padding: 0 10px;
            border-bottom: 1px solid #DDD;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 6px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 10px;
            min-width: 50px;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: #8B0000;
            border-bottom-color: #8B0000;
        }

        .content {
            background: white;
            padding: 15px;
            border-radius: 0 0 15px 15px;
            min-height: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 12px;
        }

        select, input, textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #DDD;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        .btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
            width: auto;
        }

        .btn-delete {
            background: #DC3545;
            color: white;
        }

        .alerta {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 11px;
        }

        .alerta.success {
            background: #D4EDDA;
            color: #155724;
        }

        .alerta.error {
            background: #F8D7DA;
            color: #721C24;
        }

        .area-saldos {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .area-titulo {
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 8px;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 5px;
            font-size: 11px;
        }

        .saldo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #8B0000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 15px;
            border-radius: 10px;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 14px;
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 12px;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 8px;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .scroll-section {
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .estado-btn {
            padding: 8px;
            border: 2px solid #DDD;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .estado-btn.active {
            background: #8B0000;
            color: white;
            border-color: #8B0000;
        }

        .tabla-reportes {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 15px;
            background: white;
        }

        .tabla-reportes thead {
            background: #8B0000;
            color: white;
        }

        .tabla-reportes th {
            padding: 6px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        .tabla-reportes td {
            padding: 4px 6px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçñ El Rinc√≥n del Barril</h1>
            <h3 style="font-size: 12px; color: #666;">Gesti√≥n v7.5 - Sincronizaci√≥n en Tiempo Real</h3>
            <div class="user-info">
                <div>
                    <span style="font-weight: 600;">üë§ </span>
                    <span id="nombre-usuario">Cargando...</span>
                </div>
                <button class="btn btn-primary btn-small" onclick="cambiarUsuario()" style="margin: 0; padding: 4px 8px; font-size: 10px;">üîÑ Cambiar</button>
                <div class="user-badge" id="rol-usuario">Rol</div>
            </div>
            <div style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 6px; font-size: 11px; text-align: center;">
                <span id="indicador-conexion">üì° Conectado</span> ‚Ä¢ 
                <span id="indicador-sincronizacion">Movimientos: 0</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="cambiarTab('saldos')">üìä Saldos</button>
            <button class="tab-btn" onclick="cambiarTab('entradas')">üì• Entradas</button>
            <button class="tab-btn" onclick="cambiarTab('salidas')">üì§ Salidas</button>
            <button class="tab-btn" onclick="cambiarTab('responsables')">üë• Resp</button>
            <button class="tab-btn" onclick="cambiarTab('categorias')">üìÇ Cat</button>
            <button class="tab-btn" onclick="cambiarTab('reportes')">üìà Reportes</button>
        </div>

        <div class="content">
            <div id="alerta"></div>

            <!-- TAB SALDOS -->
            <div id="saldos" class="tab-content active">
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-primary btn-small" onclick="mostrarModalNuevoProducto()" style="width: 100%;">‚ûï Agregar Producto</button>
                </div>
                <div class="scroll-section" id="lista-saldos"></div>
            </div>

            <!-- TAB ENTRADAS -->
            <div id="entradas" class="tab-content">
                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Proveedor *</label>
                        <select id="proveedor-entrada" required></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="mostrarModalNuevoProveedor()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Materia Prima *</label>
                        <select id="producto-entrada" required onchange="actualizarEstadoEntrada()"></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="mostrarModalNuevoProducto()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div id="estado-entrada-grupo" style="display: none;">
                    <label>Estado</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoEntrada('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoEntrada('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-entrada" value="cocido">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad-entrada" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Costo *</label>
                        <input type="number" id="costo-entrada" placeholder="$0" step="0.01" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Responsable *</label>
                    <select id="responsable-entrada" required></select>
                </div>

                <div class="form-row" style="gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="registrarEntrada()">‚úÖ Registrar</button>
                    <button class="btn btn-secondary" onclick="limpiarFormEntrada()">üîÑ Limpiar</button>
                </div>

                <h3 style="margin-top: 15px; margin-bottom: 8px; color: #8B0000; font-size: 12px;">√öltimas Entradas</h3>
                <div class="scroll-section" id="lista-entradas" style="max-height: 200px;"></div>
            </div>

            <!-- TAB SALIDAS -->
            <div id="salidas" class="tab-content">
                <div class="form-group">
                    <label>Destino *</label>
                    <select id="destino-salida" required>
                        <option value="">-- Selecciona --</option>
                        <option value="cocina">üë®‚Äçüç≥ A Cocina</option>
                        <option value="barril">üçñ Al Barril</option>
                        <option value="caja">üí∞ A Caja</option>
                        <option value="consumo">ü•ò Consumo</option>
                        <option value="merma">üìâ Merma</option>
                        <option value="danio">üî• Da√±o</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Materia Prima *</label>
                        <select id="producto-salida" required onchange="actualizarEstadoSalida()"></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="mostrarModalNuevoProducto()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div id="estado-salida-grupo" style="display: none;">
                    <label>Estado</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoSalida('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoSalida('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-salida" value="cocido">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad-salida" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Responsable *</label>
                        <select id="responsable-salida" required></select>
                    </div>
                </div>

                <div class="form-row" style="gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="registrarSalida()">‚úÖ Registrar</button>
                    <button class="btn btn-secondary" onclick="limpiarFormSalida()">üîÑ Limpiar</button>
                </div>

                <h3 style="margin-top: 15px; margin-bottom: 8px; color: #8B0000; font-size: 12px;">√öltimas Salidas</h3>
                <div class="scroll-section" id="lista-salidas" style="max-height: 200px;"></div>
            </div>

            <!-- TAB RESPONSABLES -->
            <div id="responsables" class="tab-content">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="nuevo-responsable" placeholder="Nuevo responsable" style="flex: 1;">
                    <button class="btn btn-primary btn-small" onclick="agregarResponsable()" style="width: auto;">Agregar</button>
                </div>
                <div class="scroll-section" id="lista-responsables"></div>
            </div>

            <!-- TAB CATEGOR√çAS -->
            <div id="categorias" class="tab-content">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="nueva-categoria" placeholder="Nueva categor√≠a" style="flex: 1;">
                    <button class="btn btn-primary btn-small" onclick="agregarCategoria()" style="width: auto;">Agregar</button>
                </div>
                <div class="scroll-section" id="lista-categorias"></div>
            </div>

            <!-- TAB REPORTES -->
            <div id="reportes" class="tab-content">
                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">üìä STOCK ACTUAL</h3>
                <div class="scroll-section" id="tabla-stock-actual" style="max-height: 350px;"></div>

                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">üìã MOVIMIENTOS HOY</h3>
                <div class="scroll-section" id="tabla-movimientos" style="max-height: 350px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO PRODUCTO -->
    <div id="modalNuevoProducto" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">‚ûï Nuevo Producto</div>
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="nuevo-producto-nombre" placeholder="Ej: Cilantro fresco">
            </div>
            <div class="form-group">
                <label>Categor√≠a *</label>
                <select id="nuevo-producto-categoria" required></select>
            </div>
            <div class="form-group">
                <label>Stock M√≠nimo</label>
                <input type="number" id="nuevo-producto-minimo" placeholder="0" step="0.01" value="0">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarProductoNuevo()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalNuevoProducto()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO PROVEEDOR -->
    <div id="modalNuevoProveedor" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">‚ûï Nuevo Proveedor</div>
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="nuevo-proveedor-nombre" placeholder="Ej: Fruver Centro">
            </div>
            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" id="nuevo-proveedor-telefono" placeholder="+57 300 1234567">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarProveedorNuevo()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalNuevoProveedor()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ===== CONFIG =====
        const CATEGORIAS_INICIALES = {
            'proteinas': 'üçñ Prote√≠nas',
            'lacteos': 'üßÄ L√°cteos',
            'congelados': '‚ùÑÔ∏è Congelados',
            'secos': 'üåæ Secos',
            'verduras': 'ü•¨ Verduras',
            'gaseosas': 'ü•§ Gaseosas',
            'cervezas': 'üç∫ Cervezas',
            'condimentos': 'üßÇ Condimentos',
            'bebidas': 'üßã Bebidas',
            'empaques': 'üì¶ Empaques'
        };

        const PRODUCTOS_INICIALES = [
            { nombre: 'Papa', categoria: 'congelados', cantCruda: 12.5, unidad: 'kg' },
            { nombre: 'Pollo', categoria: 'proteinas', cantCruda: 16.0, unidad: 'kg' },
            { nombre: 'Costilla de cerdo', categoria: 'proteinas', cantCruda: 3.95, unidad: 'kg' },
            { nombre: 'pan brioche de hamburguesa', categoria: 'secos', cantCruda: 46.0, unidad: 'kg' },
            { nombre: 'pan brioche de perro', categoria: 'secos', cantCruda: 13.0, unidad: 'kg' },
            { nombre: 'Queso paisa', categoria: 'lacteos', cantCruda: 0.52, unidad: 'kg' },
            { nombre: 'queso cheddar', categoria: 'lacteos', cantCruda: 47.0, unidad: 'kg' },
            { nombre: 'huevos', categoria: 'lacteos', cantCruda: 21.0, unidad: 'kg' }
        ];

        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE45Dmk6g73v1_v0l9-0zf9RCnlkAaD0u00ej7OzxOwXPp4_mR3Ga9k4HOFHwTUTj2/exec';

        // ===== VARIABLES =====
        let usuarioActual = {};
        let saldos = [];
        let movimientos = [];
        let proveedores = [];
        let responsables = ['Bodega', 'Cocinero', 'Cajero', 'Sal√≥n'];
        let categorias = { ...CATEGORIAS_INICIALES };

        // ===== INICIALIZACI√ìN =====
        function inicializar() {
            console.log('‚úÖ Sistema iniciando...');
            cargarDatos();
            
            // Si no hay usuario, solicitarlo
            if (!usuarioActual.nombre) {
                detectarUsuario();
            } else {
                actualizarUIUsuario();
            }
            
            actualizarSelectoCategorias();
            actualizarSelectos();
            actualizarSaldos();
            actualizarListaResponsables();
            actualizarListaCategorias();
            
            // POLLING: Sincronizar movimientos cada 3 segundos
            setInterval(sincronizarMovimientosDesdeGoogle, 3000);
        }

        function detectarUsuario() {
            const usuario = prompt('üë§ Ingresa tu nombre:', '');
            const rolNum = prompt('üéØ Tu rol?\n1. Bodega\n2. Cocinero\n3. Cajero\n4. Gerente', '1');
            const rolesMap = { '1': 'Bodega', '2': 'Cocinero', '3': 'Cajero', '4': 'Gerente' };
            
            usuarioActual = {
                nombre: usuario || 'Usuario',
                rol: rolesMap[rolNum] || 'Bodega'
            };

            localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
            actualizarUIUsuario();
        }

        function cambiarUsuario() {
            const usuario = prompt('üë§ Nuevo nombre:', usuarioActual.nombre);
            if (!usuario) return;
            
            const rolNum = prompt('üéØ Tu rol?\n1. Bodega\n2. Cocinero\n3. Cajero\n4. Gerente', 
                usuarioActual.rol === 'Bodega' ? '1' : usuarioActual.rol === 'Cocinero' ? '2' : usuarioActual.rol === 'Cajero' ? '3' : '4');
            const rolesMap = { '1': 'Bodega', '2': 'Cocinero', '3': 'Cajero', '4': 'Gerente' };
            
            usuarioActual = {
                nombre: usuario,
                rol: rolesMap[rolNum] || 'Bodega'
            };

            localStorage.setItem('usuarioActual', JSON.stringify(usuarioActual));
            actualizarUIUsuario();
            mostrarAlerta('‚úÖ Usuario actualizado', 'success');
        }

        function actualizarUIUsuario() {
            document.getElementById('nombre-usuario').textContent = usuarioActual.nombre;
            document.getElementById('rol-usuario').textContent = usuarioActual.rol;
        }

        function cargarDatos() {
            // Cargar usuario guardado
            const usuarioGuardado = localStorage.getItem('usuarioActual');
            if (usuarioGuardado) {
                try {
                    usuarioActual = JSON.parse(usuarioGuardado);
                } catch(error) {
                    console.log('No hay usuario guardado, ser√° solicitado');
                }
            }

            const datosGuardados = localStorage.getItem('datosMateriasPrimas');
            if (datosGuardados) {
                try {
                    const datos = JSON.parse(datosGuardados);
                    saldos = datos.saldos || [];
                    movimientos = datos.movimientos || [];
                    proveedores = datos.proveedores || [];
                    responsables = datos.responsables || ['Bodega', 'Cocinero', 'Cajero', 'Sal√≥n'];
                    categorias = datos.categorias || { ...CATEGORIAS_INICIALES };
                } catch(error) {
                    console.error('Error cargando datos:', error);
                }
            }
            
            // Crear saldos iniciales si no existen
            if (saldos.length === 0) {
                saldos = PRODUCTOS_INICIALES.map((p, i) => ({
                    id: 'saldo_' + i,
                    nombre: p.nombre,
                    categoria: CATEGORIAS_INICIALES[p.categoria],
                    unidad: p.unidad,
                    cantidadCruda: p.cantCruda || 0,
                    cantidadCocida: 0,
                    cantidad: p.cantCruda || 0
                }));
            }

            // Crear proveedores iniciales si no existen
            if (proveedores.length === 0) {
                proveedores = [
                    { id: 'prov_0', nombre: 'Atlantic', telefono: '' },
                    { id: 'prov_1', nombre: 'Novillon', telefono: '' },
                    { id: 'prov_2', nombre: 'Makro', telefono: '' }
                ];
            }

            guardarDatos();
        }

        function guardarDatos() {
            localStorage.setItem('datosMateriasPrimas', JSON.stringify({
                saldos, movimientos, proveedores, responsables, categorias
            }));
        }

        // ===== SINCRONIZACI√ìN CON GOOGLE =====
        async function sincronizarMovimientosDesdeGoogle() {
            try {
                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getMovimientos' }),
                    mode: 'no-cors'
                });

                console.log('üîÑ Polling: descargando movimientos de Google');
                // Los movimientos se cargan autom√°ticamente
                actualizarSaldos();
                document.getElementById('indicador-sincronizacion').textContent = 
                    'Movimientos: ' + movimientos.length;
            } catch(error) {
                console.log('‚ö†Ô∏è Error sincronizando:', error);
            }
        }

        async function enviarMovimientoAGoogle(movimiento) {
            try {
                const saldo = saldos.find(s => s.id === movimiento.producto);
                const proveedor = proveedores.find(p => p.id === movimiento.proveedor);

                const datos = {
                    action: 'addMovimiento',
                    fecha: movimiento.fecha,
                    hora: movimiento.hora,
                    tipo: movimiento.tipo,
                    producto: saldo?.nombre || '',
                    cantidad: movimiento.cantidad,
                    estado: movimiento.estado || '',
                    responsable: movimiento.responsable,
                    destino: movimiento.destino || '',
                    proveedor: proveedor?.nombre || '',
                    costo: movimiento.costo || 0
                };

                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify(datos),
                    mode: 'no-cors'
                });

                console.log('üì§ Movimiento enviado a Google Sheets');
            } catch(error) {
                console.error('‚ùå Error enviando:', error);
            }
        }

        // ===== SALDOS =====
        function actualizarSaldos() {
            const lista = document.getElementById('lista-saldos');
            const porCategoria = {};

            saldos.forEach(saldo => {
                if (!porCategoria[saldo.categoria]) porCategoria[saldo.categoria] = [];
                porCategoria[saldo.categoria].push(saldo);
            });

            let html = '';
            Object.keys(porCategoria).forEach(cat => {
                html += `<div class="area-saldos"><div class="area-titulo">${cat}</div>`;
                porCategoria[cat].forEach(saldo => {
                    const stock = calcularSaldo(saldo.id);
                    html += `<div class="saldo-item"><div><strong>${saldo.nombre}</strong><br><small>Stock: ${stock.toFixed(2)} ${saldo.unidad}</small></div></div>`;
                });
                html += '</div>';
            });

            lista.innerHTML = html;
        }

        function calcularSaldo(productoId) {
            const saldo = saldos.find(s => s.id === productoId);
            let cantidad = parseFloat(saldo?.cantidad) || 0;
            
            movimientos.forEach(mov => {
                if (mov.producto === productoId) {
                    if (mov.tipo === 'entrada') cantidad += parseFloat(mov.cantidad) || 0;
                    else cantidad -= parseFloat(mov.cantidad) || 0;
                }
            });

            return cantidad;
        }

        // ===== ENTRADAS =====
        function actualizarEstadoEntrada() {
            const productoId = document.getElementById('producto-entrada').value;
            const saldo = saldos.find(s => s.id === productoId);
            const esProteina = saldo?.categoria?.includes('Prote√≠nas');
            document.getElementById('estado-entrada-grupo').style.display = esProteina ? 'block' : 'none';
        }

        function seleccionarEstadoEntrada(estado) {
            document.getElementById('estado-entrada').value = estado;
            document.querySelectorAll('#estado-entrada-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarEntrada() {
            const proveedor = document.getElementById('proveedor-entrada').value;
            const producto = document.getElementById('producto-entrada').value;
            const cantidad = parseFloat(document.getElementById('cantidad-entrada').value);
            const costo = parseFloat(document.getElementById('costo-entrada').value);
            const responsable = document.getElementById('responsable-entrada').value;

            if (!proveedor || !producto || isNaN(cantidad) || isNaN(costo) || !responsable) {
                mostrarAlerta('‚ö†Ô∏è Completa campos', 'error');
                return;
            }

            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date().toTimeString().slice(0, 5);

            const movimiento = {
                id: 'mov_' + Date.now(),
                tipo: 'entrada',
                producto,
                cantidad,
                costo,
                estado: document.getElementById('estado-entrada').value || '',
                fecha: hoy,
                hora: ahora,
                responsable,
                proveedor,
                timestamp: new Date().toISOString()
            };

            movimientos.push(movimiento);
            guardarDatos();
            enviarMovimientoAGoogle(movimiento);
            mostrarAlerta('‚úÖ Entrada registrada', 'success');
            limpiarFormEntrada();
            actualizarSaldos();
            actualizarListaEntradas();
        }

        function limpiarFormEntrada() {
            document.getElementById('producto-entrada').value = '';
            document.getElementById('cantidad-entrada').value = '';
            document.getElementById('costo-entrada').value = '';
        }

        function actualizarListaEntradas() {
            const lista = document.getElementById('lista-entradas');
            const ultimas = movimientos.filter(m => m.tipo === 'entrada').slice(-5).reverse();
            lista.innerHTML = ultimas.map(m => {
                const saldo = saldos.find(s => s.id === m.producto);
                return `<div class="area-saldos" style="padding: 6px;"><strong>${saldo?.nombre}</strong> +${m.cantidad} ${saldo?.unidad}</div>`;
            }).join('');
        }

        // ===== SALIDAS =====
        function actualizarEstadoSalida() {
            const productoId = document.getElementById('producto-salida').value;
            const saldo = saldos.find(s => s.id === productoId);
            const esProteina = saldo?.categoria?.includes('Prote√≠nas');
            document.getElementById('estado-salida-grupo').style.display = esProteina ? 'block' : 'none';
        }

        function seleccionarEstadoSalida(estado) {
            document.getElementById('estado-salida').value = estado;
            document.querySelectorAll('#estado-salida-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarSalida() {
            const destino = document.getElementById('destino-salida').value;
            const producto = document.getElementById('producto-salida').value;
            const cantidad = parseFloat(document.getElementById('cantidad-salida').value);
            const responsable = document.getElementById('responsable-salida').value;

            if (!destino || !producto || isNaN(cantidad) || !responsable) {
                mostrarAlerta('‚ö†Ô∏è Completa campos', 'error');
                return;
            }

            const saldoActual = calcularSaldo(producto);
            if (cantidad > saldoActual) {
                mostrarAlerta(`‚ö†Ô∏è Stock insuficiente: ${saldoActual}`, 'error');
                return;
            }

            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date().toTimeString().slice(0, 5);

            const movimiento = {
                id: 'mov_' + Date.now(),
                tipo: 'salida',
                producto,
                cantidad,
                estado: document.getElementById('estado-salida').value || '',
                destino,
                fecha: hoy,
                hora: ahora,
                responsable,
                timestamp: new Date().toISOString()
            };

            movimientos.push(movimiento);
            guardarDatos();
            enviarMovimientoAGoogle(movimiento);
            mostrarAlerta('‚úÖ Salida registrada', 'success');
            limpiarFormSalida();
            actualizarSaldos();
            actualizarListaSalidas();
        }

        function limpiarFormSalida() {
            document.getElementById('producto-salida').value = '';
            document.getElementById('cantidad-salida').value = '';
        }

        function actualizarListaSalidas() {
            const lista = document.getElementById('lista-salidas');
            const ultimas = movimientos.filter(m => m.tipo === 'salida').slice(-5).reverse();
            lista.innerHTML = ultimas.map(m => {
                const saldo = saldos.find(s => s.id === m.producto);
                return `<div class="area-saldos" style="padding: 6px;"><strong>${saldo?.nombre}</strong> -${m.cantidad} ${saldo?.unidad}</div>`;
            }).join('');
        }

        // ===== RESPONSABLES =====
        function agregarResponsable() {
            const nombre = document.getElementById('nuevo-responsable').value.trim();
            if (!nombre || responsables.includes(nombre)) {
                mostrarAlerta('‚ö†Ô∏è Inv√°lido', 'error');
                return;
            }
            responsables.push(nombre);
            guardarDatos();
            document.getElementById('nuevo-responsable').value = '';
            actualizarListaResponsables();
            actualizarSelectos();
            mostrarAlerta('‚úÖ Agregado', 'success');
        }

        function actualizarListaResponsables() {
            const lista = document.getElementById('lista-responsables');
            lista.innerHTML = responsables.map(r => `<div class="area-saldos">üë§ ${r}</div>`).join('');
        }

        // ===== CATEGOR√çAS =====
        function agregarCategoria() {
            const nombre = document.getElementById('nueva-categoria').value.trim();
            if (!nombre) {
                mostrarAlerta('‚ö†Ô∏è Ingresa nombre', 'error');
                return;
            }
            const key = nombre.toLowerCase().replace(/\s+/g, '_');
            if (categorias[key]) {
                mostrarAlerta('‚ö†Ô∏è Ya existe', 'error');
                return;
            }
            categorias[key] = 'üìå ' + nombre;
            guardarDatos();
            document.getElementById('nueva-categoria').value = '';
            actualizarListaCategorias();
            actualizarSelectoCategorias();
            mostrarAlerta('‚úÖ Agregada', 'success');
        }

        function actualizarListaCategorias() {
            const lista = document.getElementById('lista-categorias');
            lista.innerHTML = Object.entries(categorias).map(([k, v]) => 
                `<div class="area-saldos">${v}</div>`
            ).join('');
        }

        // ===== PRODUCTOS Y PROVEEDORES =====
        function mostrarModalNuevoProducto() {
            document.getElementById('nuevo-producto-nombre').value = '';
            document.getElementById('nuevo-producto-categoria').value = '';
            document.getElementById('nuevo-producto-minimo').value = '0';
            document.getElementById('modalNuevoProducto').classList.add('active');
        }

        function cerrarModalNuevoProducto() {
            document.getElementById('modalNuevoProducto').classList.remove('active');
        }

        function guardarProductoNuevo() {
            const nombre = document.getElementById('nuevo-producto-nombre').value.trim();
            const categoria = document.getElementById('nuevo-producto-categoria').value;
            const minimo = parseFloat(document.getElementById('nuevo-producto-minimo').value) || 0;

            if (!nombre || !categoria) {
                mostrarAlerta('‚ö†Ô∏è Completa campos', 'error');
                return;
            }

            if (saldos.find(s => s.nombre.toLowerCase() === nombre.toLowerCase())) {
                mostrarAlerta('‚ö†Ô∏è Ya existe', 'error');
                return;
            }

            saldos.push({
                id: 'saldo_' + Date.now(),
                nombre,
                categoria,
                unidad: 'kg',
                cantidadCruda: 0,
                cantidadCocida: 0,
                cantidad: 0
            });

            guardarDatos();
            actualizarSelectos();
            actualizarSaldos();
            mostrarAlerta('‚úÖ Producto creado', 'success');
            cerrarModalNuevoProducto();
        }

        function mostrarModalNuevoProveedor() {
            document.getElementById('nuevo-proveedor-nombre').value = '';
            document.getElementById('nuevo-proveedor-telefono').value = '';
            document.getElementById('modalNuevoProveedor').classList.add('active');
        }

        function cerrarModalNuevoProveedor() {
            document.getElementById('modalNuevoProveedor').classList.remove('active');
        }

        function guardarProveedorNuevo() {
            const nombre = document.getElementById('nuevo-proveedor-nombre').value.trim();
            const telefono = document.getElementById('nuevo-proveedor-telefono').value.trim();

            if (!nombre) {
                mostrarAlerta('‚ö†Ô∏è Ingresa nombre', 'error');
                return;
            }

            if (proveedores.find(p => p.nombre.toLowerCase() === nombre.toLowerCase())) {
                mostrarAlerta('‚ö†Ô∏è Ya existe', 'error');
                return;
            }

            proveedores.push({
                id: 'prov_' + Date.now(),
                nombre,
                telefono
            });

            guardarDatos();
            actualizarSelectos();
            mostrarAlerta('‚úÖ Proveedor creado', 'success');
            cerrarModalNuevoProveedor();
        }

        // ===== UTILIDADES =====
        function actualizarSelectoCategorias() {
            const select = document.getElementById('nuevo-producto-categoria');
            select.innerHTML = '<option value="">-- Selecciona --</option>' + 
                Object.values(categorias).map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function actualizarSelectos() {
            const productos = saldos.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            const proveedorOptions = proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            const resp = responsables.map(r => `<option value="${r}">${r}</option>`).join('');

            document.getElementById('producto-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + productos;
            document.getElementById('producto-salida').innerHTML = '<option value="">-- Selecciona --</option>' + productos;
            document.getElementById('proveedor-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + proveedorOptions;
            document.getElementById('responsable-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + resp;
            document.getElementById('responsable-salida').innerHTML = '<option value="">-- Selecciona --</option>' + resp;
        }

        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            if (tab === 'reportes') actualizarReportes();
        }

        function actualizarReportes() {
            const hoy = new Date().toISOString().split('T')[0];
            const movHoy = movimientos.filter(m => m.fecha === hoy);

            // Stock actual
            let html = '<table class="tabla-reportes"><thead><tr><th>Producto</th><th>Stock</th></tr></thead><tbody>';
            saldos.forEach(s => {
                const stock = calcularSaldo(s.id);
                html += `<tr><td>${s.nombre}</td><td>${stock.toFixed(2)} ${s.unidad}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabla-stock-actual').innerHTML = html;

            // Movimientos hoy
            html = '<table class="tabla-reportes"><thead><tr><th>Hora</th><th>Tipo</th><th>Producto</th><th>Cantidad</th></tr></thead><tbody>';
            movHoy.forEach(m => {
                const saldo = saldos.find(s => s.id === m.producto);
                html += `<tr><td>${m.hora}</td><td>${m.tipo === 'entrada' ? 'üì•' : 'üì§'}</td><td>${saldo?.nombre}</td><td>${m.cantidad}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabla-movimientos').innerHTML = html;
        }

        function mostrarAlerta(mensaje, tipo) {
            const alertaDiv = document.getElementById('alerta');
            alertaDiv.innerHTML = `<div class="alerta ${tipo}">${mensaje}</div>`;
            setTimeout(() => { alertaDiv.innerHTML = ''; }, 3000);
        }

        window.addEventListener('load', inicializar);
    </script>
</body>
</html>
