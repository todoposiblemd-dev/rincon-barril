<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salidas - El Rinc√≥n del Barril</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            padding: 10px;
            font-size: 16px;
        }
        .header {
            background: #FF5722;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .stats { font-size: 14px; opacity: 0.9; }
        
        /* Botones grandes para celular */
        .btn-grande {
            background: #2196F3;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            min-height: 60px;
        }
        .btn-grande:active { background: #1976D2; }
        
        .btn-conteo {
            background: #FF9800;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            min-height: 60px;
        }
        .btn-conteo:active { background: #F57C00; }
        
        .btn-gestion {
            background: #9C27B0;
            color: white;
            border: none;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 15px;
            min-height: 60px;
        }
        .btn-gestion:active { background: #7B1FA2; }
        
        .menu-principal {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .menu-btn {
            background: white;
            border: 3px solid #FF5722;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            min-height: 100px;
        }
        .menu-btn:active { background: #ffebee; }
        .menu-icon { font-size: 40px; margin-bottom: 8px; }
        .menu-nombre { font-size: 18px; font-weight: bold; color: #333; }
        .menu-desc { font-size: 12px; color: #666; margin-top: 5px; }
        
        .paso {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .paso h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 20px;
        }
        
        /* Tipos de movimiento */
        .tipos {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .tipo-btn {
            background: #f9f9f9;
            border: 3px solid #ddd;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            min-height: 120px;
        }
        .tipo-btn.selected {
            background: #ffebee;
            border-color: #FF5722;
        }
        .tipo-icon { font-size: 40px; margin-bottom: 8px; }
        .tipo-nombre { font-size: 16px; font-weight: bold; }
        .tipo-desc { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* Formularios */
        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            min-height: 50px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        /* Botones de acci√≥n */
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            min-height: 60px;
        }
        .btn-registrar {
            background: #4CAF50;
            color: white;
        }
        .btn-registrar:active { background: #388E3C; }
        .btn-cancelar {
            background: #f44336;
            color: white;
        }
        .btn-cancelar:active { background: #D32F2F; }
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        .btn-secondary:active { background: #1976D2; }
        
        .oculto { display: none !important; }
        
        /* Mensajes */
        .mensaje {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            min-width: 280px;
        }
        .mensaje.exito { border: 4px solid #4CAF50; }
        .mensaje.error { border: 4px solid #f44336; }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.activo { display: block; }
        
        /* Producciones/Transformaciones */
        .lista-items {
            max-height: 400px;
            overflow-y: auto;
        }
        .item-producto {
            background: #f9f9f9;
            border: 2px solid #ddd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-nombre {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }
        .item-acciones {
            display: flex;
            gap: 5px;
        }
        .btn-item {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-width: 70px;
        }
        .btn-item-editar {
            background: #2196F3;
            color: white;
        }
        .btn-item-eliminar {
            background: #f44336;
            color: white;
        }
        
        /* Modal Conteo F√≠sico */
        .modal-conteo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }
        .modal-conteo.activo { display: block; }
        
        .modal-conteo-contenido {
            background: white;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 15px;
            padding: 20px;
        }
        
        .modal-conteo-header {
            background: #FF9800;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-conteo-header h2 {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        /* Toggle modo conteo */
        .toggle-modo {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .toggle-btn {
            flex: 1;
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            min-height: 60px;
        }
        .toggle-btn.activo {
            background: #FF9800;
            color: white;
            border-color: #F57C00;
        }
        
        /* Conteo items */
        .conteo-item {
            background: #f9f9f9;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .conteo-producto-nombre {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .conteo-sistema {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        .conteo-input {
            font-size: 18px;
            padding: 18px;
            border: 3px solid #ddd;
            min-height: 60px;
        }
        .conteo-input:focus {
            border-color: #FF9800;
            outline: none;
        }
        .conteo-diferencia {
            background: #fff;
            padding: 12px;
            border-radius: 5px;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        .conteo-diferencia.positivo { 
            color: #4CAF50;
            background: #E8F5E9;
        }
        .conteo-diferencia.negativo { 
            color: #f44336;
            background: #FFEBEE;
        }
        .conteo-diferencia.neutro { 
            color: #666;
            background: #F5F5F5;
        }
        
        /* Info boxes */
        .info-box {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
        }
        .info-box-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #1976D2;
        }
        .info-box-content {
            font-size: 14px;
            color: #555;
        }
        
        .resultado {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="overlay" id="overlay"></div>
    
    <div class="header">
        <h1>üì§ SALIDAS</h1>
        <div class="stats">
            <span id="stats">0 movimientos registrados</span>
        </div>
    </div>
    
    <!-- MEN√ö PRINCIPAL -->
    <div id="menuPrincipal">
        <div class="menu-principal">
            <div class="menu-btn" onclick="mostrarRegistro()">
                <div class="menu-icon">‚ûï</div>
                <div class="menu-nombre">NUEVA SALIDA</div>
                <div class="menu-desc">Registrar movimiento</div>
            </div>
            <div class="menu-btn" onclick="verListado()">
                <div class="menu-icon">üìã</div>
                <div class="menu-nombre">VER LISTADO</div>
                <div class="menu-desc">Historial</div>
            </div>
        </div>
        
        <button class="btn-gestion" onclick="abrirGestionTransformables()">
            ‚öôÔ∏è GESTIONAR PRODUCTOS TRANSFORMABLES
        </button>
        
        <button class="btn-grande" onclick="exportarExcel()">
            üì§ EXPORTAR EXCEL
        </button>
        
        <button class="btn-conteo" onclick="abrirConteoFisico()">
            üìä CONTEO F√çSICO
        </button>
    </div>

    <!-- REGISTRO DE SALIDA -->
    <div id="secRegistro" class="oculto">
        <!-- PASO 1: TIPO -->
        <div id="paso1" class="paso">
            <h2>1Ô∏è‚É£ Tipo de movimiento</h2>
            <div class="tipos">
                <div class="tipo-btn" onclick="selTipo('servicio')">
                    <div class="tipo-icon">üíº</div>
                    <div class="tipo-nombre">SERVICIO</div>
                    <div class="tipo-desc">Servicio al cliente</div>
                </div>
                <div class="tipo-btn" onclick="selTipo('consumo')">
                    <div class="tipo-icon">üçΩÔ∏è</div>
                    <div class="tipo-nombre">CONSUMO</div>
                    <div class="tipo-desc">Consumo interno</div>
                </div>
                <div class="tipo-btn" onclick="selTipo('transformacion')">
                    <div class="tipo-icon">üë®‚Äçüç≥</div>
                    <div class="tipo-nombre">TRANSFORMACI√ìN</div>
                    <div class="tipo-desc">Producir/Transformar</div>
                </div>
                <div class="tipo-btn" onclick="selTipo('refrigeracion')">
                    <div class="tipo-icon">‚ùÑÔ∏è</div>
                    <div class="tipo-nombre">REFRIGERACI√ìN</div>
                    <div class="tipo-desc">Env√≠o a refrigerar</div>
                </div>
            </div>
        </div>

        <!-- PASO 2: DETALLES -->
        <div id="paso2" class="paso oculto">
            <button class="btn btn-cancelar" onclick="volverPaso1()" style="margin-bottom: 15px;">
                ‚¨ÖÔ∏è VOLVER
            </button>
            <h2 id="tituloPaso2">2Ô∏è‚É£ Detalles</h2>
            
            <!-- SERVICIO -->
            <div id="secServicio" class="oculto">
                <label>Producto (escribe o selecciona):</label>
                <input list="listaProductos" id="productoServicio" class="combo-input" placeholder="Escribe o selecciona...">
                <datalist id="listaProductos"></datalist>
                
                <label>Lote (si aplica):</label>
                <input type="text" id="loteServicio" placeholder="LOC-1812-001 o N/A" readonly style="background: #f0f0f0;">
                
                <label>Cantidad:</label>
                <input type="number" id="cantidadServicio" step="0.01" placeholder="Ej: 5">
                
                <label>Unidad:</label>
                <select id="unidadServicio">
                    <option>kg</option>
                    <option>unidad</option>
                    <option>litro</option>
                    <option>porci√≥n</option>
                </select>
                
                <label>Tipo de servicio:</label>
                <select id="tipoServicio">
                    <option>Consumo en local</option>
                    <option>Para llevar</option>
                    <option>Domicilio</option>
                </select>
                
                <label>Responsable:</label>
                <input list="listaResponsables" id="responsableServicio" class="combo-input" placeholder="Tu nombre">
                <datalist id="listaResponsables">
                    <option value="Mar√≠a">
                    <option value="Juan">
                    <option value="Pedro">
                    <option value="Ana">
                    <option value="Carlos">
                </datalist>
                
                <label>Observaciones (opcional):</label>
                <textarea id="observacionesServicio" rows="2" placeholder="Notas adicionales"></textarea>
            </div>
            
            <!-- CONSUMO INTERNO -->
            <div id="secConsumo" class="oculto">
                <label>Producto (escribe o selecciona):</label>
                <input list="listaProductos" id="productoConsumo" class="combo-input" placeholder="Escribe o selecciona...">
                
                <label>Lote (si aplica):</label>
                <input type="text" id="loteConsumo" placeholder="LOC-1812-001 o N/A" readonly style="background: #f0f0f0;">
                
                <label>Cantidad:</label>
                <input type="number" id="cantidadConsumo" step="0.01" placeholder="Ej: 2">
                
                <label>Unidad:</label>
                <select id="unidadConsumo">
                    <option>kg</option>
                    <option>unidad</option>
                    <option>litro</option>
                    <option>porci√≥n</option>
                </select>
                
                <label>Motivo:</label>
                <select id="motivoConsumo">
                    <option>Prueba de calidad</option>
                    <option>Alimentaci√≥n del personal</option>
                    <option>Degustaci√≥n cliente</option>
                    <option>Error en preparaci√≥n</option>
                    <option>Otro (especificar abajo)</option>
                </select>
                <input type="text" id="motivoConsumoOtro" placeholder="O escribe otro motivo...">
                
                <label>Responsable:</label>
                <input list="listaResponsables" id="responsableConsumo" class="combo-input" placeholder="Tu nombre">
                
                <label>Observaciones (opcional):</label>
                <textarea id="observacionesConsumo" rows="2" placeholder="Notas adicionales"></textarea>
            </div>
            
            <!-- TRANSFORMACI√ìN -->
            <div id="secTransformacion" class="oculto">
                <h3 style="margin-bottom: 15px;">Selecciona el proceso:</h3>
                
                <div id="listaTransformables"></div>
                
                <!-- Formulario de transformaci√≥n -->
                <div id="formTransformacion" class="oculto" style="margin-top: 20px;">
                    <div class="info-box">
                        <div class="info-box-title">üìã Proceso seleccionado</div>
                        <div class="info-box-content" id="procesoSeleccionado">-</div>
                    </div>
                    
                    <label>Producto origen:</label>
                    <input type="text" id="productoTransformacion" readonly style="background: #f0f0f0;">
                    
                    <label>Lote origen (trazabilidad):</label>
                    <input type="text" id="loteTransformacion" placeholder="LOC-1812-001" required>
                    
                    <label>Cantidad entrada (kg):</label>
                    <input type="number" id="cantidadEntrada" step="0.01" placeholder="10" onchange="calcularMerma()">
                    
                    <label>Cantidad salida (kg):</label>
                    <input type="number" id="cantidadSalida" step="0.01" placeholder="8.5" onchange="calcularMerma()">
                    
                    <div class="resultado oculto" id="resultadoMerma"></div>
                    
                    <label>Responsable:</label>
                    <input list="listaResponsables" id="responsableTransformacion" class="combo-input" placeholder="Tu nombre">
                    
                    <label>Observaciones (opcional):</label>
                    <textarea id="observacionesTransformacion" rows="2" placeholder="Notas del proceso"></textarea>
                </div>
            </div>
            
            <!-- REFRIGERACI√ìN -->
            <div id="secRefrigeracion" class="oculto">
                <label>Producto (escribe o selecciona):</label>
                <input list="listaProductos" id="productoRefrigeracion" class="combo-input" placeholder="Escribe o selecciona...">
                
                <label>Lote (si aplica):</label>
                <input type="text" id="loteRefrigeracion" placeholder="LOC-1812-001 o N/A" readonly style="background: #f0f0f0;">
                
                <label>Cantidad:</label>
                <input type="number" id="cantidadRefrigeracion" step="0.01" placeholder="Ej: 15">
                
                <label>Unidad:</label>
                <select id="unidadRefrigeracion">
                    <option>kg</option>
                    <option>unidad</option>
                    <option>litro</option>
                </select>
                
                <label>Ubicaci√≥n refrigeraci√≥n:</label>
                <select id="ubicacionRefrigeracion">
                    <option>Refrigerador 1</option>
                    <option>Refrigerador 2</option>
                    <option>Congelador 1</option>
                    <option>Congelador 2</option>
                    <option>Otra (especificar abajo)</option>
                </select>
                <input type="text" id="ubicacionRefrigeracionOtra" placeholder="O especifica ubicaci√≥n...">
                
                <label>Responsable:</label>
                <input list="listaResponsables" id="responsableRefrigeracion" class="combo-input" placeholder="Tu nombre">
                
                <label>Observaciones (opcional):</label>
                <textarea id="observacionesRefrigeracion" rows="2" placeholder="Notas adicionales"></textarea>
            </div>
            
            <button class="btn btn-registrar" onclick="registrarMovimiento()">
                ‚úÖ REGISTRAR Y CONTINUAR
            </button>
            <button class="btn btn-cancelar" onclick="cancelarRegistro()">
                üè† TERMINAR Y VOLVER AL MEN√ö
            </button>
        </div>
    </div>

    <!-- LISTADO -->
    <div id="secListado" class="oculto">
        <button class="btn btn-cancelar" onclick="volverMenu()" style="margin-bottom: 15px;">
            ‚¨ÖÔ∏è VOLVER AL MEN√ö
        </button>
        <div class="paso">
            <h2>üìã Listado de Movimientos</h2>
            <div id="listaMovimientos"></div>
        </div>
    </div>
    
    <!-- GESTI√ìN PRODUCTOS TRANSFORMABLES -->
    <div id="secGestionTransformables" class="oculto">
        <button class="btn btn-cancelar" onclick="volverMenu()" style="margin-bottom: 15px;">
            ‚¨ÖÔ∏è VOLVER AL MEN√ö
        </button>
        <div class="paso">
            <h2>‚öôÔ∏è Gesti√≥n de Productos Transformables</h2>
            
            <input type="text" id="nuevoTransformable" placeholder="Nombre del producto (ej: Pechuga de Pollo)" style="margin-bottom: 10px;">
            <button class="btn btn-secondary" onclick="agregarTransformable()">
                ‚ûï AGREGAR PRODUCTO
            </button>
            
            <h3 style="margin: 20px 0 10px 0;">Productos actuales:</h3>
            <div class="lista-items" id="listaTransformablesGestion"></div>
        </div>
    </div>
    
    <!-- MODAL CONTEO F√çSICO -->
    <div class="modal-conteo" id="modalConteo">
        <div class="modal-conteo-contenido">
            <div class="modal-conteo-header">
                <h2>üìä CONTEO F√çSICO</h2>
                <p>Salidas - <span id="fechaConteo"></span></p>
            </div>
            
            <div class="toggle-modo">
                <div class="toggle-btn activo" onclick="cambiarModoConteo('escribir')" id="btnEscribir">
                    üîç BUSCAR
                </div>
                <div class="toggle-btn" onclick="cambiarModoConteo('lista')" id="btnLista">
                    üìã LISTA
                </div>
            </div>
            
            <!-- Modo Escribir -->
            <div id="modoEscribir">
                <label>Buscar producto:</label>
                <input list="listaProductosConteo" id="buscarProductoConteo" class="combo-input" 
                       placeholder="Escribe el producto..." onchange="agregarProductoConteo(this.value)">
                <datalist id="listaProductosConteo"></datalist>
            </div>
            
            <!-- Modo Lista -->
            <div id="modoLista" class="oculto">
                <label>Seleccionar producto:</label>
                <select id="selectProductoConteo" class="combo-input" onchange="agregarProductoConteo(this.value)">
                    <option value="">-- Selecciona un producto --</option>
                </select>
            </div>
            
            <div id="conteoProductos" style="margin-top: 20px;">
                <!-- Se llenar√° din√°micamente -->
            </div>
            
            <button class="btn btn-registrar" onclick="generarReporteConteo()">
                ‚úÖ GENERAR REPORTE
            </button>
            <button class="btn btn-cancelar" onclick="cerrarConteoFisico()">
                ‚ùå CANCELAR
            </button>
        </div>
    </div>

    <script>
        // DATOS
        var movimientos = [];
        var tipoActual = '';
        var transformableSeleccionado = '';
        var productosEnConteo = [];
        var modoConteoActual = 'escribir';
        
        // Productos transformables (editables)
        var productosTransformables = [
            'Pechuga de Pollo',
            'Carne Molida',
            'Lomo de Cerdo',
            'Lomo Cocido' // Para rebanar
        ];
        
        // Productos base (mismos de entradas)
        var productosBase = [
            { nombre: 'Carne de Res', lote: true },
            { nombre: 'Pechuga de Pollo', lote: true },
            { nombre: 'PECHUGA REFRIGERADA', lote: true },
            { nombre: 'PERNIL (CONTRAMUSLO SIN/RAB) REFRIGERA', lote: true },
            { nombre: 'CARNE MOLIDA - CAB #8', lote: true },
            { nombre: 'CARNE PARA MOLER 80/20', lote: true },
            { nombre: 'LOMO DE CERDO', lote: true },
            { nombre: 'Lomo de Cerdo', lote: true },
            { nombre: 'Carne Molida', lote: true },
            { nombre: 'COSTILLA ESPECIAL DE CERDO', lote: true },
            { nombre: 'Costilla de Cerdo', lote: true },
            { nombre: 'TOCINO DE CERDO CON PIEL', lote: true },
            { nombre: 'Tocineta', lote: true },
            { nombre: 'Chicharr√≥n', lote: true },
            { nombre: 'Chorizo', lote: true },
            { nombre: 'Morcilla', lote: true },
            { nombre: 'Salchicha Alemana', lote: true },
            { nombre: 'CALLO REVUELTO', lote: true },
            { nombre: 'CARNE DE RES PARA ASAR', lote: true },
            { nombre: 'CARNE DE RES PARA GUISAR', lote: true },
            { nombre: 'ESPINAZO', lote: true },
            { nombre: 'PATA DE RES', lote: true },
            { nombre: 'PUNTA DE ANCA PREMIUM NOVILLON', lote: true },
            { nombre: 'RELLENAS', lote: true },
            { nombre: 'Lim√≥n Fresco', lote: true },
            { nombre: 'Papas', lote: true },
            { nombre: 'PAPA MARQUISE 1 KG', lote: true },
            { nombre: 'Lechuga', lote: true },
            { nombre: 'Tomate', lote: true },
            { nombre: 'Cebolla', lote: true },
            { nombre: 'Aguacate', lote: true },
            { nombre: 'Queso Cheddar', lote: true },
            { nombre: 'Queso Blanco', lote: true },
            { nombre: 'KRAFT SINGLES AMERICAN 16 SLICES 48/12Z', lote: true },
            { nombre: 'Leche de Coco', lote: true },
            { nombre: 'Croqueta de Carne', lote: true },
            { nombre: 'Filetes de Pechuga', lote: true },
            { nombre: 'Trozos de Pechuga', lote: true },
            { nombre: 'Lomo Cocido', lote: true },
            { nombre: 'Pan Brioche', lote: false },
            { nombre: 'BRIOCHE HAMBURGUESA AJONJOLI BLANCOU', lote: false },
            { nombre: 'Pan √Årabe', lote: false },
            { nombre: 'PAPEL ALUMINIO 300MT X 30CM', lote: false },
            { nombre: 'Carb√≥n Vegetal', lote: false },
            { nombre: 'ACEITE SINAI 70/30 20 LT', lote: false },
            { nombre: 'Az√∫car Blanca', lote: false },
            { nombre: 'Sal Marina', lote: false }
        ];
        
        // INICIALIZACI√ìN
        window.onload = function() {
            cargarDatos();
            cargarTransformables();
            cargarListasProductos();
            actualizarStats();
            mostrarListaTransformables();
            mostrarListaTransformablesGestion();
        };
        
        function cargarListasProductos() {
            var datalist = document.getElementById('listaProductos');
            var datalistConteo = document.getElementById('listaProductosConteo');
            var selectConteo = document.getElementById('selectProductoConteo');
            
            productosBase.forEach(function(p) {
                var option1 = document.createElement('option');
                option1.value = p.nombre;
                datalist.appendChild(option1);
                
                var option3 = document.createElement('option');
                option3.value = p.nombre;
                datalistConteo.appendChild(option3);
                
                var option4 = document.createElement('option');
                option4.value = p.nombre;
                option4.textContent = p.nombre;
                selectConteo.appendChild(option4);
            });
            
            // Listeners para productos
            ['productoServicio', 'productoConsumo', 'productoRefrigeracion'].forEach(function(id) {
                var input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', function() {
                        var producto = this.value;
                        var loteId = id.replace('producto', 'lote');
                        var inputLote = document.getElementById(loteId);
                        
                        if (inputLote && producto) {
                            var productoObj = productosBase.find(function(p) { return p.nombre === producto; });
                            if (productoObj && productoObj.lote) {
                                inputLote.value = 'Requerido';
                                inputLote.readOnly = false;
                                inputLote.style.background = '#fff';
                                inputLote.placeholder = 'LOC-1812-001';
                            } else {
                                inputLote.value = 'N/A';
                                inputLote.readOnly = true;
                                inputLote.style.background = '#f0f0f0';
                            }
                        }
                    });
                }
            });
        }
        
        // GESTI√ìN PRODUCTOS TRANSFORMABLES
        function cargarTransformables() {
            var guardados = localStorage.getItem('transformables_rb');
            if (guardados) {
                productosTransformables = JSON.parse(guardados);
            }
        }
        
        function guardarTransformables() {
            localStorage.setItem('transformables_rb', JSON.stringify(productosTransformables));
        }
        
        function abrirGestionTransformables() {
            document.getElementById('menuPrincipal').classList.add('oculto');
            document.getElementById('secGestionTransformables').classList.remove('oculto');
            mostrarListaTransformablesGestion();
        }
        
        function agregarTransformable() {
            var input = document.getElementById('nuevoTransformable');
            var nombre = input.value.trim();
            
            if (!nombre) {
                mostrarMensaje('‚ùå CAMPO VAC√çO\n\nEscribe el nombre del producto', 'error');
                return;
            }
            
            if (productosTransformables.includes(nombre)) {
                mostrarMensaje('‚ùå YA EXISTE\n\nEste producto ya est√° en la lista', 'error');
                return;
            }
            
            productosTransformables.push(nombre);
            guardarTransformables();
            mostrarListaTransformablesGestion();
            input.value = '';
            mostrarMensaje('‚úÖ AGREGADO\n\n' + nombre, 'exito');
        }
        
        function editarTransformable(index) {
            var nombreActual = productosTransformables[index];
            var nuevoNombre = prompt('Editar producto:', nombreActual);
            
            if (nuevoNombre && nuevoNombre.trim()) {
                productosTransformables[index] = nuevoNombre.trim();
                guardarTransformables();
                mostrarListaTransformablesGestion();
                mostrarMensaje('‚úÖ EDITADO', 'exito');
            }
        }
        
        function eliminarTransformable(index) {
            if (confirm('¬øEliminar "' + productosTransformables[index] + '"?')) {
                productosTransformables.splice(index, 1);
                guardarTransformables();
                mostrarListaTransformablesGestion();
                mostrarMensaje('‚úÖ ELIMINADO', 'exito');
            }
        }
        
        function mostrarListaTransformablesGestion() {
            var lista = document.getElementById('listaTransformablesGestion');
            
            if (productosTransformables.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay productos</p>';
                return;
            }
            
            var html = '';
            productosTransformables.forEach(function(p, index) {
                html += '<div class="item-producto">';
                html += '<div class="item-nombre">' + p + '</div>';
                html += '<div class="item-acciones">';
                html += '<button class="btn-item btn-item-editar" onclick="editarTransformable(' + index + ')">‚úèÔ∏è Editar</button>';
                html += '<button class="btn-item btn-item-eliminar" onclick="eliminarTransformable(' + index + ')">üóëÔ∏è Eliminar</button>';
                html += '</div>';
                html += '</div>';
            });
            
            lista.innerHTML = html;
        }
        
        function mostrarListaTransformables() {
            var lista = document.getElementById('listaTransformables');
            
            if (productosTransformables.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #999;">No hay productos transformables configurados</p>';
                return;
            }
            
            var html = '<div style="display: grid; grid-template-columns: 1fr; gap: 10px;">';
            productosTransformables.forEach(function(p) {
                var icono = p.includes('Pechuga') || p.includes('PECHUGA') ? 'üêî' : 
                           (p.includes('Lomo') || p.includes('LOMO') ? 'ü•©' : 'ü•©');
                var desc = p.includes('Cocido') || p.includes('COCIDO') ? 'Rebanar' : 'Transformar';
                
                html += '<div class="tipo-btn" onclick="selTransformable(\'' + p.replace(/'/g, "\\'") + '\')" style="min-height: 70px; text-align: left;">';
                html += '<div style="font-size: 16px; font-weight: bold; color: #333;">' + icono + ' ' + p + '</div>';
                html += '<div style="font-size: 13px; color: #666; margin-top: 5px;">' + desc + '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            lista.innerHTML = html;
        }
        
        function selTransformable(producto) {
            transformableSeleccionado = producto;
            
            document.querySelectorAll('#listaTransformables .tipo-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            event.target.closest('.tipo-btn').classList.add('selected');
            
            document.getElementById('formTransformacion').classList.remove('oculto');
            document.getElementById('procesoSeleccionado').textContent = producto;
            document.getElementById('productoTransformacion').value = producto;
        }
        
        function calcularMerma() {
            var entrada = parseFloat(document.getElementById('cantidadEntrada').value) || 0;
            var salida = parseFloat(document.getElementById('cantidadSalida').value) || 0;
            var merma = entrada - salida;
            var porcMerma = entrada > 0 ? ((merma / entrada) * 100).toFixed(2) : 0;
            
            var resultado = document.getElementById('resultadoMerma');
            if (entrada > 0 && salida > 0) {
                resultado.innerHTML = '<strong>Merma:</strong> ' + merma.toFixed(2) + ' kg (' + porcMerma + '%)';
                resultado.classList.remove('oculto');
            } else {
                resultado.classList.add('oculto');
            }
        }
        
        // NAVEGACI√ìN
        function mostrarRegistro() {
            document.getElementById('menuPrincipal').classList.add('oculto');
            document.getElementById('secRegistro').classList.remove('oculto');
            document.getElementById('paso1').classList.remove('oculto');
            document.getElementById('paso2').classList.add('oculto');
            mostrarListaTransformables();
        }
        
        function volverMenu() {
            document.getElementById('secRegistro').classList.add('oculto');
            document.getElementById('secListado').classList.add('oculto');
            document.getElementById('secGestionTransformables').classList.add('oculto');
            document.getElementById('menuPrincipal').classList.remove('oculto');
        }
        
        function volverPaso1() {
            document.getElementById('paso2').classList.add('oculto');
            document.getElementById('paso1').classList.remove('oculto');
            limpiarFormularios();
        }
        
        function cancelarRegistro() {
            volverMenu();
            setTimeout(function() {
                document.getElementById('paso1').classList.remove('oculto');
                document.getElementById('paso2').classList.add('oculto');
                limpiarFormularios();
            }, 300);
        }
        
        function verListado() {
            if (movimientos.length === 0) {
                mostrarMensaje('üìã NO HAY MOVIMIENTOS\n\nRegistra tu primera salida', 'error');
                return;
            }
            
            document.getElementById('menuPrincipal').classList.add('oculto');
            document.getElementById('secListado').classList.remove('oculto');
            mostrarListado();
        }
        
        // SELECCI√ìN DE TIPO
        function selTipo(tipo) {
            tipoActual = tipo;
            
            document.querySelectorAll('#paso1 .tipo-btn').forEach(function(btn) {
                btn.classList.remove('selected');
            });
            event.target.closest('.tipo-btn').classList.add('selected');
            
            document.getElementById('secServicio').classList.add('oculto');
            document.getElementById('secConsumo').classList.add('oculto');
            document.getElementById('secTransformacion').classList.add('oculto');
            document.getElementById('secRefrigeracion').classList.add('oculto');
            
            document.getElementById('paso1').classList.add('oculto');
            document.getElementById('paso2').classList.remove('oculto');
            
            if (tipo === 'servicio') {
                document.getElementById('tituloPaso2').textContent = '2Ô∏è‚É£ Detalles de Servicio';
                document.getElementById('secServicio').classList.remove('oculto');
            } else if (tipo === 'consumo') {
                document.getElementById('tituloPaso2').textContent = '2Ô∏è‚É£ Detalles de Consumo';
                document.getElementById('secConsumo').classList.remove('oculto');
            } else if (tipo === 'transformacion') {
                document.getElementById('tituloPaso2').textContent = '2Ô∏è‚É£ Transformaci√≥n/Producci√≥n';
                document.getElementById('secTransformacion').classList.remove('oculto');
                mostrarListaTransformables();
            } else if (tipo === 'refrigeracion') {
                document.getElementById('tituloPaso2').textContent = '2Ô∏è‚É£ Detalles Refrigeraci√≥n';
                document.getElementById('secRefrigeracion').classList.remove('oculto');
            }
        }
        
        // REGISTRAR MOVIMIENTO
        function registrarMovimiento() {
            var movimiento = {
                id: Date.now(),
                fecha: new Date().toLocaleDateString('es-CO'),
                hora: new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' }),
                tipo: tipoActual
            };
            
            if (tipoActual === 'servicio') {
                var producto = document.getElementById('productoServicio').value;
                var cantidad = parseFloat(document.getElementById('cantidadServicio').value);
                var responsable = document.getElementById('responsableServicio').value;
                
                if (!producto || !cantidad || !responsable) {
                    mostrarMensaje('‚ùå FALTAN DATOS\n\nCompleta todos los campos obligatorios', 'error');
                    return;
                }
                
                movimiento.producto = producto;
                movimiento.lote = document.getElementById('loteServicio').value || 'N/A';
                movimiento.cantidad = cantidad;
                movimiento.unidad = document.getElementById('unidadServicio').value;
                movimiento.tipoServicio = document.getElementById('tipoServicio').value;
                movimiento.responsable = responsable;
                movimiento.observaciones = document.getElementById('observacionesServicio').value || '-';
                
            } else if (tipoActual === 'consumo') {
                var producto = document.getElementById('productoConsumo').value;
                var cantidad = parseFloat(document.getElementById('cantidadConsumo').value);
                var responsable = document.getElementById('responsableConsumo').value;
                var motivo = document.getElementById('motivoConsumo').value;
                
                if (!producto || !cantidad || !responsable || !motivo) {
                    mostrarMensaje('‚ùå FALTAN DATOS\n\nCompleta todos los campos obligatorios', 'error');
                    return;
                }
                
                if (motivo === 'Otro (especificar abajo)') {
                    motivo = document.getElementById('motivoConsumoOtro').value || 'Otro';
                }
                
                movimiento.producto = producto;
                movimiento.lote = document.getElementById('loteConsumo').value || 'N/A';
                movimiento.cantidad = cantidad;
                movimiento.unidad = document.getElementById('unidadConsumo').value;
                movimiento.motivo = motivo;
                movimiento.responsable = responsable;
                movimiento.observaciones = document.getElementById('observacionesConsumo').value || '-';
                
            } else if (tipoActual === 'transformacion') {
                if (!transformableSeleccionado) {
                    mostrarMensaje('‚ùå SELECCIONA PRODUCTO\n\nElige un producto a transformar', 'error');
                    return;
                }
                
                var lote = document.getElementById('loteTransformacion').value;
                var cantidadEntrada = parseFloat(document.getElementById('cantidadEntrada').value);
                var cantidadSalida = parseFloat(document.getElementById('cantidadSalida').value);
                var responsable = document.getElementById('responsableTransformacion').value;
                
                if (!lote || !cantidadEntrada || !cantidadSalida || !responsable) {
                    mostrarMensaje('‚ùå FALTAN DATOS\n\nCompleta todos los campos obligatorios', 'error');
                    return;
                }
                
                movimiento.producto = transformableSeleccionado;
                movimiento.lote = lote;
                movimiento.cantidadEntrada = cantidadEntrada;
                movimiento.cantidadSalida = cantidadSalida;
                movimiento.cantidad = cantidadEntrada; // Para estad√≠sticas
                movimiento.unidad = 'kg';
                movimiento.merma = cantidadEntrada - cantidadSalida;
                movimiento.porcentajeMerma = ((movimiento.merma / cantidadEntrada) * 100).toFixed(2);
                movimiento.responsable = responsable;
                movimiento.observaciones = document.getElementById('observacionesTransformacion').value || '-';
                
            } else if (tipoActual === 'refrigeracion') {
                var producto = document.getElementById('productoRefrigeracion').value;
                var cantidad = parseFloat(document.getElementById('cantidadRefrigeracion').value);
                var responsable = document.getElementById('responsableRefrigeracion').value;
                var ubicacion = document.getElementById('ubicacionRefrigeracion').value;
                
                if (!producto || !cantidad || !responsable || !ubicacion) {
                    mostrarMensaje('‚ùå FALTAN DATOS\n\nCompleta todos los campos obligatorios', 'error');
                    return;
                }
                
                if (ubicacion === 'Otra (especificar abajo)') {
                    ubicacion = document.getElementById('ubicacionRefrigeracionOtra').value || 'Otra';
                }
                
                movimiento.producto = producto;
                movimiento.lote = document.getElementById('loteRefrigeracion').value || 'N/A';
                movimiento.cantidad = cantidad;
                movimiento.unidad = document.getElementById('unidadRefrigeracion').value;
                movimiento.ubicacion = ubicacion;
                movimiento.responsable = responsable;
                movimiento.observaciones = document.getElementById('observacionesRefrigeracion').value || '-';
            }
            
            movimientos.push(movimiento);
            guardarDatos();
            actualizarStats();
            
            mostrarMensaje('‚úÖ REGISTRADO\n\n¬øContinuar?', 'exito');
            
            setTimeout(function() {
                limpiarCamposProducto();
            }, 1500);
        }
        
        // LISTADO
        function mostrarListado() {
            var lista = document.getElementById('listaMovimientos');
            
            if (movimientos.length === 0) {
                lista.innerHTML = '<p style="text-align: center; color: #999; padding: 30px;">No hay movimientos</p>';
                return;
            }
            
            var html = '';
            movimientos.slice().reverse().forEach(function(m, index) {
                var realIndex = movimientos.length - 1 - index;
                var colorTipo = m.tipo === 'servicio' ? '#4CAF50' : (m.tipo === 'consumo' ? '#FF9800' : (m.tipo === 'transformacion' ? '#2196F3' : '#00BCD4'));
                var iconoTipo = m.tipo === 'servicio' ? 'üíº' : (m.tipo === 'consumo' ? 'üçΩÔ∏è' : (m.tipo === 'transformacion' ? 'üë®‚Äçüç≥' : '‚ùÑÔ∏è'));
                
                html += '<div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid ' + colorTipo + ';">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
                html += '<div style="font-weight: bold; color: ' + colorTipo + ';">' + iconoTipo + ' ' + m.tipo.toUpperCase() + '</div>';
                html += '<div style="font-size: 12px; color: #999;">' + m.fecha + ' ' + m.hora + '</div>';
                html += '</div>';
                html += '<div style="font-size: 16px; font-weight: bold;">' + m.producto + '</div>';
                
                if (m.lote && m.lote !== 'N/A') {
                    html += '<div style="font-size: 13px; color: #999;">Lote: ' + m.lote + '</div>';
                }
                
                html += '<div style="font-size: 14px; color: #666;">Cantidad: ' + m.cantidad + ' ' + m.unidad + '</div>';
                
                if (m.tipo === 'transformacion') {
                    html += '<div style="font-size: 14px; color: #666;">Entrada: ' + m.cantidadEntrada + ' kg | Salida: ' + m.cantidadSalida + ' kg</div>';
                    html += '<div style="font-size: 14px; color: #f44336;">Merma: ' + m.merma.toFixed(2) + ' kg (' + m.porcentajeMerma + '%)</div>';
                } else if (m.tipo === 'servicio') {
                    html += '<div style="font-size: 14px; color: #666;">Tipo: ' + m.tipoServicio + '</div>';
                } else if (m.tipo === 'consumo') {
                    html += '<div style="font-size: 14px; color: #666;">Motivo: ' + m.motivo + '</div>';
                } else if (m.tipo === 'refrigeracion') {
                    html += '<div style="font-size: 14px; color: #666;">Ubicaci√≥n: ' + m.ubicacion + '</div>';
                }
                
                html += '<div style="font-size: 13px; color: #999; margin-top: 5px;">üë§ ' + m.responsable + '</div>';
                html += '<button onclick="eliminarMovimiento(' + realIndex + ')" style="background: #f44336; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%;">üóëÔ∏è Eliminar</button>';
                html += '</div>';
            });
            
            lista.innerHTML = html;
        }
        
        function eliminarMovimiento(index) {
            if (confirm('¬øEliminar este movimiento?')) {
                movimientos.splice(index, 1);
                guardarDatos();
                actualizarStats();
                mostrarListado();
                mostrarMensaje('‚úÖ ELIMINADO', 'exito');
            }
        }
        
        // EXPORTAR XLSX
        function exportarExcel() {
            if (movimientos.length === 0) {
                mostrarMensaje('‚ùå NO HAY MOVIMIENTOS', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                mostrarMensaje('‚ùå ERROR\n\nLibrer√≠a Excel no cargada.\nRecarga la p√°gina.', 'error');
                return;
            }
            
            try {
                var datos = [];
                
                movimientos.forEach(function(m) {
                    var fila = {
                        'FECHA': m.fecha,
                        'HORA': m.hora,
                        'TIPO': m.tipo,
                        'PRODUCTO': m.producto,
                        'LOTE': m.lote || 'N/A',
                        'CANTIDAD': m.cantidad,
                        'UNIDAD': m.unidad
                    };
                    
                    if (m.tipo === 'transformacion') {
                        fila['CANTIDAD_ENTRADA'] = m.cantidadEntrada;
                        fila['CANTIDAD_SALIDA'] = m.cantidadSalida;
                        fila['MERMA'] = m.merma.toFixed(2);
                        fila['PORCENTAJE_MERMA'] = m.porcentajeMerma + '%';
                        fila['TIPO_SERVICIO'] = '-';
                        fila['MOTIVO_CONSUMO'] = '-';
                        fila['UBICACION_REFRIGERACION'] = '-';
                    } else if (m.tipo === 'servicio') {
                        fila['CANTIDAD_ENTRADA'] = '-';
                        fila['CANTIDAD_SALIDA'] = '-';
                        fila['MERMA'] = '-';
                        fila['PORCENTAJE_MERMA'] = '-';
                        fila['TIPO_SERVICIO'] = m.tipoServicio;
                        fila['MOTIVO_CONSUMO'] = '-';
                        fila['UBICACION_REFRIGERACION'] = '-';
                    } else if (m.tipo === 'consumo') {
                        fila['CANTIDAD_ENTRADA'] = '-';
                        fila['CANTIDAD_SALIDA'] = '-';
                        fila['MERMA'] = '-';
                        fila['PORCENTAJE_MERMA'] = '-';
                        fila['TIPO_SERVICIO'] = '-';
                        fila['MOTIVO_CONSUMO'] = m.motivo;
                        fila['UBICACION_REFRIGERACION'] = '-';
                    } else if (m.tipo === 'refrigeracion') {
                        fila['CANTIDAD_ENTRADA'] = '-';
                        fila['CANTIDAD_SALIDA'] = '-';
                        fila['MERMA'] = '-';
                        fila['PORCENTAJE_MERMA'] = '-';
                        fila['TIPO_SERVICIO'] = '-';
                        fila['MOTIVO_CONSUMO'] = '-';
                        fila['UBICACION_REFRIGERACION'] = m.ubicacion;
                    }
                    
                    fila['RESPONSABLE'] = m.responsable;
                    fila['OBSERVACIONES'] = m.observaciones;
                    
                    datos.push(fila);
                });
                
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.json_to_sheet(datos);
                
                var colWidths = [
                    {wch: 12}, {wch: 8}, {wch: 15}, {wch: 35}, {wch: 15}, 
                    {wch: 10}, {wch: 10}, {wch: 12}, {wch: 12}, {wch: 10}, 
                    {wch: 15}, {wch: 20}, {wch: 25}, {wch: 25}, {wch: 20}, {wch: 40}
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, "Salidas");
                
                var fecha = new Date().toLocaleDateString('es-CO').replace(/\//g, '-');
                XLSX.writeFile(wb, 'Salidas_' + fecha + '.xlsx');
                
                mostrarMensaje('‚úÖ EXPORTADO\n\n' + movimientos.length + ' movimientos', 'exito');
                
            } catch (error) {
                console.error('Error al exportar:', error);
                mostrarMensaje('‚ùå ERROR AL EXPORTAR\n\n' + error.message, 'error');
            }
        }
        
        // CONTEO F√çSICO
        function abrirConteoFisico() {
            if (movimientos.length === 0) {
                mostrarMensaje('‚ùå NO HAY MOVIMIENTOS\n\nRegistra salidas primero', 'error');
                return;
            }
            
            var fecha = new Date().toLocaleDateString('es-CO');
            document.getElementById('fechaConteo').textContent = fecha;
            
            productosEnConteo = [];
            document.getElementById('conteoProductos').innerHTML = '';
            document.getElementById('buscarProductoConteo').value = '';
            document.getElementById('selectProductoConteo').selectedIndex = 0;
            
            document.getElementById('modalConteo').classList.add('activo');
        }
        
        function cambiarModoConteo(modo) {
            modoConteoActual = modo;
            
            if (modo === 'escribir') {
                document.getElementById('btnEscribir').classList.add('activo');
                document.getElementById('btnLista').classList.remove('activo');
                document.getElementById('modoEscribir').classList.remove('oculto');
                document.getElementById('modoLista').classList.add('oculto');
            } else {
                document.getElementById('btnLista').classList.add('activo');
                document.getElementById('btnEscribir').classList.remove('activo');
                document.getElementById('modoLista').classList.remove('oculto');
                document.getElementById('modoEscribir').classList.add('oculto');
            }
        }
        
        function agregarProductoConteo(producto) {
            if (!producto || producto === '') return;
            if (productosEnConteo.includes(producto)) {
                mostrarMensaje('‚ö†Ô∏è YA AGREGADO\n\nEste producto ya est√° en el conteo', 'error');
                return;
            }
            
            var salidas = 0;
            movimientos.forEach(function(m) {
                if (m.producto === producto) {
                    salidas += m.cantidad;
                }
            });
            
            productosEnConteo.push(producto);
            
            var html = '<div class="conteo-item" id="conteo_' + producto.replace(/\s+/g, '_') + '">';
            html += '<div class="conteo-producto-nombre">' + producto + '</div>';
            html += '<div class="conteo-sistema">Salidas sistema: <strong>' + salidas.toFixed(2) + ' kg</strong></div>';
            html += '<label>Salidas f√≠sicas:</label>';
            html += '<input type="number" step="0.01" placeholder="0.00" class="conteo-input" ';
            html += 'data-producto="' + producto + '" data-sistema="' + salidas + '" ';
            html += 'onchange="calcularDiferenciaConteo(this)">';
            html += '<div class="conteo-diferencia neutro" id="dif_' + producto.replace(/\s+/g, '_') + '">Ingresa cantidad f√≠sica</div>';
            html += '<button class="btn btn-cancelar" style="margin-top: 10px;" onclick="eliminarProductoConteo(\'' + producto + '\')">üóëÔ∏è Quitar</button>';
            html += '</div>';
            
            document.getElementById('conteoProductos').insertAdjacentHTML('beforeend', html);
            
            document.getElementById('buscarProductoConteo').value = '';
            document.getElementById('selectProductoConteo').selectedIndex = 0;
        }
        
        function eliminarProductoConteo(producto) {
            var index = productosEnConteo.indexOf(producto);
            if (index > -1) {
                productosEnConteo.splice(index, 1);
            }
            var elem = document.getElementById('conteo_' + producto.replace(/\s+/g, '_'));
            if (elem) elem.remove();
        }
        
        function calcularDiferenciaConteo(input) {
            var producto = input.getAttribute('data-producto');
            var sistema = parseFloat(input.getAttribute('data-sistema'));
            var fisico = parseFloat(input.value) || 0;
            var diferencia = fisico - sistema;
            var porcentaje = sistema > 0 ? ((Math.abs(diferencia) / sistema) * 100).toFixed(1) : 0;
            
            var productoId = producto.replace(/\s+/g, '_');
            var divDif = document.getElementById('dif_' + productoId);
            
            if (divDif) {
                if (diferencia > 0.1) {
                    divDif.textContent = 'Exceso: +' + diferencia.toFixed(2) + ' kg (+' + porcentaje + '%)';
                    divDif.className = 'conteo-diferencia positivo';
                } else if (diferencia < -0.1) {
                    divDif.textContent = 'Faltante: ' + diferencia.toFixed(2) + ' kg (-' + porcentaje + '%)';
                    divDif.className = 'conteo-diferencia negativo';
                } else {
                    divDif.textContent = 'Coincide ‚úì';
                    divDif.className = 'conteo-diferencia neutro';
                }
            }
        }
        
        function generarReporteConteo() {
            if (productosEnConteo.length === 0) {
                mostrarMensaje('‚ùå SIN PRODUCTOS\n\nAgrega productos al conteo', 'error');
                return;
            }
            
            if (typeof XLSX === 'undefined') {
                mostrarMensaje('‚ùå ERROR\n\nLibrer√≠a Excel no cargada.\nRecarga la p√°gina.', 'error');
                return;
            }
            
            try {
                var fecha = new Date().toLocaleDateString('es-CO');
                var datos = [];
                
                productosEnConteo.forEach(function(producto) {
                    var input = document.querySelector('input[data-producto="' + producto + '"]');
                    var sistema = parseFloat(input.getAttribute('data-sistema'));
                    var fisico = parseFloat(input.value) || 0;
                    var diferencia = fisico - sistema;
                    var porcentaje = sistema > 0 ? ((Math.abs(diferencia) / sistema) * 100).toFixed(1) : 0;
                    var estado = diferencia > 0.1 ? 'Exceso' : (diferencia < -0.1 ? 'Faltante' : 'OK');
                    
                    datos.push({
                        'PRODUCTO': producto,
                        'SISTEMA': sistema,
                        'FISICO': fisico,
                        'DIFERENCIA': diferencia,
                        'PORCENTAJE': (diferencia >= 0 ? '+' : '') + porcentaje + '%',
                        'ESTADO': estado
                    });
                });
                
                var wb = XLSX.utils.book_new();
                var ws = XLSX.utils.json_to_sheet(datos);
                
                var colWidths = [
                    {wch: 35}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 12}, {wch: 15}
                ];
                ws['!cols'] = colWidths;
                
                XLSX.utils.book_append_sheet(wb, ws, "Conteo F√≠sico");
                XLSX.writeFile(wb, 'Conteo_Fisico_Salidas_' + fecha.replace(/\//g, '-') + '.xlsx');
                
                mostrarMensaje('‚úÖ REPORTE GENERADO\n\nExcel descargado', 'exito');
                cerrarConteoFisico();
                
            } catch (error) {
                console.error('Error al generar reporte:', error);
                mostrarMensaje('‚ùå ERROR AL EXPORTAR\n\n' + error.message, 'error');
            }
        }
        
        function cerrarConteoFisico() {
            document.getElementById('modalConteo').classList.remove('activo');
        }
        
        // UTILIDADES
        function limpiarCamposProducto() {
            if (tipoActual === 'servicio') {
                document.getElementById('productoServicio').value = '';
                document.getElementById('loteServicio').value = '';
                document.getElementById('cantidadServicio').value = '';
                document.getElementById('observacionesServicio').value = '';
                setTimeout(function() {
                    document.getElementById('productoServicio').focus();
                }, 100);
            } else if (tipoActual === 'consumo') {
                document.getElementById('productoConsumo').value = '';
                document.getElementById('loteConsumo').value = '';
                document.getElementById('cantidadConsumo').value = '';
                document.getElementById('observacionesConsumo').value = '';
                setTimeout(function() {
                    document.getElementById('productoConsumo').focus();
                }, 100);
            } else if (tipoActual === 'refrigeracion') {
                document.getElementById('productoRefrigeracion').value = '';
                document.getElementById('loteRefrigeracion').value = '';
                document.getElementById('cantidadRefrigeracion').value = '';
                document.getElementById('observacionesRefrigeracion').value = '';
                setTimeout(function() {
                    document.getElementById('productoRefrigeracion').focus();
                }, 100);
            } else if (tipoActual === 'transformacion') {
                limpiarFormularios();
            }
        }
        
        function limpiarFormularios() {
            document.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(function(input) {
                if (!input.readOnly) input.value = '';
            });
            document.querySelectorAll('select').forEach(function(select) {
                select.selectedIndex = 0;
            });
            tipoActual = '';
            transformableSeleccionado = '';
            document.getElementById('formTransformacion').classList.add('oculto');
            document.getElementById('resultadoMerma').classList.add('oculto');
        }
        
        function mostrarMensaje(texto, tipo) {
            var overlay = document.getElementById('overlay');
            var mensaje = document.createElement('div');
            mensaje.className = 'mensaje ' + tipo;
            mensaje.innerHTML = '<div style="font-size: 18px; white-space: pre-line;">' + texto + '</div>';
            
            document.body.appendChild(mensaje);
            overlay.classList.add('activo');
            
            setTimeout(function() {
                document.body.removeChild(mensaje);
                overlay.classList.remove('activo');
            }, 2000);
        }
        
        function actualizarStats() {
            document.getElementById('stats').textContent = movimientos.length + ' movimientos registrados';
        }
        
        function guardarDatos() {
            localStorage.setItem('salidas_rb', JSON.stringify(movimientos));
        }
        
        function cargarDatos() {
            var datos = localStorage.getItem('salidas_rb');
            if (datos) {
                movimientos = JSON.parse(datos);
            }
        }
    </script>
</body>
</html>
