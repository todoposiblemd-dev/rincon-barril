<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Rinc√≥n del Barril - Gesti√≥n Materias Primas v7.3.6 FINAL</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 650px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px 15px 0 0;
            padding: 15px;
            text-align: center;
            border-bottom: 3px solid #8B0000;
        }

        .header h1 {
            color: #8B0000;
            font-size: 22px;
            margin-bottom: 5px;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 11px;
            margin-top: 10px;
        }

        .user-badge {
            background: #8B0000;
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: white;
            padding: 0 10px;
            border-bottom: 1px solid #DDD;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 6px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 10px;
            min-width: 50px;
            white-space: nowrap;
        }

        .tab-btn.active {
            color: #8B0000;
            border-bottom-color: #8B0000;
        }

        .content {
            background: white;
            padding: 15px;
            border-radius: 0 0 15px 15px;
            min-height: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 12px;
        }

        select, input, textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #DDD;
            border-radius: 6px;
            font-size: 12px;
            font-family: inherit;
        }

        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #8B0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
        }

        .btn {
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B0000 0%, #C41E3A 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
            width: auto;
        }

        .btn-edit {
            background: #FFC107;
            color: white;
        }

        .btn-delete {
            background: #DC3545;
            color: white;
        }

        .btn-export {
            background: #28a745;
            color: white;
            width: 100%;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .btn-export:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .alerta {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 11px;
        }

        .alerta.success {
            background: #D4EDDA;
            color: #155724;
        }

        .alerta.error {
            background: #F8D7DA;
            color: #721C24;
        }

        .area-saldos {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .area-titulo {
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 8px;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 5px;
            font-size: 11px;
        }

        .saldo-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            font-size: 11px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #8B0000;
        }

        .saldo-info {
            flex: 1;
        }

        .saldo-nombre {
            font-weight: 600;
            color: #333;
        }

        .saldo-det {
            font-size: 9px;
            color: #999;
            margin-top: 2px;
        }

        .alerta-stock {
            background: #FFF3CD;
            color: #856404;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            margin-top: 2px;
            display: inline-block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: block;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 15px;
            border-radius: 10px;
            width: 95%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 14px;
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 12px;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 8px;
        }

        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .tabla-reportes {
            width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            margin-bottom: 15px;
            background: white;
        }

        .tabla-reportes thead {
            background: #8B0000;
            color: white;
        }

        .tabla-reportes th {
            padding: 6px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: 600;
        }

        .tabla-reportes td {
            padding: 4px 6px;
            border: 1px solid #ddd;
        }

        .tabla-reportes tbody tr:nth-child(even) {
            background: #f9f9f9;
        }

        .resumen-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .resumen-titulo {
            font-weight: 600;
            color: #8B0000;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .resumen-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 11px;
        }

        .resumen-valor {
            font-weight: 600;
            color: #333;
        }

        .scroll-section {
            max-height: 400px;
            overflow-y: auto;
            padding: 5px;
        }

        .filtro-reportes {
            background: #f9f9f9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .estado-btn {
            padding: 8px;
            border: 2px solid #DDD;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
        }

        .estado-btn.active {
            background: #8B0000;
            color: white;
            border-color: #8B0000;
        }

        .tag-categoria {
            display: inline-block;
            background: #8B0000;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            margin-right: 5px;
        }

        .info-export {
            background: #e8f4f8;
            border: 1px solid #004085;
            color: #004085;
            padding: 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçñ El Rinc√≥n del Barril</h1>
            <h3 style="font-size: 12px; color: #666;">Gesti√≥n de Materias Primas - El Rinc√≥n del Barril</h3>
            <div class="user-info">
                <div>
                    <span style="font-weight: 600;">üë§ </span>
                    <span id="nombre-usuario">Cargando...</span>
                </div>
                <div class="user-badge" id="rol-usuario">Rol</div>
            </div>
            <div id="status-sync" style="margin-top: 10px; padding: 8px; background: #f0f0f0; border-radius: 6px; font-size: 11px; text-align: center; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <span id="indicador-conexion">üì° Conectado</span> ‚Ä¢ 
                    <span id="indicador-sincronizacion">Sincronizados: 0/31</span>
                </div>
                <button onclick="if(confirm('‚ö†Ô∏è ¬øLimpiar TODOS los datos? (Se recomienda solo si hay errores)')) { limpiarLocalStorage(); location.reload(); }" style="background: #ff6b6b; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">üßπ Limpiar</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="cambiarTab('saldos')">üìä Saldos</button>
            <button class="tab-btn" onclick="cambiarTab('entradas')">üì• Entradas</button>
            <button class="tab-btn" onclick="cambiarTab('salidas')">üì§ Salidas</button>
            <button class="tab-btn" onclick="cambiarTab('responsables')">üë• Resp</button>
            <button class="tab-btn" onclick="cambiarTab('categorias')">üìÇ Cat</button>
            <button class="tab-btn" onclick="cambiarTab('reportes')">üìà Reportes</button>
        </div>

        <div class="content">
            <div id="alerta"></div>

            <!-- TAB SALDOS -->
            <div id="saldos" class="tab-content active">
                <div style="margin-bottom: 10px;">
                    <button class="btn btn-primary btn-small" onclick="abrirAgregarSaldo()" style="width: 100%;">‚ûï Agregar Producto</button>
                </div>
                <div class="scroll-section" id="lista-saldos"></div>
            </div>

            <!-- TAB ENTRADAS -->
            <div id="entradas" class="tab-content">
                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Proveedor *</label>
                        <select id="proveedor-entrada" required></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="abrirNuevoProveedor()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Materia Prima *</label>
                        <select id="producto-entrada" required onchange="actualizarEstadoEntrada()"></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="abrirNuevoProductoEntrada()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div id="estado-entrada-grupo" style="display: none;">
                    <label>Estado de Entrada</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoEntrada('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoEntrada('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-entrada" value="cocido">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad-entrada" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Costo Unit. *</label>
                        <input type="number" id="costo-entrada" placeholder="$0" step="0.01" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Responsable *</label>
                    <select id="responsable-entrada" required></select>
                </div>

                <div class="form-row" style="gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="registrarEntrada()">‚úÖ Registrar</button>
                    <button class="btn btn-secondary" onclick="limpiarFormEntrada()">üîÑ Limpiar</button>
                </div>

                <h3 style="margin-top: 15px; margin-bottom: 8px; color: #8B0000; font-size: 12px;">√öltimas 5 Entradas</h3>
                <div class="scroll-section" id="lista-entradas" style="max-height: 250px;"></div>
            </div>

            <!-- TAB SALIDAS -->
            <div id="salidas" class="tab-content">
                <div class="form-group">
                    <label>Destino *</label>
                    <select id="destino-salida" required>
                        <option value="">-- Selecciona --</option>
                        <option value="cocina">üë®‚Äçüç≥ A Cocina</option>
                        <option value="barril">üçñ Al Barril</option>
                        <option value="caja">üí∞ A Caja</option>
                        <option value="consumo">ü•ò Consumo</option>
                        <option value="barril-venta">üíµ Barril‚ÜíVenta</option>
                        <option value="merma">üìâ Merma</option>
                        <option value="danio">üî• Da√±o</option>
                    </select>
                </div>

                <div style="display: flex; gap: 8px; align-items: flex-end; margin-bottom: 12px;">
                    <div class="form-group" style="flex: 1; margin-bottom: 0;">
                        <label>Materia Prima *</label>
                        <select id="producto-salida" required onchange="actualizarEstadoSalida()"></select>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="abrirNuevoProductoSalida()" style="margin-bottom: 0; padding: 8px 12px;">‚ûï</button>
                </div>

                <div id="estado-salida-grupo" style="display: none;">
                    <label>Estado de Salida</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button type="button" class="estado-btn" onclick="seleccionarEstadoSalida('crudo')">Crudo</button>
                        <button type="button" class="estado-btn active" onclick="seleccionarEstadoSalida('cocido')">Cocido</button>
                    </div>
                    <input type="hidden" id="estado-salida" value="cocido">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad *</label>
                        <input type="number" id="cantidad-salida" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Responsable *</label>
                        <select id="responsable-salida" required></select>
                    </div>
                </div>

                <div class="form-row" style="gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="registrarSalida()">‚úÖ Registrar</button>
                    <button class="btn btn-secondary" onclick="limpiarFormSalida()">üîÑ Limpiar</button>
                </div>

                <h3 style="margin-top: 15px; margin-bottom: 8px; color: #8B0000; font-size: 12px;">√öltimas 5 Salidas</h3>
                <div class="scroll-section" id="lista-salidas" style="max-height: 250px;"></div>
            </div>

            <!-- TAB RESPONSABLES -->
            <div id="responsables" class="tab-content">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="nuevo-responsable" placeholder="Nuevo responsable" style="flex: 1;">
                    <button class="btn btn-primary btn-small" onclick="agregarResponsable()" style="width: auto;">Agregar</button>
                </div>
                <div class="scroll-section" id="lista-responsables"></div>
            </div>

            <!-- TAB CATEGOR√çAS -->
            <div id="categorias" class="tab-content">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <input type="text" id="nueva-categoria" placeholder="Nueva categor√≠a" style="flex: 1;">
                    <button class="btn btn-primary btn-small" onclick="agregarCategoria()" style="width: auto;">Agregar</button>
                </div>
                <div class="scroll-section" id="lista-categorias"></div>
            </div>

            <!-- TAB REPORTES -->
            <div id="reportes" class="tab-content">
                <div class="info-export">
                    üì• <strong>Descargar reporte en EXCEL (.xlsx)</strong> - Stock + Movimientos
                </div>

                <button class="btn btn-export" onclick="descargarExcel()">üìä Descargar EXCEL</button>

                <div class="filtro-reportes">
                    <label>Rango de Fechas</label>
                    <div class="form-row">
                        <input type="date" id="fecha-desde" onchange="actualizarReportes()">
                        <input type="date" id="fecha-hasta" onchange="actualizarReportes()">
                    </div>
                    <button class="btn btn-secondary" onclick="limpiarFiltroFechas()" style="margin-top: 8px; font-size: 11px;">üîÑ Ver Todos</button>
                </div>

                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">‚ö†Ô∏è ALERTAS DE STOCK BAJO</h3>
                <div id="alertas-stock"></div>

                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">üí∞ RESUMEN DE COSTOS</h3>
                <div id="resumen-costos"></div>

                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">üìä STOCK ACTUAL</h3>
                <div class="scroll-section" id="tabla-stock-actual" style="max-height: 300px;"></div>

                <h3 style="color: #8B0000; margin: 15px 0 10px 0; font-size: 12px;">üìã TODOS LOS MOVIMIENTOS</h3>
                <div class="scroll-section" id="tabla-movimientos" style="max-height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- MODAL SALDO -->
    <div id="modalSaldo" class="modal">
        <div class="modal-content">
            <div class="modal-header">‚ûï Agregar Producto</div>

            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="saldo-nombre" placeholder="Ej: Costilla de res">
            </div>

            <div class="form-group">
                <label>Categor√≠a *</label>
                <select id="saldo-categoria" required></select>
            </div>

            <div class="form-group">
                <label>Stock M√≠nimo *</label>
                <input type="number" id="saldo-stock-minimo" placeholder="Ej: 10" step="0.01" required>
            </div>

            <div class="form-group">
                <label>üì¶ Cantidad Inicial (Disponible)</label>
                <input type="number" id="saldo-cantidad-inicial" placeholder="0.00" step="0.01" value="0">
                <small style="color: #666; font-size: 10px; margin-top: 2px;">La cantidad actual en bodega</small>
            </div>

            <div id="grupo-cantidades" style="display: none;">
                <hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">
                <h4 style="color: #8B0000; font-size: 12px; margin-bottom: 10px;">‚ö†Ô∏è Para Prote√≠nas (opcional):</h4>
                
                <div class="form-group">
                    <label>Cantidad Cruda (kg) üîµ</label>
                    <input type="number" id="saldo-cant-cruda" placeholder="0.00" step="0.01">
                </div>

                <div class="form-group">
                    <label>Cantidad Cocida (kg) üî¥</label>
                    <input type="number" id="saldo-cant-cocida" placeholder="0.00" step="0.01">
                </div>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarSaldo()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalSaldo()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO PRODUCTO R√ÅPIDO -->
    <div id="modalNuevoProducto" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">‚ûï Nuevo Producto</div>

            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="prod-rapido-nombre" placeholder="Ej: Cilantro fresco">
            </div>

            <div class="form-group">
                <label>Categor√≠a *</label>
                <select id="prod-rapido-categoria" required></select>
            </div>

            <div class="form-group">
                <label>Stock M√≠nimo *</label>
                <input type="number" id="prod-rapido-minimo" placeholder="Ej: 2" step="0.01" value="0">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarProductoRapido()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalNuevoProducto()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NUEVO PROVEEDOR R√ÅPIDO -->
    <div id="modalNuevoProveedor" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">‚ûï Nuevo Proveedor</div>

            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" id="prov-rapido-nombre" placeholder="Ej: Fruver Centro">
            </div>

            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="text" id="prov-rapido-telefono" placeholder="+57 300 1234567">
            </div>

            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="guardarProveedorRapido()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModalNuevoProveedor()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // CONFIGURACI√ìN
        const CATEGORIAS_INICIALES = {
            'proteinas': 'üçñ Prote√≠nas',
            'lacteos': 'üßÄ L√°cteos',
            'congelados': '‚ùÑÔ∏è Congelados',
            'secos': 'üåæ Secos',
            'verduras': 'ü•¨ Verduras',
            'papeleria': 'üìù Papeler√≠a',
            'gaseosas': 'ü•§ Gaseosas',
            'cervezas': 'üç∫ Cervezas',
            'condimentos': 'üßÇ Condimentos/Salsas',
            'aceites': 'ü´í Aceites y Especias',
            'bebidas': 'üßã Bebidas Preparadas',
            'empaques': 'üì¶ Empaques'
        };

        const PRODUCTOS_INICIALES = [
            { nombre: 'Costilla de cerdo', categoria: 'üçñ Prote√≠nas', cantCruda: 3.95, cantCocida: 0, unidad: 'kg', stockMin: 5.0 },
            { nombre: 'Pollo', categoria: 'üçñ Prote√≠nas', cantCruda: 16.0, cantCocida: 0, unidad: 'kg', stockMin: 7.0 },
            { nombre: 'Queso paisa', categoria: 'üßÄ L√°cteos', cantCruda: 0.52, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'Papa', categoria: '‚ùÑÔ∏è Congelados', cantCruda: 12.5, cantCocida: 0, unidad: 'kg', stockMin: 10.0 },
            { nombre: 'chicharron', categoria: 'üçñ Prote√≠nas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 7.0 },
            { nombre: 'lomo de cerdo', categoria: 'üçñ Prote√≠nas', cantCruda: 4.89, cantCocida: 0, unidad: 'kg', stockMin: 4.0 },
            { nombre: 'punta de anca', categoria: 'üçñ Prote√≠nas', cantCruda: 3.04, cantCocida: 0, unidad: 'kg', stockMin: 2.0 },
            { nombre: 'carne molida CAB', categoria: 'üçñ Prote√≠nas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'carne molida regular', categoria: 'üçñ Prote√≠nas', cantCruda: 9.3, cantCocida: 0, unidad: 'kg', stockMin: 4.0 },
            { nombre: 'croquetas de carne', categoria: 'üçñ Prote√≠nas', cantCruda: 74.0, cantCocida: 0, unidad: 'kg', stockMin: 70.0 },
            { nombre: 'pecho de res', categoria: 'üçñ Prote√≠nas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'contramuslo de pollo', categoria: 'üçñ Prote√≠nas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'colita de cadera', categoria: 'üçñ Prote√≠nas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 3.0 },
            { nombre: 'morcilla', categoria: 'üçñ Prote√≠nas', cantCruda: 1.84, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'chorizo', categoria: 'üçñ Prote√≠nas', cantCruda: 1.27, cantCocida: 0, unidad: 'kg', stockMin: 0.5 },
            { nombre: 'queso cheddar', categoria: 'üßÄ L√°cteos', cantCruda: 47.0, cantCocida: 0, unidad: 'kg', stockMin: 80.0 },
            { nombre: 'tocineta', categoria: 'üçñ Prote√≠nas', cantCruda: 7.6, cantCocida: 0, unidad: 'kg', stockMin: 3.0 },
            { nombre: 'salchichas', categoria: 'üçñ Prote√≠nas', cantCruda: 19.0, cantCocida: 0, unidad: 'kg', stockMin: 15.0 },
            { nombre: 'pan brioche de hamburguesa', categoria: 'üåæ Secos', cantCruda: 46.0, cantCocida: 0, unidad: 'kg', stockMin: 30.0 },
            { nombre: 'pan brioche de perro', categoria: 'üåæ Secos', cantCruda: 13.0, cantCocida: 0, unidad: 'kg', stockMin: 10.0 },
            { nombre: 'papa pastusa', categoria: 'ü•¨ Verduras', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 4.0 },
            { nombre: 'cebolla cabezona', categoria: 'ü•¨ Verduras', cantCruda: 2.1, cantCocida: 0, unidad: 'kg', stockMin: 3.0 },
            { nombre: 'tomate', categoria: 'ü•¨ Verduras', cantCruda: 2.0, cantCocida: 0, unidad: 'kg', stockMin: 3.0 },
            { nombre: 'ajo pelado en bolsa', categoria: 'ü•¨ Verduras', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'pimenton rojo', categoria: 'ü•¨ Verduras', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'cebolla morada', categoria: 'ü•¨ Verduras', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'limon tahiti', categoria: 'ü•¨ Verduras', cantCruda: 8.0, cantCocida: 0, unidad: 'kg', stockMin: 3.0 },
            { nombre: 'arroz zulia', categoria: 'üåæ Secos', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 2.0 },
            { nombre: 'frijol bolon rojo', categoria: 'üåæ Secos', cantCruda: 1.6, cantCocida: 0, unidad: 'kg', stockMin: 1.5 },
            { nombre: 'panela', categoria: 'ü•¨ Verduras', cantCruda: 2.0, cantCocida: 0, unidad: 'kg', stockMin: 2.0 },
            { nombre: 'mayonesa natucampo', categoria: 'üßÄ L√°cteos', cantCruda: 3.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'cebolla roja', categoria: 'ü•¨ Verduras', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0 },
            { nombre: 'ajo badia', categoria: 'üßÇ Condimentos/Salsas', cantCruda: 0.53, cantCocida: 0, unidad: 'kg', stockMin: 0.3 },
            { nombre: 'pimienta molida badia', categoria: 'üßÇ Condimentos/Salsas', cantCruda: 0.35, cantCocida: 0, unidad: 'kg', stockMin: 0.3 },
            { nombre: 'paprika', categoria: 'üßÇ Condimentos/Salsas', cantCruda: 1.4, cantCocida: 0, unidad: 'kg', stockMin: 0.3 },
            { nombre: 'agua p600', categoria: 'ü•§ Gaseosas', cantCruda: 15.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'huevos', categoria: 'üßÄ L√°cteos', cantCruda: 21.0, cantCocida: 0, unidad: 'kg', stockMin: 12.0 },
            { nombre: 'coca cola 1.5', categoria: 'ü•§ Gaseosas', cantCruda: 9.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'coca cola p400', categoria: 'ü•§ Gaseosas', cantCruda: 11.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'coca cola zero 1.5', categoria: 'ü•§ Gaseosas', cantCruda: 1.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'coca cola zero p400', categoria: 'ü•§ Gaseosas', cantCruda: 10.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'coca cola zero p250', categoria: 'ü•§ Gaseosas', cantCruda: 7.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'quatro 1.5', categoria: 'ü•§ Gaseosas', cantCruda: 2.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'quatro p400', categoria: 'ü•§ Gaseosas', cantCruda: 8.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'quatro p250', categoria: 'ü•§ Gaseosas', cantCruda: 0.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'sprite 1.5', categoria: 'ü•§ Gaseosas', cantCruda: 5.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'sprite p400', categoria: 'ü•§ Gaseosas', cantCruda: 6.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'kola roman 1.5', categoria: 'ü•§ Gaseosas', cantCruda: 8.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'kola roman p400', categoria: 'ü•§ Gaseosas', cantCruda: 4.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'soda frutos rojos', categoria: 'ü•§ Gaseosas', cantCruda: 16.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'soda frutos amarillos', categoria: 'ü•§ Gaseosas', cantCruda: 13.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'cerveza', categoria: 'üç∫ Cervezas', cantCruda: 0.0, cantCocida: 0, unidad: 'und', stockMin: 12.0 },
            { nombre: 'crema de coco', categoria: 'üßã Bebidas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0.1 },
            { nombre: 'cerezas', categoria: 'üßã Bebidas', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 0.1 },
            { nombre: 'soda p400', categoria: 'ü•§ Gaseosas', cantCruda: 12.0, cantCocida: 0, unidad: 'und', stockMin: 6.0 },
            { nombre: 'Caja de hamburguesa', categoria: 'üìå Empaques', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 100.0 },
            { nombre: 'caja para 1/2kg picada', categoria: 'üìå Empaques', cantCruda: 0.0, cantCocida: 0, unidad: 'kg', stockMin: 30.0 },
            { nombre: 'caja para 1kg picada', categoria: 'üìå Empaques', cantCruda: 45.0, cantCocida: 0, unidad: 'kg', stockMin: 30.0 },
            { nombre: 'icopor P1', categoria: 'üìå Empaques', cantCruda: 11.0, cantCocida: 0, unidad: 'kg', stockMin: 20.0 },
            { nombre: 'icopor C1', categoria: 'üìå Empaques', cantCruda: 16.0, cantCocida: 0, unidad: 'kg', stockMin: 20.0 },
            { nombre: 'contenedor 16 OZ', categoria: 'üìå Empaques', cantCruda: 75.0, cantCocida: 0, unidad: 'kg', stockMin: 20.0 },
            { nombre: 'contenedor 24 OZ', categoria: 'üìå Empaques', cantCruda: 59.0, cantCocida: 0, unidad: 'kg', stockMin: 20.0 },
            { nombre: 'potes 4 OZ ensalada', categoria: 'üìå Empaques', cantCruda: 275.0, cantCocida: 0, unidad: 'kg', stockMin: 70.0 },
            { nombre: 'potes 1 OZ salsas', categoria: 'üìå Empaques', cantCruda: 302.0, cantCocida: 0, unidad: 'kg', stockMin: 150.0 },
            { nombre: 'servilletas', categoria: 'üìå Empaques', cantCruda: 21.0, cantCocida: 0, unidad: 'kg', stockMin: 10.0 },
            { nombre: 'vasos desechables 12 OZ', categoria: 'üìå Empaques', cantCruda: 100.0, cantCocida: 0, unidad: 'kg', stockMin: 50.0 },
            { nombre: 'vasos 12 OZ con tapa para llevar limonada', categoria: 'üìå Empaques', cantCruda: 2.0, cantCocida: 0, unidad: 'kg', stockMin: 25.0 },
            { nombre: 'bolsas 2kg', categoria: 'üìå Empaques', cantCruda: 2.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'bolsas de 10 kg', categoria: 'üìå Empaques', cantCruda: 2.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'bolsas de 20 kg', categoria: 'üìå Empaques', cantCruda: 1.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'salsa de tomate heinz', categoria: 'üßÇ Condimentos/Salsas', cantCruda: 3.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 },
            { nombre: 'salsa mostaza', categoria: 'üßÇ Condimentos/Salsas', cantCruda: 1.0, cantCocida: 0, unidad: 'kg', stockMin: 1.0 }
        ];

        const PROVEEDORES_INICIALES = [
            { nombre: 'Atlantic', telefono: '+57 300 1234567' },
            { nombre: 'Novillon', telefono: '+57 300 2345678' },
            { nombre: 'Makro', telefono: '+57 300 9012345' }
        ];

        // URL DE GOOGLE APPS SCRIPT PARA SINCRONIZAR MOVIMIENTOS
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwm-dIvHgZgQpTL4li_WbwRjoxcyhuc5cYUC9KTBoP_aau0IHZCsgdvWlc3_lWiNsDO/exec';

        // VARIABLES
        let usuarioActual = {};
        let saldos = [];
        let movimientos = [];
        let proveedores = [];
        let responsables = ['Bodega', 'Cocinero', 'Cajero', 'Sal√≥n'];
        let categorias = { ...CATEGORIAS_INICIALES };
        let saldoEnEdicion = null;
        let productosNoSincronizados = [];
        let estadoConexion = true;
        let ultimaSincronizacion = new Date().toISOString();

        function limpiarLocalStorage() {
            console.log('üßπ Limpiando localStorage...');
            localStorage.removeItem('datosMateriasPrimas');
            console.log('‚úÖ localStorage limpiado');
        }

        function verificarIntegridad() {
            try {
                const datosGuardados = localStorage.getItem('datosMateriasPrimas');
                if (datosGuardados) {
                    const datos = JSON.parse(datosGuardados);
                    if (datos.saldos && datos.saldos.length > 100) {
                        console.warn('‚ö†Ô∏è Datos corruptos detectados: ' + datos.saldos.length + ' productos (deber√≠a ser 31)');
                        limpiarLocalStorage();
                        return false;
                    }
                    if (datos.saldos && !datos.saldos[0]?.nombre) {
                        console.warn('‚ö†Ô∏è Estructura de datos inv√°lida');
                        limpiarLocalStorage();
                        return false;
                    }
                }
                return true;
            } catch(error) {
                console.error('‚ùå Error verificando integridad:', error);
                limpiarLocalStorage();
                return false;
            }
        }

        function inicializar() {
            console.log('‚úÖ Sistema Iniciando...');
            localStorage.clear();
            console.log('‚úÖ localStorage limpio');
            cargarDatos();
            if (saldos.length === 0) {
                saldos = PRODUCTOS_INICIALES.map((p, i) => {
                    const base = {
                        id: 'saldo_' + i,
                        nombre: p.nombre,
                        categoria: p.categoria,
                        unidad: p.unidad,
                        stockMinimo: p.stockMin,
                        fechaCreacion: new Date().toISOString(),
                        sincronizado: false
                    };
                    if (p.categoria === 'proteinas') {
                        return { ...base, cantidadCruda: p.cantCruda, cantidadCocida: p.cantCocida };
                    } else {
                        return { ...base, cantidad: p.cantidad };
                    }
                });
                guardarDatos();
            }
            if (proveedores.length === 0) {
                proveedores = PROVEEDORES_INICIALES.map((p, i) => ({
                    id: 'prov_' + i,
                    nombre: p.nombre,
                    telefono: p.telefono,
                    observaciones: '',
                    fechaCreacion: new Date().toISOString()
                }));
                guardarDatos();
            }
            detectarUsuario();
            actualizarSelectoCategorias();
            actualizarSelectos();
            actualizarSaldos();
            actualizarListaResponsables();
            actualizarListaCategorias();
            establecerFechasActuales();
            detectarConexion();
            setTimeout(() => {
                if (saldos.length > 0) {
                    console.log('üîÑ Iniciando sincronizaci√≥n autom√°tica de ' + saldos.length + ' productos...');
                    saldos.forEach(saldo => {
                        enviarSaldoAGoogleSheets(saldo);
                    });
                }
            }, 2000);
        }

        function detectarUsuario() {
            const usuario = prompt('üë§ Ingresa tu nombre:', '');
            const rolNum = prompt('üéØ Tu rol?\n1. Bodega\n2. Cocinero\n3. Cajero\n4. Gerente', '1');
            const rolesMap = { '1': 'Bodega', '2': 'Cocinero', '3': 'Cajero', '4': 'Gerente' };
            usuarioActual = {
                nombre: usuario || 'Usuario',
                rol: rolesMap[rolNum] || 'Bodega'
            };
            document.getElementById('nombre-usuario').textContent = usuarioActual.nombre;
            document.getElementById('rol-usuario').textContent = usuarioActual.rol;
        }

        function cargarDatos() {
            const datosGuardados = localStorage.getItem('datosMateriasPrimas');
            if (datosGuardados) {
                try {
                    const datos = JSON.parse(datosGuardados);
                    saldos = datos.saldos || [];
                    movimientos = datos.movimientos || [];
                    proveedores = datos.proveedores || [];
                    responsables = datos.responsables || ['Bodega', 'Cocinero', 'Cajero', 'Sal√≥n'];
                    categorias = datos.categorias || { ...CATEGORIAS_INICIALES };
                    console.log('‚úÖ Datos cargados del localStorage');
                } catch(error) {
                    console.error('Error al cargar datos:', error);
                    saldos = [];
                    movimientos = [];
                    proveedores = [];
                }
            } else {
                saldos = [];
                movimientos = [];
                proveedores = [];
                responsables = ['Bodega', 'Cocinero', 'Cajero', 'Sal√≥n'];
                categorias = { ...CATEGORIAS_INICIALES };
            }
            PRODUCTOS_INICIALES.forEach((producto, indice) => {
                const existe = saldos.find(s => s.nombre === producto.nombre);
                if (!existe) {
                    const nuevoSaldo = {
                        id: 'saldo_' + indice + '_' + Date.now(),
                        nombre: producto.nombre,
                        categoria: producto.categoria,
                        unidad: producto.unidad,
                        stockMinimo: producto.stockMin,
                        cantidad: producto.cantidad || 0,
                        cantidadCruda: producto.cantCruda || 0,
                        cantidadCocida: producto.cantCocida || 0,
                        fechaCreacion: new Date().toISOString(),
                        sincronizado: false
                    };
                    saldos.push(nuevoSaldo);
                    console.log('‚úÖ Agregado producto: ' + producto.nombre);
                }
            });
            console.log('‚úÖ Total productos cargados: ' + saldos.length);
            guardarDatos();
        }

        function guardarDatos() {
            localStorage.setItem('datosMateriasPrimas', JSON.stringify({
                saldos, movimientos, proveedores, responsables, categorias
            }));
        }

        function establecerFechasActuales() {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fecha-desde').value = hoy;
            document.getElementById('fecha-hasta').value = hoy;
        }

        function limpiarFiltroFechas() {
            document.getElementById('fecha-desde').value = '';
            document.getElementById('fecha-hasta').value = '';
            actualizarReportes();
        }

        function actualizarSaldos() {
            const lista = document.getElementById('lista-saldos');
            const porCategoria = {};
            saldos.forEach(saldo => {
                if (!porCategoria[saldo.categoria]) porCategoria[saldo.categoria] = [];
                porCategoria[saldo.categoria].push(saldo);
            });
            let html = '';
            Object.keys(porCategoria).forEach(cat => {
                html += `<div class="area-saldos"><div class="area-titulo">${categorias[cat] || cat}</div>`;
                porCategoria[cat].forEach(saldo => {
                    let stockHtml = '';
                    let alertaHTML = '';
                    if (saldo.categoria === 'proteinas') {
                        const saldoCrudo = calcularSaldoCrudo(saldo.id);
                        const saldoCocido = calcularSaldoCocido(saldo.id);
                        const total = saldoCrudo + saldoCocido;
                        const alerta = total < (saldo.stockMinimo || 0);
                        stockHtml = `<div style="font-size: 10px; color: #666; margin-top: 3px;">üîµ Crudo: ${saldoCrudo.toFixed(2)} | üî¥ Cocido: ${saldoCocido.toFixed(2)}</div>`;
                        if (alerta) alertaHTML = `<div class="alerta-stock">‚ö†Ô∏è ${total.toFixed(2)}/${saldo.stockMinimo}</div>`;
                    } else {
                        const cantidad = calcularSaldoActual(saldo.id);
                        const alerta = cantidad < (saldo.stockMinimo || 0);
                        stockHtml = `<div style="font-size: 10px; color: #666; margin-top: 3px;">Stock: ${cantidad.toFixed(2)} ${saldo.unidad}</div>`;
                        if (alerta) alertaHTML = `<div class="alerta-stock">‚ö†Ô∏è ${cantidad.toFixed(2)}/${saldo.stockMinimo}</div>`;
                    }
                    html += `<div class="saldo-item"><div class="saldo-info"><div class="saldo-nombre">${saldo.nombre}</div><div class="saldo-det"><span class="tag-categoria">${categorias[saldo.categoria]}</span></div>${stockHtml}${alertaHTML}</div><div style="display: flex; gap: 4px;"><button class="btn btn-small btn-edit" onclick="abrirEditarSaldo('${saldo.id}')">‚úèÔ∏è</button><button class="btn btn-small btn-delete" onclick="abrirEliminarSaldo('${saldo.id}')">üóëÔ∏è</button></div></div>`;
                });
                html += '</div>';
            });
            lista.innerHTML = html;
        }

        function calcularSaldoCrudo(productoId) {
            const saldo = saldos.find(s => s.id === productoId);
            let cantidad = parseFloat(saldo?.cantidadCruda) || 0;
            movimientos.forEach(mov => {
                if (mov.producto === productoId && mov.tipo === 'entrada' && mov.estado === 'crudo') {
                    cantidad += parseFloat(mov.cantidad) || 0;
                } else if (mov.producto === productoId && mov.tipo === 'salida' && mov.estado === 'crudo') {
                    cantidad -= parseFloat(mov.cantidad) || 0;
                }
            });
            return cantidad;
        }

        function calcularSaldoCocido(productoId) {
            const saldo = saldos.find(s => s.id === productoId);
            let cantidad = parseFloat(saldo?.cantidadCocida) || 0;
            movimientos.forEach(mov => {
                if (mov.producto === productoId && mov.tipo === 'entrada' && mov.estado === 'cocido') {
                    cantidad += parseFloat(mov.cantidad) || 0;
                } else if (mov.producto === productoId && mov.tipo === 'salida' && mov.estado === 'cocido') {
                    cantidad -= parseFloat(mov.cantidad) || 0;
                }
            });
            return cantidad;
        }

        function calcularSaldoActual(productoId) {
            const saldo = saldos.find(s => s.id === productoId);
            let cantidad = 0;
            if (saldo?.categoria === 'proteinas') {
                cantidad = (parseFloat(saldo?.cantidadCruda) || 0) + (parseFloat(saldo?.cantidadCocida) || 0);
            } else {
                cantidad = parseFloat(saldo?.cantidad) || 0;
            }
            movimientos.forEach(mov => {
                if (mov.producto === productoId) {
                    if (mov.tipo === 'entrada') cantidad += parseFloat(mov.cantidad) || 0;
                    else cantidad -= parseFloat(mov.cantidad) || 0;
                }
            });
            return cantidad;
        }

        function abrirAgregarSaldo() {
            saldoEnEdicion = null;
            document.getElementById('saldo-nombre').value = '';
            document.getElementById('saldo-categoria').value = '';
            document.getElementById('saldo-stock-minimo').value = '';
            document.getElementById('saldo-cantidad-inicial').value = '0';
            document.getElementById('saldo-cant-cruda').value = '';
            document.getElementById('saldo-cant-cocida').value = '';
            document.getElementById('grupo-cantidades').style.display = 'none';
            document.getElementById('modalSaldo').classList.add('active');
        }

        function abrirEditarSaldo(id) {
            const saldo = saldos.find(s => s.id === id);
            if (!saldo) return;
            saldoEnEdicion = id;
            document.getElementById('saldo-nombre').value = saldo.nombre;
            document.getElementById('saldo-categoria').value = saldo.categoria;
            document.getElementById('saldo-stock-minimo').value = saldo.stockMinimo || '';
            if (saldo.categoria === 'proteinas') {
                const totalCantidad = (saldo.cantidadCruda || 0) + (saldo.cantidadCocida || 0);
                document.getElementById('saldo-cantidad-inicial').value = totalCantidad.toFixed(2);
                document.getElementById('grupo-cantidades').style.display = 'block';
                document.getElementById('saldo-cant-cruda').value = (saldo.cantidadCruda || 0).toFixed(2);
                document.getElementById('saldo-cant-cocida').value = (saldo.cantidadCocida || 0).toFixed(2);
            } else {
                document.getElementById('saldo-cantidad-inicial').value = (saldo.cantidad || 0).toFixed(2);
                document.getElementById('grupo-cantidades').style.display = 'none';
            }
            document.getElementById('modalSaldo').classList.add('active');
        }

        function guardarSaldo() {
            const nombre = document.getElementById('saldo-nombre').value.trim();
            const categoria = document.getElementById('saldo-categoria').value;
            const stockMin = parseFloat(document.getElementById('saldo-stock-minimo').value);
            const cantidadInicial = parseFloat(document.getElementById('saldo-cantidad-inicial').value) || 0;
            if (!nombre || !categoria || isNaN(stockMin)) {
                mostrarAlerta('‚ö†Ô∏è Completa todos los campos', 'error');
                return;
            }
            if (saldoEnEdicion) {
                const index = saldos.findIndex(s => s.id === saldoEnEdicion);
                if (categoria === 'proteinas') {
                    const cantCruda = parseFloat(document.getElementById('saldo-cant-cruda').value) || 0;
                    const cantCocida = parseFloat(document.getElementById('saldo-cant-cocida').value) || 0;
                    const usarCrudaCocida = cantCruda > 0 || cantCocida > 0;
                    saldos[index] = {
                        id: saldoEnEdicion,
                        nombre, categoria, unidad: saldos[index].unidad, stockMinimo: stockMin,
                        cantidadCruda: usarCrudaCocida ? cantCruda : cantidadInicial,
                        cantidadCocida: usarCrudaCocida ? cantCocida : 0,
                        fechaActualizacion: new Date().toISOString()
                    };
                } else {
                    saldos[index] = {
                        id: saldoEnEdicion,
                        nombre, categoria, unidad: saldos[index].unidad, stockMinimo: stockMin,
                        cantidad: cantidadInicial,
                        fechaActualizacion: new Date().toISOString()
                    };
                }
                mostrarAlerta('‚úÖ Actualizado', 'success');
            } else {
                let unidadDefault = 'kg';
                if (categoria === 'gaseosas' || categoria === 'cervezas') unidadDefault = 'und';
                if (categoria === 'papeleria') unidadDefault = 'und';
                if (categoria === 'proteinas') {
                    const cantCruda = parseFloat(document.getElementById('saldo-cant-cruda').value) || 0;
                    const cantCocida = parseFloat(document.getElementById('saldo-cant-cocida').value) || 0;
                    const usarCrudaCocida = cantCruda > 0 || cantCocida > 0;
                    saldos.push({
                        id: 'saldo_' + Date.now(),
                        nombre, categoria, unidad: unidadDefault, stockMinimo: stockMin,
                        cantidadCruda: usarCrudaCocida ? cantCruda : cantidadInicial,
                        cantidadCocida: usarCrudaCocida ? cantCocida : 0,
                        fechaCreacion: new Date().toISOString()
                    });
                } else {
                    saldos.push({
                        id: 'saldo_' + Date.now(),
                        nombre, categoria, unidad: unidadDefault, stockMinimo: stockMin,
                        cantidad: cantidadInicial,
                        fechaCreacion: new Date().toISOString()
                    });
                }
                mostrarAlerta('‚úÖ Agregado', 'success');
            }
            guardarDatos();
            let saldoGuardado;
            if (saldoEnEdicion) {
                saldoGuardado = saldos.find(s => s.id === saldoEnEdicion);
            } else {
                saldoGuardado = saldos[saldos.length - 1];
            }
            if (saldoGuardado) {
                enviarSaldoAGoogleSheets(saldoGuardado);
            }
            cerrarModalSaldo();
            actualizarSaldos();
            actualizarSelectos();
        }

        function abrirEliminarSaldo(id) {
            const saldo = saldos.find(s => s.id === id);
            if (confirm(`¬øEliminar "${saldo.nombre}"?`)) {
                saldos = saldos.filter(s => s.id !== id);
                guardarDatos();
                mostrarAlerta('‚úÖ Eliminado', 'success');
                actualizarSaldos();
                actualizarSelectos();
            }
        }

        function cerrarModalSaldo() {
            document.getElementById('modalSaldo').classList.remove('active');
        }

        function abrirNuevoProductoEntrada() {
            document.getElementById('prod-rapido-nombre').value = '';
            document.getElementById('prod-rapido-categoria').value = '';
            document.getElementById('prod-rapido-minimo').value = '0';
            document.getElementById('modalNuevoProducto').classList.add('active');
        }

        function abrirNuevoProductoSalida() {
            abrirNuevoProductoEntrada();
        }

        function cerrarModalNuevoProducto() {
            document.getElementById('modalNuevoProducto').classList.remove('active');
        }

        function guardarProductoRapido() {
            const nombre = document.getElementById('prod-rapido-nombre').value.trim();
            const categoria = document.getElementById('prod-rapido-categoria').value;
            const minimo = parseFloat(document.getElementById('prod-rapido-minimo').value) || 0;
            if (!nombre || !categoria) {
                mostrarAlerta('‚ö†Ô∏è Completa nombre y categor√≠a', 'error');
                return;
            }
            let unidad = 'kg';
            if (categoria === 'gaseosas' || categoria === 'cervezas' || categoria === 'papeleria') {
                unidad = 'und';
            }
            const nuevoSaldo = {
                id: 'saldo_' + Date.now(),
                nombre,
                categoria,
                unidad,
                stockMinimo: minimo,
                cantidad: 0,
                fechaCreacion: new Date().toISOString()
            };
            saldos.push(nuevoSaldo);
            guardarDatos();
            enviarSaldoAGoogleSheets(nuevoSaldo);
            actualizarSelectos();
            mostrarAlerta('‚úÖ Producto creado', 'success');
            cerrarModalNuevoProducto();
        }

        function abrirNuevoProveedor() {
            document.getElementById('prov-rapido-nombre').value = '';
            document.getElementById('prov-rapido-telefono').value = '';
            document.getElementById('modalNuevoProveedor').classList.add('active');
        }

        function cerrarModalNuevoProveedor() {
            document.getElementById('modalNuevoProveedor').classList.remove('active');
        }

        function guardarProveedorRapido() {
            const nombre = document.getElementById('prov-rapido-nombre').value.trim();
            const telefono = document.getElementById('prov-rapido-telefono').value.trim();
            if (!nombre) {
                mostrarAlerta('‚ö†Ô∏è Ingresa nombre del proveedor', 'error');
                return;
            }
            const nuevoProveedor = {
                id: 'prov_' + Date.now(),
                nombre,
                telefono,
                observaciones: '',
                fechaCreacion: new Date().toISOString()
            };
            proveedores.push(nuevoProveedor);
            guardarDatos();
            actualizarSelectos();
            mostrarAlerta('‚úÖ Proveedor creado', 'success');
            cerrarModalNuevoProveedor();
        }

        function agregarResponsable() {
            const nombre = document.getElementById('nuevo-responsable').value.trim();
            if (!nombre) { mostrarAlerta('‚ö†Ô∏è Ingresa nombre', 'error'); return; }
            if (responsables.includes(nombre)) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }
            responsables.push(nombre);
            guardarDatos();
            document.getElementById('nuevo-responsable').value = '';
            actualizarListaResponsables();
            actualizarSelectos();
            mostrarAlerta('‚úÖ Agregado', 'success');
        }

        function eliminarResponsable(nombre) {
            if (confirm(`¬øEliminar "${nombre}"?`)) {
                responsables = responsables.filter(r => r !== nombre);
                guardarDatos();
                actualizarListaResponsables();
                actualizarSelectos();
                mostrarAlerta('‚úÖ Eliminado', 'success');
            }
        }

        function actualizarListaResponsables() {
            const lista = document.getElementById('lista-responsables');
            if (responsables.length === 0) {
                lista.innerHTML = '<p style="color: #999;">Sin responsables</p>';
                return;
            }
            lista.innerHTML = responsables.map(r => `<div class="area-saldos" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;"><div style="font-weight: 600;">üë§ ${r}</div><button class="btn btn-small btn-delete" onclick="eliminarResponsable('${r}')">üóëÔ∏è</button></div>`).join('');
        }

        function agregarCategoria() {
            const nombre = document.getElementById('nueva-categoria').value.trim();
            if (!nombre) { mostrarAlerta('‚ö†Ô∏è Ingresa nombre', 'error'); return; }
            const key = nombre.toLowerCase().replace(/\s+/g, '-');
            if (categorias[key]) { mostrarAlerta('‚ö†Ô∏è Ya existe', 'error'); return; }
            categorias[key] = 'üìå ' + nombre;
            guardarDatos();
            document.getElementById('nueva-categoria').value = '';
            actualizarListaCategorias();
            actualizarSelectoCategorias();
            mostrarAlerta('‚úÖ Agregada', 'success');
        }

        function eliminarCategoria(key) {
            if (saldos.some(s => s.categoria === key)) {
                mostrarAlerta('‚ö†Ô∏è Tiene productos', 'error');
                return;
            }
            if (confirm(`¬øEliminar?`)) {
                delete categorias[key];
                guardarDatos();
                actualizarListaCategorias();
                actualizarSelectoCategorias();
                mostrarAlerta('‚úÖ Eliminada', 'success');
            }
        }

        function actualizarListaCategorias() {
            const lista = document.getElementById('lista-categorias');
            lista.innerHTML = Object.entries(categorias).map(([key, nombre]) => `<div class="area-saldos" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;"><div style="font-weight: 600;">${nombre}</div><button class="btn btn-small btn-delete" onclick="eliminarCategoria('${key}')">üóëÔ∏è</button></div>`).join('');
        }

        function actualizarSelectoCategorias() {
            const select = document.getElementById('saldo-categoria');
            const selectRapido = document.getElementById('prod-rapido-categoria');
            const opciones = '<option value="">-- Selecciona --</option>' +
                Object.entries(categorias).map(([key, nombre]) => `<option value="${key}">${nombre}</option>`).join('');
            select.innerHTML = opciones;
            if (selectRapido) selectRapido.innerHTML = opciones;
        }

        async function enviarSaldoAGoogleSheets(saldo) {
            try {
                const datos = {
                    action: 'addMovimiento',
                    nombre: saldo.nombre,
                    categoria: saldo.categoria,
                    unidad: saldo.unidad,
                    stockMinimo: saldo.stockMinimo,
                    cantidad: saldo.cantidad || 0,
                    cantidadCruda: saldo.cantidadCruda || 0,
                    cantidadCocida: saldo.cantidadCocida || 0,
                    usuario: usuarioActual.nombre,
                    timestamp: new Date().toISOString(),
                    esSaldoInicial: true
                };
                const respuesta = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify(datos),
                    mode: 'no-cors'
                });
                const saldoSync = {
                    ...saldo,
                    sincronizado: true,
                    fechaSincronizacion: new Date().toISOString()
                };
                const indice = saldos.findIndex(s => s.id === saldo.id);
                if (indice !== -1) {
                    saldos[indice] = saldoSync;
                    guardarDatos();
                }
                productosNoSincronizados = productosNoSincronizados.filter(p => p.id !== saldo.id);
                console.log('‚úÖ Saldo sincronizado:', datos);
                return true;
            } catch(error) {
                console.error('‚ö†Ô∏è Error al sincronizar saldo:', error);
                if (!productosNoSincronizados.find(p => p.id === saldo.id)) {
                    productosNoSincronizados.push(saldo);
                }
                return false;
            }
        }

        async function sincronizarTodosSaldos() {
            if (saldos.length === 0) {
                mostrarAlerta('‚ö†Ô∏è No hay productos para sincronizar', 'error');
                return;
            }
            mostrarAlerta('‚è≥ Sincronizando ' + saldos.length + ' productos...', 'success');
            let sincronizados = 0;
            let fallidos = 0;
            for (const saldo of saldos) {
                const resultado = await enviarSaldoAGoogleSheets(saldo);
                if (resultado) {
                    sincronizados++;
                } else {
                    fallidos++;
                }
                mostrarAlerta(`‚è≥ Progreso: ${sincronizados}/${saldos.length} (${fallidos} pendientes)`, 'info');
            }
            ultimaSincronizacion = new Date().toISOString();
            if (fallidos > 0) {
                mostrarAlerta(`‚úÖ ${sincronizados}/${saldos.length} sincronizados. ${fallidos} en cola para reintentar.`, 'warning');
            } else {
                mostrarAlerta(`‚úÖ ¬°${sincronizados} productos sincronizados correctamente!`, 'success');
            }
        }

        function actualizarIndicadoresSincronizacion() {
            const sincronizados = saldos.filter(s => s.sincronizado).length;
            const total = 31;
            document.getElementById('indicador-sincronizacion').textContent = `Sincronizados: ${sincronizados}/${total}`;
            const statusDiv = document.getElementById('status-sync');
            if (estadoConexion) {
                document.getElementById('indicador-conexion').textContent = '‚úÖ En l√≠nea';
                if (sincronizados === total) {
                    statusDiv.style.background = '#d4edda';
                    statusDiv.style.color = '#155724';
                } else {
                    statusDiv.style.background = '#fff3cd';
                    statusDiv.style.color = '#856404';
                }
            } else {
                document.getElementById('indicador-conexion').textContent = '‚ö†Ô∏è Sin conexi√≥n';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
            }
        }

        function detectarConexion() {
            window.addEventListener('online', async () => {
                console.log('üì° Reconexi√≥n detectada. Reintentando sincronizaci√≥n...');
                estadoConexion = true;
                actualizarIndicadoresSincronizacion();
                mostrarAlerta('üì° Conectado. Reintentando sincronizaci√≥n...', 'info');
                if (productosNoSincronizados.length > 0) {
                    for (const producto of productosNoSincronizados) {
                        await enviarSaldoAGoogleSheets(producto);
                        actualizarIndicadoresSincronizacion();
                    }
                }
            });
            window.addEventListener('offline', () => {
                console.log('‚ö†Ô∏è Modo offline detectado');
                estadoConexion = false;
                actualizarIndicadoresSincronizacion();
                mostrarAlerta('‚ö†Ô∏è Trabajando sin conexi√≥n. Los cambios se sincronizar√°n despu√©s.', 'warning');
            });
        }

        async function enviarAGoogleSheets(movimiento) {
            try {
                const saldo = saldos.find(s => s.id === movimiento.producto);
                const proveedor = proveedores.find(p => p.id === movimiento.proveedor);
                const datos = {
                    action: 'addMovimiento',
                    fecha: movimiento.fecha || new Date().toISOString().split('T')[0],
                    hora: movimiento.hora || new Date().toTimeString().slice(0, 5),
                    tipo: movimiento.tipo || 'entrada',
                    producto: saldo?.nombre || movimiento.producto || '',
                    cantidadCruda: Number(movimiento.cantidadCruda) || 0,
                    cantidadCocida: Number(movimiento.cantidadCocida) || 0,
                    estado: movimiento.estado || '',
                    responsable: movimiento.responsable || '',
                    destino: movimiento.destino || '',
                    tipoEntrada: movimiento.tipoEntrada || '',
                    proveedor: proveedor?.nombre || movimiento.proveedor || '',
                    valor: Number(movimiento.totalCosto) || 0
                };
                console.log('üì§ ENVIANDO A GOOGLE:', datos);
                const response = await fetch(GOOGLE_SHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify(datos),
                    mode: 'no-cors'
                });
                console.log('‚úÖ Respuesta:', response.status);
            } catch(error) {
                console.error('‚ùå Error al enviar:', error);
            }
        }

        function actualizarEstadoEntrada() {
            const productoId = document.getElementById('producto-entrada').value;
            const saldo = saldos.find(s => s.id === productoId);
            const esProteina = saldo?.categoria?.includes('üçñ');
            console.log('DEBUG Entrada:', {producto: saldo?.nombre, categoria: saldo?.categoria, esProteina});
            document.getElementById('estado-entrada-grupo').style.display = esProteina ? 'block' : 'none';
        }

        function seleccionarEstadoEntrada(estado) {
            document.getElementById('estado-entrada').value = estado;
            document.querySelectorAll('#estado-entrada-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarEntrada() {
            const tipoEntrada = 'compra';
            const proveedor = document.getElementById('proveedor-entrada').value;
            const producto = document.getElementById('producto-entrada').value;
            const cantidad = parseFloat(document.getElementById('cantidad-entrada').value);
            const costo = parseFloat(document.getElementById('costo-entrada').value);
            const responsable = document.getElementById('responsable-entrada').value;
            const saldo = saldos.find(s => s.id === producto);
            if (!proveedor || !producto || isNaN(cantidad) || isNaN(costo) || !responsable) {
                mostrarAlerta('‚ö†Ô∏è Completa campos', 'error');
                return;
            }
            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date().toTimeString().slice(0, 5);
            const esProteina = saldo?.categoria?.includes('üçñ');
            const estado = esProteina ? document.getElementById('estado-entrada').value : '';
            let cantidadCruda = 0, cantidadCocida = 0;
            if (esProteina) {
                if (estado === 'crudo') {
                    cantidadCruda = cantidad;
                } else {
                    cantidadCocida = cantidad;
                }
            } else {
                cantidadCruda = cantidad;
            }
            movimientos.push({
                id: 'mov_' + Date.now(),
                tipo: 'entrada',
                tipoEntrada,
                proveedor,
                producto,
                cantidad,
                cantidadCruda,
                cantidadCocida,
                costo,
                totalCosto: cantidad * costo,
                estado,
                fecha: hoy,
                hora: ahora,
                responsable,
                timestamp: new Date().toISOString()
            });
            const ultimoMovimiento = movimientos[movimientos.length - 1];
            guardarDatos();
            enviarAGoogleSheets(ultimoMovimiento);
            mostrarAlerta('‚úÖ Registrada', 'success');
            limpiarFormEntrada();
            actualizarSaldos();
            actualizarListaEntradas();
        }

        function actualizarListaEntradas() {
            const lista = document.getElementById('lista-entradas');
            const ultimas = movimientos.filter(m => m.tipo === 'entrada').slice(-5).reverse();
            if (ultimas.length === 0) {
                lista.innerHTML = '<p style="color: #999;">Sin entradas</p>';
                return;
            }
            lista.innerHTML = ultimas.map(mov => {
                const saldo = saldos.find(s => s.id === mov.producto);
                const prov = proveedores.find(p => p.id === mov.proveedor);
                return `<div class="area-saldos" style="padding: 8px; margin-bottom: 6px;"><div style="font-weight: 600; font-size: 11px;">${saldo?.nombre}</div><div style="font-size: 9px; color: #666;">${mov.cantidad} ${saldo?.unidad} | ${mov.estado || ''} | ${prov?.nombre}</div></div>`;
            }).join('');
        }

        function limpiarFormEntrada() {
            document.getElementById('producto-entrada').value = '';
            document.getElementById('cantidad-entrada').value = '';
            document.getElementById('costo-entrada').value = '';
        }

        function actualizarEstadoSalida() {
            const productoId = document.getElementById('producto-salida').value;
            const saldo = saldos.find(s => s.id === productoId);
            const esProteina = saldo?.categoria?.includes('üçñ');
            document.getElementById('estado-salida-grupo').style.display = esProteina ? 'block' : 'none';
        }

        function seleccionarEstadoSalida(estado) {
            document.getElementById('estado-salida').value = estado;
            document.querySelectorAll('#estado-salida-grupo .estado-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        function registrarSalida() {
            const destino = document.getElementById('destino-salida').value;
            const producto = document.getElementById('producto-salida').value;
            const cantidad = parseFloat(document.getElementById('cantidad-salida').value);
            const responsable = document.getElementById('responsable-salida').value;
            const saldo = saldos.find(s => s.id === producto);
            if (!destino || !producto || isNaN(cantidad) || !responsable) {
                mostrarAlerta('‚ö†Ô∏è Completa campos', 'error');
                return;
            }
            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date().toTimeString().slice(0, 5);
            const esProteina = saldo?.categoria?.includes('üçñ');
            const estado = esProteina ? document.getElementById('estado-salida').value : '';
            let saldoActual = 0;
            if (esProteina) {
                saldoActual = estado === 'crudo' ? calcularSaldoCrudo(producto) : calcularSaldoCocido(producto);
            } else {
                saldoActual = calcularSaldoActual(producto);
            }
            if (cantidad > saldoActual) {
                mostrarAlerta(`‚ö†Ô∏è Stock insuficiente: ${saldoActual}`, 'error');
                return;
            }
            let cantidadCruda = 0, cantidadCocida = 0;
            if (esProteina) {
                if (estado === 'crudo') {
                    cantidadCruda = cantidad;
                } else {
                    cantidadCocida = cantidad;
                }
            } else {
                cantidadCruda = cantidad;
            }
            movimientos.push({
                id: 'mov_' + Date.now(),
                tipo: 'salida',
                destino,
                producto,
                cantidad,
                cantidadCruda,
                cantidadCocida,
                estado,
                fecha: hoy,
                hora: ahora,
                responsable,
                timestamp: new Date().toISOString()
            });
            const ultimoMovimiento = movimientos[movimientos.length - 1];
            guardarDatos();
            enviarAGoogleSheets(ultimoMovimiento);
            mostrarAlerta('‚úÖ Registrada', 'success');
            limpiarFormSalida();
            actualizarSaldos();
            actualizarListaSalidas();
        }

        function actualizarListaSalidas() {
            const lista = document.getElementById('lista-salidas');
            const ultimas = movimientos.filter(m => m.tipo === 'salida').slice(-5).reverse();
            if (ultimas.length === 0) {
                lista.innerHTML = '<p style="color: #999;">Sin salidas</p>';
                return;
            }
            const destinos = {'cocina': 'üë®‚Äçüç≥', 'barril': 'üçñ', 'caja': 'üí∞', 'consumo': 'ü•ò', 'barril-venta': 'üíµ', 'merma': 'üìâ', 'danio': 'üî•'};
            lista.innerHTML = ultimas.map(mov => {
                const saldo = saldos.find(s => s.id === mov.producto);
                return `<div class="area-saldos" style="padding: 8px; margin-bottom: 6px;"><div style="font-weight: 600; font-size: 11px;">${saldo?.nombre}</div><div style="font-size: 9px; color: #666;">${destinos[mov.destino] || 'üìç'} ${mov.cantidad} ${saldo?.unidad} | ${mov.estado || ''}</div></div>`;
            }).join('');
        }

        function limpiarFormSalida() {
            document.getElementById('producto-salida').value = '';
            document.getElementById('cantidad-salida').value = '';
        }

        function actualizarReportes() {
            const desde = document.getElementById('fecha-desde').value;
            const hasta = document.getElementById('fecha-hasta').value;
            const movsFiltrados = !desde || !hasta ? movimientos : movimientos.filter(m => m.fecha >= desde && m.fecha <= hasta);
            const alertasDiv = document.getElementById('alertas-stock');
            const alertas = saldos.filter(s => {
                const total = (s.categoria === 'proteinas') ? (calcularSaldoCrudo(s.id) + calcularSaldoCocido(s.id)) : calcularSaldoActual(s.id);
                return total < (s.stockMinimo || 0);
            });
            alertasDiv.innerHTML = alertas.length === 0 ? '<div style="color: #28a745; font-weight: 600;">‚úÖ Sin alertas</div>' : alertas.map(s => {
                const total = (s.categoria === 'proteinas') ? (calcularSaldoCrudo(s.id) + calcularSaldoCocido(s.id)) : calcularSaldoActual(s.id);
                return `<div class="resumen-box"><strong>${s.nombre}</strong><br>Stock: ${total.toFixed(2)} | M√≠n: ${s.stockMinimo}</div>`;
            }).join('');
            const costosDiv = document.getElementById('resumen-costos');
            let costoTotal = 0;
            const costosPorCat = {};
            movsFiltrados.filter(m => m.tipo === 'entrada').forEach(mov => {
                const saldo = saldos.find(s => s.id === mov.producto);
                const cat = saldo?.categoria || 'otros';
                if (!costosPorCat[cat]) costosPorCat[cat] = 0;
                costosPorCat[cat] += mov.totalCosto || 0;
                costoTotal += mov.totalCosto || 0;
            });
            costosDiv.innerHTML = `<div class="resumen-box"><div class="resumen-titulo">TOTAL INVERTIDO: $${costoTotal.toLocaleString('es-CO')}</div>${Object.entries(costosPorCat).map(([cat, costo]) => `<div class="resumen-item"><span>${categorias[cat] || cat}</span><span class="resumen-valor">$${costo.toLocaleString('es-CO')}</span></div>`).join('')}</div>`;
            const stockDiv = document.getElementById('tabla-stock-actual');
            const proteinas = saldos.filter(s => s.categoria === 'proteinas');
            const otros = saldos.filter(s => s.categoria !== 'proteinas');
            let html = '';
            if (proteinas.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #8B0000; margin-bottom: 10px;">üçñ PROTE√çNAS</h4>';
                html += '<table class="tabla-reportes"><thead><tr><th>Producto</th><th>Cruda (kg) üîµ</th><th>Cocida (kg) üî¥</th><th>Total</th></tr></thead><tbody>';
                proteinas.forEach(s => {
                    const cruda = calcularSaldoCrudo(s.id).toFixed(2);
                    const cocida = calcularSaldoCocido(s.id).toFixed(2);
                    const total = (parseFloat(cruda) + parseFloat(cocida)).toFixed(2);
                    html += `<tr style="${parseFloat(total) < s.stockMinimo ? 'background: #fff3cd;' : ''}"><td><strong>${s.nombre}</strong></td><td style="text-align: center; color: #0066cc;">${cruda}</td><td style="text-align: center; color: #cc0000;">${cocida}</td><td style="text-align: center; font-weight: bold;">${total} ${s.unidad}</td></tr>`;
                });
                html += '</tbody></table></div>';
            }
            if (otros.length > 0) {
                html += '<div><h4 style="color: #666; margin-bottom: 10px;">üì¶ OTROS PRODUCTOS</h4>';
                html += '<table class="tabla-reportes"><thead><tr><th>Producto</th><th>Categor√≠a</th><th>Stock</th></tr></thead><tbody>';
                otros.forEach(s => {
                    const total = calcularSaldoActual(s.id).toFixed(2);
                    html += `<tr style="${parseFloat(total) < s.stockMinimo ? 'background: #fff3cd;' : ''}"><td><strong>${s.nombre}</strong></td><td>${categorias[s.categoria]}</td><td style="text-align: center; font-weight: bold;">${total} ${s.unidad}</td></tr>`;
                });
                html += '</tbody></table></div>';
            }
            stockDiv.innerHTML = html;
            const movsDiv = document.getElementById('tabla-movimientos');
            html = '<table class="tabla-reportes"><thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cantidad</th><th>Responsable</th></tr></thead><tbody>';
            movsFiltrados.slice().reverse().forEach(mov => {
                const saldo = saldos.find(s => s.id === mov.producto);
                const tipo = mov.tipo === 'entrada' ? 'üì•' : 'üì§';
                html += `<tr><td>${mov.fecha} ${mov.hora}</td><td>${tipo}</td><td>${saldo?.nombre}</td><td>${mov.cantidad} ${mov.estado || ''}</td><td>${mov.responsable}</td></tr>`;
            });
            html += '</tbody></table>';
            movsDiv.innerHTML = html;
        }

        async function descargarExcel() {
            try {
                mostrarAlerta('‚è≥ Generando EXCEL...', 'success');
                const desde = document.getElementById('fecha-desde').value;
                const hasta = document.getElementById('fecha-hasta').value;
                const movsFiltrados = movimientos.filter(m => m.fecha >= desde && m.fecha <= hasta);
                const stockData = saldos.map(s => ({
                    Producto: s.nombre,
                    Categor√≠a: categorias[s.categoria] || s.categoria,
                    Stock: (s.categoria === 'proteinas') ? (calcularSaldoCrudo(s.id) + calcularSaldoCocido(s.id)).toFixed(2) : calcularSaldoActual(s.id).toFixed(2),
                    Unidad: s.unidad,
                    M√≠nimo: s.stockMinimo
                }));
                const movsData = movsFiltrados.map(m => ({
                    Fecha: m.fecha,
                    Hora: m.hora,
                    Tipo: m.tipo,
                    'Destino/Origen': m.destino || m.tipoEntrada || '',
                    Producto: saldos.find(s => s.id === m.producto)?.nombre || '',
                    Cantidad: m.cantidad,
                    Estado: m.estado || '',
                    Responsable: m.responsable,
                    Costo: m.totalCosto || '',
                    Proveedor: m.proveedor ? proveedores.find(p => p.id === m.proveedor)?.nombre || '' : ''
                }));
                const sheet1XML = arrayToXML(stockData, 'Stock Actual');
                const sheet2XML = arrayToXML(movsData, 'Movimientos');
                const zip = new JSZip();
                zip.file('[Content_Types].xml', getContentTypesXML());
                zip.file('_rels/.rels', getRelsXML());
                zip.file('xl/_rels/workbook.xml.rels', getWorkbookRelsXML());
                zip.file('xl/workbook.xml', getWorkbookXML());
                zip.file('xl/worksheets/sheet1.xml', sheet1XML);
                zip.file('xl/worksheets/sheet2.xml', sheet2XML);
                zip.file('xl/theme/theme1.xml', getThemeXML());
                zip.file('docProps/core.xml', getCorePropsXML());
                const content = await zip.generateAsync({type: 'blob'});
                const url = URL.createObjectURL(content);
                const link = document.createElement('a');
                link.href = url;
                link.download = `Rinc√≥n_Barril_${desde}_a_${hasta}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                mostrarAlerta('‚úÖ EXCEL descargado correctamente', 'success');
            } catch (error) {
                console.error(error);
                mostrarAlerta('‚ùå Error: ' + error.message, 'error');
            }
        }

        function arrayToXML(data, sheetName) {
            if (!data || data.length === 0) {
                data = [{resultado: 'Sin datos'}];
            }
            const headers = Object.keys(data[0]);
            let xml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n<sheetData>\n<row r="1">`;
            headers.forEach((h, i) => {
                xml += `<c r="${String.fromCharCode(65+i)}1" t="inlineStr"><is><t>${escapeXML(h)}</t></is></c>`;
            });
            xml += `</row>`;
            data.forEach((row, rowIdx) => {
                xml += `<row r="${rowIdx + 2}">`;
                headers.forEach((h, colIdx) => {
                    const val = row[h] || '';
                    xml += `<c r="${String.fromCharCode(65+colIdx)}${rowIdx + 2}" t="inlineStr"><is><t>${escapeXML(String(val))}</t></is></c>`;
                });
                xml += `</row>`;
            });
            xml += `</sheetData></worksheet>`;
            return xml;
        }

        function escapeXML(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
        }

        function getContentTypesXML() {
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n<Default Extension="xml" ContentType="application/xml"/>\n<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>\n<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n<Override PartName="/xl/worksheets/sheet2.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>\n<Override PartName="/xl/theme/theme1.xml" ContentType="application/vnd.openxmlformats-officedocument.theme+xml"/>\n<Override PartName="/docProps/core.xml" ContentType="application/vnd.openxmlformats-package.core-properties+xml"/>\n</Types>`;
        }

        function getRelsXML() {
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>\n<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/package/2006/relationships/metadata/core-properties" Target="docProps/core.xml"/>\n</Relationships>`;
        }

        function getWorkbookRelsXML() {
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>\n<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet2.xml"/>\n<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme" Target="theme/theme1.xml"/>\n</Relationships>`;
        }

        function getWorkbookXML() {
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">\n<sheets>\n<sheet name="Stock Actual" sheetId="1" r:id="rId1" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>\n<sheet name="Movimientos" sheetId="2" r:id="rId2" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"/>\n</sheets>\n</workbook>`;
        }

        function getThemeXML() {
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<a:theme xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main" name="Office"><a:themeElements/></a:theme>`;
        }

        function getCorePropsXML() {
            const now = new Date().toISOString();
            return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/officeDocument/2006/custom-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:dcmitype="http://purl.org/dc/dcmitype/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">\n<dc:title>Rinc√≥n del Barril</dc:title>\n<dc:creator>Sistema Gesti√≥n</dc:creator>\n<cp:lastModifiedBy>Sistema</cp:lastModifiedBy>\n<dcterms:created xsi:type="dcterms:W3CDTF">${now}</dcterms:created>\n<dcterms:modified xsi:type="dcterms:W3CDTF">${now}</dcterms:modified>\n</cp:coreProperties>`;
        }

        function actualizarSelectos() {
            const opcionesProductos = saldos.map(s => `<option value="${s.id}">${s.nombre}</option>`).join('');
            const opcionesProveedores = proveedores.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            const opcionesResponsables = responsables.map(r => `<option value="${r}">${r}</option>`).join('');
            document.getElementById('producto-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + opcionesProductos;
            document.getElementById('producto-salida').innerHTML = '<option value="">-- Selecciona --</option>' + opcionesProductos;
            document.getElementById('proveedor-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + opcionesProveedores;
            document.getElementById('responsable-entrada').innerHTML = '<option value="">-- Selecciona --</option>' + opcionesResponsables;
            document.getElementById('responsable-salida').innerHTML = '<option value="">-- Selecciona --</option>' + opcionesResponsables;
        }

        function mostrarAlerta(mensaje, tipo) {
            const alertaDiv = document.getElementById('alerta');
            alertaDiv.innerHTML = `<div class="alerta ${tipo}">${mensaje}</div>`;
            setTimeout(() => { alertaDiv.innerHTML = ''; }, 3000);
        }

        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            if (tab === 'reportes') {
                actualizarReportes();
            }
        }

        function verificarModoArchivo() {
            if (window.location.protocol === 'file:') {
                const alerta = document.createElement('div');
                alerta.style.cssText = `position: fixed; top: 0; left: 0; right: 0; background: #ff6b6b; color: white; padding: 15px; text-align: center; font-weight: 600; z-index: 9999; border-bottom: 3px solid #d32f2f;`;
                alerta.innerHTML = `‚ö†Ô∏è ATENCI√ìN: Est√°s usando archivo local. Los datos NO persisten entre sesiones.<br><small style="display: block; margin-top: 5px;">Soluci√≥n: Usa servidor local (iniciar_servidor.bat/sh) o Google Drive</small>`;
                document.body.insertBefore(alerta, document.body.firstChild);
                document.body.style.paddingTop = '60px';
            }
        }

        window.addEventListener('load', function() {
            verificarModoArchivo();
            inicializar();
        });
    </script>
</body>
</html>
