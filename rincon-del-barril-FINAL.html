<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>El Rinc√≥n del Barril - Plan de Saneamiento y Mantenimiento</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  overflow: hidden;
}
.header {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  color: white;
  padding: 30px;
  text-align: center;
}
.header h1 { font-size: 28px; margin-bottom: 10px; }
.tabs {
  display: flex;
  background: #f0f0f0;
  border-bottom: 2px solid #ddd;
  overflow-x: auto;
}
.tab {
  padding: 15px 20px;
  cursor: pointer;
  border: none;
  background: transparent;
  font-size: 14px;
  font-weight: 600;
  color: #666;
  white-space: nowrap;
}
.tab.active {
  background: white;
  color: #2a5298;
  border-bottom: 3px solid #2a5298;
}
.tab-content {
  display: none;
  padding: 30px;
}
.tab-content.active { display: block; }
.form-group {
  margin-bottom: 15px;
}
label {
  display: block;
  font-weight: 600;
  margin-bottom: 5px;
  color: #333;
}
input, select {
  width: 100%;
  padding: 10px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}
.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
}
@media (max-width: 768px) {
  .form-row { grid-template-columns: 1fr; }
}
table {
  width: 100%;
  border-collapse: collapse;
  margin: 20px 0;
}
th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}
th {
  background: #f5f5f5;
  font-weight: 600;
}
.badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}
.badge-ok { background: #d4edda; color: #155724; }
.badge-warning { background: #fff3cd; color: #856404; }
.badge-danger { background: #f8d7da; color: #721c24; }
.badge-info { background: #d1ecf1; color: #0c5460; }
.search-box {
  margin-bottom: 20px;
}
.search-box input {
  width: 100%;
  padding: 12px;
  border: 2px solid #ddd;
  border-radius: 6px;
  font-size: 16px;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  margin-right: 10px;
  margin-top: 10px;
}
.btn-primary { background: #4CAF50; color: white; }
.btn-secondary { background: #2196F3; color: white; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.btn-warning { background: #ffc107; color: #333; }
.btn-small { padding: 6px 12px; font-size: 12px; }
.alert {
  padding: 15px;
  margin-bottom: 20px;
  border-radius: 6px;
  background: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}
.alert-warning {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}
.conteo-card {
  background: #f9f9f9;
  border: 1px solid #ddd;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 6px;
}
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin: 20px 0;
}
.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
}
.stat-number {
  font-size: 36px;
  font-weight: 700;
  display: block;
}
.stat-label {
  font-size: 14px;
  opacity: 0.9;
  margin-top: 5px;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üè™ El Rinc√≥n del Barril</h1>
    <p>Plan de Saneamiento y Mantenimiento - Control de Utensilios</p>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('utensilios')">üî™ Utensilios</button>
    <button class="tab" onclick="showTab('agregar')">‚ûï Agregar Utensilio</button>
    <button class="tab" onclick="showTab('conteo')">üìä Hacer Conteo</button>
    <button class="tab" onclick="showTab('historial')">üìã Historial</button>
    <button class="tab" onclick="showTab('resumen')">üìà Resumen</button>
  </div>

  <!-- TAB: LISTA DE UTENSILIOS -->
  <div id="utensilios" class="tab-content active">
    <h2>üî™ Inventario de Utensilios</h2>
    
    <div class="search-box">
      <input type="text" id="searchUtensilios" placeholder="üîç Buscar por nombre o √°rea..." oninput="filtrarUtensilios()">
    </div>

    <table id="tablaUtensilios">
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Nombre</th>
          <th>√Årea</th>
          <th>Stock</th>
          <th>M√≠nimo</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="bodyUtensilios">
      </tbody>
    </table>

    <button onclick="exportarUtensilios()" class="btn btn-secondary">üì• Exportar a Excel</button>
  </div>

  <!-- TAB: AGREGAR/EDITAR UTENSILIO -->
  <div id="agregar" class="tab-content">
    <button onclick="volverInicio()" class="btn btn-secondary" style="margin-bottom: 20px;">‚Üê Volver al Inicio</button>
    
    <h2 id="tituloFormUtensilio">‚ûï Agregar Nuevo Utensilio</h2>
    
    <form id="formUtensilio" onsubmit="guardarUtensilio(event)">
      <input type="hidden" id="editandoCodigo">
      
      <div class="form-group">
        <label>C√≥digo (auto-generado)</label>
        <input type="text" id="codigoUtensilio" readonly style="background: #f0f0f0;">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Nombre del utensilio *</label>
          <input type="text" id="nombreUtensilio" placeholder="Ej: Copas largas" required>
        </div>

        <div class="form-group">
          <label>√Årea *</label>
          <select id="areaUtensilio" required>
            <option value="">Selecciona...</option>
            <option value="BARRA">BARRA</option>
            <option value="COCINA">COCINA</option>
            <option value="EQUIPOS">EQUIPOS</option>
            <option value="SERVICIO">SERVICIO</option>
            <option value="OTRO">OTRO</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Stock Base *</label>
          <input type="number" id="stockUtensilio" min="1" value="1" required>
        </div>

        <div class="form-group">
          <label>Cantidad M√≠nima *</label>
          <input type="number" id="minimoUtensilio" min="1" value="1" required>
        </div>
      </div>

      <div class="form-group">
        <label>Responsable del √°rea (opcional)</label>
        <input type="text" id="responsableUtensilio" placeholder="Ej: Mar√≠a">
      </div>

      <button type="submit" class="btn btn-primary">‚úì Guardar Utensilio</button>
      <button type="button" class="btn btn-secondary" onclick="cancelarEdicion()">‚úï Cancelar</button>
    </form>
  </div>

  <!-- TAB: HACER CONTEO -->
  <div id="conteo" class="tab-content">
    <button onclick="volverInicio()" class="btn btn-secondary" style="margin-bottom: 20px;">‚Üê Volver al Inicio</button>
    
    <h2 id="tituloConteo">üìä Realizar Conteo de Utensilios</h2>
    
    <input type="hidden" id="editandoConteoId">
    
    <div id="alertaEditandoConteo" class="alert alert-warning" style="display: none;">
      <strong>‚úèÔ∏è EDITANDO CONTEO:</strong> Est√°s modificando un conteo existente. Los cambios se guardar√°n sobre el conteo original.
      <button class="btn btn-danger btn-small" onclick="cancelarEdicionConteo()" style="float: right;">‚úï Cancelar Edici√≥n</button>
    </div>
    
    <div class="alert">
      <strong>üí° Instrucciones:</strong> Cuenta f√≠sicamente cada utensilio del establecimiento. Este conteo es parte del Plan de Saneamiento y Mantenimiento requerido por INVIMA. El sistema comparar√° autom√°ticamente con el stock base registrado.
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Responsable del conteo *</label>
        <input type="text" id="responsableConteo" placeholder="Tu nombre">
      </div>

      <div class="form-group">
        <label>Fecha</label>
        <input type="date" id="fechaConteo">
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="buscarEnConteo" placeholder="üîç Buscar utensilio..." oninput="filtrarConteo()">
    </div>

    <div id="listaConteo">
    </div>

    <button onclick="guardarConteoCompleto()" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 16px;">‚úì GUARDAR CONTEO</button>
  </div>

  <!-- TAB: HISTORIAL DE CONTEOS -->
  <div id="historial" class="tab-content">
    <button onclick="volverInicio()" class="btn btn-secondary" style="margin-bottom: 20px;">‚Üê Volver al Inicio</button>
    
    <h2>üìã Historial de Conteos</h2>
    
    <div id="listaHistorial">
    </div>
  </div>

  <!-- TAB: RESUMEN -->
  <div id="resumen" class="tab-content">
    <button onclick="volverInicio()" class="btn btn-secondary" style="margin-bottom: 20px;">‚Üê Volver al Inicio</button>
    
    <h2>üìà Resumen del Sistema</h2>
    
    <div class="stats">
      <div class="stat-card">
        <span class="stat-number" id="totalUtensilios">0</span>
        <span class="stat-label">Utensilios Registrados</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalConteos">0</span>
        <span class="stat-label">Conteos Realizados</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="totalAreas">0</span>
        <span class="stat-label">√Åreas</span>
      </div>
    </div>

    <h3 style="margin-top: 30px;">üì¶ Por √Årea:</h3>
    <div id="porArea" style="margin-top: 20px;"></div>

    <button onclick="resetearSistema()" class="btn btn-danger" style="margin-top: 30px;">üîÑ Resetear Sistema (Cuidado!)</button>
  </div>

</div>

<script>
// DATOS PRECARGADOS (mismo que antes)
const DATOS_INICIALES = {
  "utensilios": [{"codigo": "UT-001", "nombre": "Batidor", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-002", "nombre": "Copas larga", "area": "BARRA", "stock": 10, "minimo": 2, "responsable": ""}, {"codigo": "UT-003", "nombre": "Copas redondas", "area": "BARRA", "stock": 8, "minimo": 2, "responsable": ""}, {"codigo": "UT-004", "nombre": "Cuchara coctelera", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-005", "nombre": "Exprimidor", "area": "BARRA", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-006", "nombre": "Jarra grande", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-007", "nombre": "Jarras", "area": "BARRA", "stock": 5, "minimo": 2, "responsable": ""}, {"codigo": "UT-008", "nombre": "Martillo de hielo", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-009", "nombre": "Medidor de onzas", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-010", "nombre": "Pala para hielo", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-011", "nombre": "Pote azul agua", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-012", "nombre": "Pote transparente", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-013", "nombre": "Termo grande agua", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-014", "nombre": "Termo mediano hielo", "area": "BARRA", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-015", "nombre": "Vasos de vidrio", "area": "BARRA", "stock": 38, "minimo": 10, "responsable": ""}, {"codigo": "UT-016", "nombre": "Bandeja", "area": "COCINA", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-017", "nombre": "Bandejas metalicas", "area": "COCINA", "stock": 14, "minimo": 4, "responsable": ""}, {"codigo": "UT-018", "nombre": "Canasta grande", "area": "COCINA", "stock": 3, "minimo": 1, "responsable": ""}, {"codigo": "UT-019", "nombre": "Canasta peque√±a", "area": "COCINA", "stock": 8, "minimo": 4, "responsable": ""}, {"codigo": "UT-020", "nombre": "colador de aluminio", "area": "COCINA", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-021", "nombre": "Cucharas", "area": "COCINA", "stock": 31, "minimo": 15, "responsable": ""}, {"codigo": "UT-022", "nombre": "Cucharas peque√±as", "area": "COCINA", "stock": 18, "minimo": 10, "responsable": ""}, {"codigo": "UT-023", "nombre": "Cuchillos", "area": "COCINA", "stock": 37, "minimo": 15, "responsable": ""}, {"codigo": "UT-024", "nombre": "Plato negro de barro", "area": "COCINA", "stock": 4, "minimo": 2, "responsable": ""}, {"codigo": "UT-025", "nombre": "Plato negro plastico", "area": "COCINA", "stock": 11, "minimo": 5, "responsable": ""}, {"codigo": "UT-026", "nombre": "Platos de mute", "area": "COCINA", "stock": 23, "minimo": 10, "responsable": ""}, {"codigo": "UT-027", "nombre": "Platos hondos grandes", "area": "COCINA", "stock": 8, "minimo": 4, "responsable": ""}, {"codigo": "UT-028", "nombre": "Platos planos", "area": "COCINA", "stock": 16, "minimo": 8, "responsable": ""}, {"codigo": "UT-029", "nombre": "Salseros de aluminio", "area": "COCINA", "stock": 77, "minimo": 30, "responsable": ""}, {"codigo": "UT-030", "nombre": "Tablas", "area": "COCINA", "stock": 18, "minimo": 10, "responsable": ""}, {"codigo": "UT-031", "nombre": "Tenedores", "area": "COCINA", "stock": 29, "minimo": 15, "responsable": ""}, {"codigo": "UT-032", "nombre": "asadores", "area": "EQUIPOS", "stock": 3, "minimo": 2, "responsable": ""}, {"codigo": "UT-033", "nombre": "barriles", "area": "EQUIPOS", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-034", "nombre": "estantes", "area": "EQUIPOS", "stock": 3, "minimo": 1, "responsable": ""}, {"codigo": "UT-035", "nombre": "formador de hamburguesas", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-036", "nombre": "freidora", "area": "EQUIPOS", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-037", "nombre": "Licuadora", "area": "EQUIPOS", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-038", "nombre": "mesa metalica peque√±a", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-039", "nombre": "Mesa negra metal", "area": "EQUIPOS", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-040", "nombre": "Mesa negra pl√°stica", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-041", "nombre": "Mesa peque√±a", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-042", "nombre": "Mesas pl√°sticas", "area": "EQUIPOS", "stock": 10, "minimo": 5, "responsable": ""}, {"codigo": "UT-043", "nombre": "picadora", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-044", "nombre": "Sillas beis y rojas", "area": "EQUIPOS", "stock": 36, "minimo": 10, "responsable": ""}, {"codigo": "UT-045", "nombre": "Sillas negras", "area": "EQUIPOS", "stock": 4, "minimo": 2, "responsable": ""}, {"codigo": "UT-046", "nombre": "vascula 150kg", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-047", "nombre": "vascula digital grande", "area": "EQUIPOS", "stock": 2, "minimo": 1, "responsable": ""}, {"codigo": "UT-048", "nombre": "vascula digital peque√±a", "area": "EQUIPOS", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-049", "nombre": "Cubiertero grande", "area": "SERVICIO", "stock": 1, "minimo": 1, "responsable": ""}, {"codigo": "UT-050", "nombre": "Cubiertero negro", "area": "SERVICIO", "stock": 13, "minimo": 6, "responsable": ""}, {"codigo": "UT-051", "nombre": "Palillos", "area": "SERVICIO", "stock": 10, "minimo": 5, "responsable": ""}, {"codigo": "UT-052", "nombre": "Picantes", "area": "SERVICIO", "stock": 11, "minimo": 5, "responsable": ""}, {"codigo": "UT-053", "nombre": "Saleros", "area": "SERVICIO", "stock": 12, "minimo": 6, "responsable": ""}, {"codigo": "UT-054", "nombre": "Servilleteros", "area": "SERVICIO", "stock": 17, "minimo": 6, "responsable": ""}, {"codigo": "UT-055", "nombre": "Tarro salsa mostaza", "area": "SERVICIO", "stock": 12, "minimo": 5, "responsable": ""}, {"codigo": "UT-056", "nombre": "Tarro salsa tomate", "area": "SERVICIO", "stock": 12, "minimo": 5, "responsable": ""}],
  "conteo_pedro": {"id": 1735401600000, "fecha": "2025-12-28", "responsable": "Pedro", "detalles": [{"codigo": "UT-001", "nombre": "Batidor", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-002", "nombre": "Copas larga", "area": "BARRA", "stock": 10, "minimo": 2, "contado": 9, "diferencia": -1, "estado": "Faltante", "motivo": "Faltan 1"}, {"codigo": "UT-003", "nombre": "Copas redondas", "area": "BARRA", "stock": 8, "minimo": 2, "contado": 8, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-004", "nombre": "Cuchara coctelera", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-005", "nombre": "Exprimidor", "area": "BARRA", "stock": 2, "minimo": 1, "contado": 2, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-006", "nombre": "Jarra grande", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-007", "nombre": "Jarras", "area": "BARRA", "stock": 5, "minimo": 2, "contado": 5, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-008", "nombre": "Martillo de hielo", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-009", "nombre": "Medidor de onzas", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-010", "nombre": "Pala para hielo", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-011", "nombre": "Pote azul agua", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-012", "nombre": "Pote transparente", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-013", "nombre": "Termo grande agua", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-014", "nombre": "Termo mediano hielo", "area": "BARRA", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-015", "nombre": "Vasos de vidrio", "area": "BARRA", "stock": 38, "minimo": 10, "contado": 34, "diferencia": -4, "estado": "Faltante", "motivo": "Faltan 4"}, {"codigo": "UT-016", "nombre": "Bandeja", "area": "COCINA", "stock": 2, "minimo": 1, "contado": 3, "diferencia": 1, "estado": "Sobra", "motivo": "Sobran 1"}, {"codigo": "UT-017", "nombre": "Bandejas metalicas", "area": "COCINA", "stock": 14, "minimo": 4, "contado": 6, "diferencia": -8, "estado": "Faltante", "motivo": "Faltan 8"}, {"codigo": "UT-018", "nombre": "Canasta grande", "area": "COCINA", "stock": 3, "minimo": 1, "contado": 4, "diferencia": 1, "estado": "Sobra", "motivo": "Sobran 1"}, {"codigo": "UT-019", "nombre": "Canasta peque√±a", "area": "COCINA", "stock": 8, "minimo": 4, "contado": 8, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-020", "nombre": "colador de aluminio", "area": "COCINA", "stock": 2, "minimo": 1, "contado": 1, "diferencia": -1, "estado": "Faltante", "motivo": "Faltan 1"}, {"codigo": "UT-021", "nombre": "Cucharas", "area": "COCINA", "stock": 31, "minimo": 15, "contado": 51, "diferencia": 20, "estado": "Sobra", "motivo": "Sobran 20"}, {"codigo": "UT-023", "nombre": "Cuchillos", "area": "COCINA", "stock": 37, "minimo": 15, "contado": 52, "diferencia": 15, "estado": "Sobra", "motivo": "Sobran 15"}, {"codigo": "UT-024", "nombre": "Plato negro de barro", "area": "COCINA", "stock": 4, "minimo": 2, "contado": 1, "diferencia": -3, "estado": "Faltante", "motivo": "Faltan 3"}, {"codigo": "UT-026", "nombre": "Platos de mute", "area": "COCINA", "stock": 23, "minimo": 10, "contado": 23, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-027", "nombre": "Platos hondos grandes", "area": "COCINA", "stock": 8, "minimo": 4, "contado": 8, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-028", "nombre": "Platos planos", "area": "COCINA", "stock": 16, "minimo": 8, "contado": 23, "diferencia": 7, "estado": "Sobra", "motivo": "Sobran 7"}, {"codigo": "UT-029", "nombre": "Salseros de aluminio", "area": "COCINA", "stock": 77, "minimo": 30, "contado": 4, "diferencia": -73, "estado": "Faltante", "motivo": "Faltan 73"}, {"codigo": "UT-030", "nombre": "Tablas", "area": "COCINA", "stock": 18, "minimo": 10, "contado": 18, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-031", "nombre": "Tenedores", "area": "COCINA", "stock": 29, "minimo": 15, "contado": 45, "diferencia": 16, "estado": "Sobra", "motivo": "Sobran 16"}, {"codigo": "UT-049", "nombre": "Cubiertero grande", "area": "SERVICIO", "stock": 1, "minimo": 1, "contado": 1, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-050", "nombre": "Cubiertero negro", "area": "SERVICIO", "stock": 13, "minimo": 6, "contado": 13, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-051", "nombre": "Palillos", "area": "SERVICIO", "stock": 10, "minimo": 5, "contado": 8, "diferencia": -2, "estado": "Faltante", "motivo": "Faltan 2"}, {"codigo": "UT-052", "nombre": "Picantes", "area": "SERVICIO", "stock": 11, "minimo": 5, "contado": 7, "diferencia": -4, "estado": "Faltante", "motivo": "Faltan 4"}, {"codigo": "UT-053", "nombre": "Saleros", "area": "SERVICIO", "stock": 12, "minimo": 6, "contado": 11, "diferencia": -1, "estado": "Faltante", "motivo": "Faltan 1"}, {"codigo": "UT-054", "nombre": "Servilleteros", "area": "SERVICIO", "stock": 17, "minimo": 6, "contado": 17, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-055", "nombre": "Tarro salsa mostaza", "area": "SERVICIO", "stock": 12, "minimo": 5, "contado": 12, "diferencia": 0, "estado": "", "motivo": ""}, {"codigo": "UT-056", "nombre": "Tarro salsa tomate", "area": "SERVICIO", "stock": 12, "minimo": 5, "contado": 13, "diferencia": 1, "estado": "Sobra", "motivo": "Sobran 1"}]}
};

const STORAGE_KEY = 'rincondelbarril_utensilios';
const CONTEOS_KEY = 'rincondelbarril_conteos';

function inicializar() {
  if (!localStorage.getItem(STORAGE_KEY)) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DATOS_INICIALES.utensilios));
  }
  if (!localStorage.getItem(CONTEOS_KEY)) {
    localStorage.setItem(CONTEOS_KEY, JSON.stringify([DATOS_INICIALES.conteo_pedro]));
  }
}

function getUtensilios() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}

function getConteos() {
  return JSON.parse(localStorage.getItem(CONTEOS_KEY) || '[]');
}

function saveUtensilios(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function saveConteos(data) {
  localStorage.setItem(CONTEOS_KEY, JSON.stringify(data));
}

function showTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  if (tabName === 'conteo') prepararConteo();
  if (tabName === 'historial') cargarHistorial();
  if (tabName === 'resumen') cargarResumen();
  if (tabName === 'utensilios') cargarTablaUtensilios();
}

function volverInicio() {
  document.querySelector('.tab:first-child').click();
}

// UTENSILIOS
function cargarTablaUtensilios() {
  const utensilios = getUtensilios();
  const tbody = document.getElementById('bodyUtensilios');
  
  if (utensilios.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No hay utensilios</td></tr>';
    return;
  }
  
  tbody.innerHTML = utensilios.map(ut => `
    <tr>
      <td><strong>${ut.codigo}</strong></td>
      <td>${ut.nombre}</td>
      <td><span class="badge badge-info">${ut.area}</span></td>
      <td>${ut.stock}</td>
      <td>${ut.minimo}</td>
      <td>
        <button class="btn btn-primary btn-small" onclick='editarUtensilio("${ut.codigo}")'>‚úèÔ∏è</button>
        <button class="btn btn-danger btn-small" onclick='eliminarUtensilio("${ut.codigo}")'>üóëÔ∏è</button>
      </td>
    </tr>
  `).join('');
}

function filtrarUtensilios() {
  const search = document.getElementById('searchUtensilios').value.toLowerCase();
  const rows = document.querySelectorAll('#bodyUtensilios tr');
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(search) ? '' : 'none';
  });
}

function generarCodigo() {
  const utensilios = getUtensilios();
  const maxNum = utensilios.length > 0 ? 
    Math.max(...utensilios.map(u => parseInt(u.codigo.split('-')[1]))) : 0;
  return `UT-${String(maxNum + 1).padStart(3, '0')}`;
}

function guardarUtensilio(e) {
  e.preventDefault();
  
  const editandoCodigo = document.getElementById('editandoCodigo').value;
  const utensilios = getUtensilios();
  
  const utensilio = {
    codigo: editandoCodigo || document.getElementById('codigoUtensilio').value,
    nombre: document.getElementById('nombreUtensilio').value,
    area: document.getElementById('areaUtensilio').value,
    stock: parseInt(document.getElementById('stockUtensilio').value),
    minimo: parseInt(document.getElementById('minimoUtensilio').value),
    responsable: document.getElementById('responsableUtensilio').value
  };
  
  if (editandoCodigo) {
    const index = utensilios.findIndex(u => u.codigo === editandoCodigo);
    utensilios[index] = utensilio;
    alert('‚úÖ Utensilio actualizado');
  } else {
    utensilios.push(utensilio);
    alert('‚úÖ Utensilio agregado');
  }
  
  saveUtensilios(utensilios);
  e.target.reset();
  document.getElementById('editandoCodigo').value = '';
  document.getElementById('tituloFormUtensilio').textContent = '‚ûï Agregar Nuevo Utensilio';
  document.getElementById('codigoUtensilio').value = generarCodigo();
  
  cargarTablaUtensilios();
}

function editarUtensilio(codigo) {
  const utensilios = getUtensilios();
  const ut = utensilios.find(u => u.codigo === codigo);
  
  if (!ut) return;
  
  document.getElementById('editandoCodigo').value = codigo;
  document.getElementById('codigoUtensilio').value = codigo;
  document.getElementById('nombreUtensilio').value = ut.nombre;
  document.getElementById('areaUtensilio').value = ut.area;
  document.getElementById('stockUtensilio').value = ut.stock;
  document.getElementById('minimoUtensilio').value = ut.minimo;
  document.getElementById('responsableUtensilio').value = ut.responsable;
  
  document.getElementById('tituloFormUtensilio').textContent = '‚úèÔ∏è Editar Utensilio';
  document.querySelector('.tab:nth-child(2)').click();
}

function eliminarUtensilio(codigo) {
  if (!confirm('¬øSeguro que quieres eliminar este utensilio?')) return;
  
  const utensilios = getUtensilios();
  const nuevos = utensilios.filter(u => u.codigo !== codigo);
  saveUtensilios(nuevos);
  cargarTablaUtensilios();
  alert('‚úÖ Utensilio eliminado');
}

function cancelarEdicion() {
  document.getElementById('formUtensilio').reset();
  document.getElementById('editandoCodigo').value = '';
  document.getElementById('tituloFormUtensilio').textContent = '‚ûï Agregar Nuevo Utensilio';
  document.getElementById('codigoUtensilio').value = generarCodigo();
}

// CONTEO
function prepararConteo() {
  const utensilios = getUtensilios();
  const container = document.getElementById('listaConteo');
  
  if (utensilios.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #999;">No hay utensilios para contar</p>';
    return;
  }
  
  const hoy = new Date().toISOString().split('T')[0];
  if (!document.getElementById('fechaConteo').value) {
    document.getElementById('fechaConteo').value = hoy;
  }
  
  const porArea = {};
  utensilios.forEach(ut => {
    if (!porArea[ut.area]) porArea[ut.area] = [];
    porArea[ut.area].push(ut);
  });
  
  container.innerHTML = Object.keys(porArea).sort().map(area => `
    <h3 style="margin-top: 30px; color: #2a5298;">üìç ${area}</h3>
    ${porArea[area].map(ut => `
      <div class="conteo-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <div>
            <strong>${ut.nombre}</strong> <span class="badge badge-info">${ut.codigo}</span>
          </div>
          <div style="font-size: 12px; color: #666;">
            Stock: ${ut.stock} | M√≠nimo: ${ut.minimo}
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Cantidad contada:</label>
            <input type="number" id="cnt_${ut.codigo}" min="0" placeholder="0" onchange="calcularDif('${ut.codigo}', ${ut.stock}, ${ut.minimo})">
          </div>
          <div class="form-group">
            <label>Estado (si hay diferencia):</label>
            <select id="est_${ut.codigo}">
              <option value="">OK</option>
              <option value="Faltante">Faltante</option>
              <option value="Da√±ado">Da√±ado</option>
              <option value="Desgastado">Desgastado</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Observaci√≥n:</label>
          <input type="text" id="obs_${ut.codigo}" placeholder="Opcional: ¬øQu√© pas√≥?">
        </div>
        <div id="dif_${ut.codigo}" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px; font-weight: 600;"></div>
      </div>
    `).join('')}
  `).join('');
}

function calcularDif(codigo, stock, minimo) {
  const contado = parseInt(document.getElementById('cnt_' + codigo).value) || 0;
  const dif = contado - stock;
  const difDiv = document.getElementById('dif_' + codigo);
  
  if (contado === 0) {
    difDiv.style.display = 'none';
    return;
  }
  
  difDiv.style.display = 'block';
  
  if (dif === 0) {
    difDiv.style.background = '#d4edda';
    difDiv.style.color = '#155724';
    difDiv.textContent = '‚úÖ Perfecto - Coincide con stock base';
  } else if (contado < minimo) {
    difDiv.style.background = '#f8d7da';
    difDiv.style.color = '#721c24';
    difDiv.textContent = `üî¥ ALERTA - Bajo el m√≠nimo (faltan ${Math.abs(dif)})`;
  } else if (dif < 0) {
    difDiv.style.background = '#fff3cd';
    difDiv.style.color = '#856404';
    difDiv.textContent = `‚ö†Ô∏è Faltan ${Math.abs(dif)} unidades`;
  } else {
    difDiv.style.background = '#fff3cd';
    difDiv.style.color = '#856404';
    difDiv.textContent = `‚ö†Ô∏è Sobran ${dif} unidades`;
  }
}

function filtrarConteo() {
  const search = document.getElementById('buscarEnConteo').value.toLowerCase();
  const cards = document.querySelectorAll('.conteo-card');
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(search) ? 'block' : 'none';
  });
}

function guardarConteoCompleto() {
  const responsable = document.getElementById('responsableConteo').value.trim();
  const fecha = document.getElementById('fechaConteo').value;
  const editandoId = document.getElementById('editandoConteoId').value;
  
  if (!responsable) {
    alert('‚ö†Ô∏è Por favor ingresa el nombre del responsable');
    return;
  }
  
  const utensilios = getUtensilios();
  const detalles = [];
  
  utensilios.forEach(ut => {
    const input = document.getElementById('cnt_' + ut.codigo);
    if (input && input.value && input.value !== '0' && input.value !== '') {
      const contado = parseInt(input.value);
      detalles.push({
        codigo: ut.codigo,
        nombre: ut.nombre,
        area: ut.area,
        stock: ut.stock,
        minimo: ut.minimo,
        contado: contado,
        diferencia: contado - ut.stock,
        estado: document.getElementById('est_' + ut.codigo).value,
        observacion: document.getElementById('obs_' + ut.codigo).value
      });
    }
  });
  
  if (detalles.length === 0) {
    alert('‚ö†Ô∏è No has contado ning√∫n utensilio');
    return;
  }
  
  const conteos = getConteos();
  
  if (editandoId) {
    // EDITANDO - Actualizar conteo existente
    const index = conteos.findIndex(c => c.id == editandoId);
    if (index !== -1) {
      conteos[index] = {
        id: parseInt(editandoId),
        fecha: fecha,
        responsable: responsable,
        detalles: detalles
      };
      alert(`‚úÖ Conteo actualizado\n\n${detalles.length} utensilios contados`);
    }
  } else {
    // NUEVO - Agregar conteo nuevo
    const conteo = {
      id: Date.now(),
      fecha: fecha,
      responsable: responsable,
      detalles: detalles
    };
    conteos.push(conteo);
    alert(`‚úÖ Conteo guardado exitosamente\n\n${detalles.length} utensilios contados`);
  }
  
  saveConteos(conteos);
  
  // Limpiar
  document.getElementById('responsableConteo').value = '';
  document.getElementById('editandoConteoId').value = '';
  document.getElementById('alertaEditandoConteo').style.display = 'none';
  document.getElementById('tituloConteo').textContent = 'üìä Realizar Conteo de Utensilios';
  prepararConteo();
}

// NUEVA FUNCI√ìN: EDITAR CONTEO
function editarConteo(id) {
  const conteos = getConteos();
  const conteo = conteos.find(c => c.id === id);
  
  if (!conteo) return;
  
  // Marcar que estamos editando
  document.getElementById('editandoConteoId').value = id;
  document.getElementById('alertaEditandoConteo').style.display = 'block';
  document.getElementById('tituloConteo').textContent = '‚úèÔ∏è Editando Conteo';
  
  // Llenar datos del conteo
  document.getElementById('responsableConteo').value = conteo.responsable;
  document.getElementById('fechaConteo').value = conteo.fecha;
  
  // Cambiar a tab conteo
  document.querySelector('.tab:nth-child(3)').click();
  
  // Esperar a que se cargue el formulario
  setTimeout(() => {
    // Llenar las cantidades ya contadas
    conteo.detalles.forEach(d => {
      const inputCnt = document.getElementById('cnt_' + d.codigo);
      const selectEst = document.getElementById('est_' + d.codigo);
      const inputObs = document.getElementById('obs_' + d.codigo);
      
      if (inputCnt) {
        inputCnt.value = d.contado;
        calcularDif(d.codigo, d.stock, d.minimo);
      }
      if (selectEst && d.estado) {
        selectEst.value = d.estado;
      }
      if (inputObs && d.observacion) {
        inputObs.value = d.observacion;
      }
    });
  }, 100);
}

function cancelarEdicionConteo() {
  document.getElementById('editandoConteoId').value = '';
  document.getElementById('alertaEditandoConteo').style.display = 'none';
  document.getElementById('tituloConteo').textContent = 'üìä Realizar Conteo de Utensilios';
  document.getElementById('responsableConteo').value = '';
  prepararConteo();
}

// HISTORIAL
function cargarHistorial() {
  const conteos = getConteos();
  const container = document.getElementById('listaHistorial');
  
  if (conteos.length === 0) {
    container.innerHTML = '<p style="text-align: center; color: #999;">No hay conteos realizados</p>';
    return;
  }
  
  container.innerHTML = conteos.sort((a, b) => b.id - a.id).map(c => {
    const ok = c.detalles.filter(d => d.diferencia === 0).length;
    const dif = c.detalles.filter(d => d.diferencia !== 0).length;
    
    return `
      <div class="conteo-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3>üìÖ ${c.fecha}</h3>
            <p><strong>Responsable:</strong> ${c.responsable}</p>
          </div>
          <div>
            <button class="btn btn-warning btn-small" onclick='editarConteo(${c.id})'>‚úèÔ∏è Editar</button>
            <button class="btn btn-secondary btn-small" onclick='verDetalleConteo(${c.id})'>üëÅÔ∏è Ver</button>
            <button class="btn btn-success btn-small" onclick='exportarConteo(${c.id})'>üì• Excel</button>
            <button class="btn btn-danger btn-small" onclick='eliminarConteo(${c.id})'>üóëÔ∏è</button>
          </div>
        </div>
        <p style="margin-top: 10px;">
          <span class="badge badge-ok">‚úÖ OK: ${ok}</span>
          <span class="badge badge-warning">‚ö†Ô∏è Diferencias: ${dif}</span>
          <span class="badge badge-info">üì¶ Total: ${c.detalles.length}</span>
        </p>
      </div>
    `;
  }).join('');
}

function verDetalleConteo(id) {
  const conteos = getConteos();
  const conteo = conteos.find(c => c.id === id);
  
  if (!conteo) return;
  
  const html = `
    <h2>Detalle del Conteo</h2>
    <p><strong>Fecha:</strong> ${conteo.fecha}</p>
    <p><strong>Responsable:</strong> ${conteo.responsable}</p>
    <table>
      <thead>
        <tr>
          <th>Utensilio</th>
          <th>√Årea</th>
          <th>Stock</th>
          <th>Contado</th>
          <th>Dif.</th>
          <th>Estado</th>
          <th>Observaci√≥n</th>
        </tr>
      </thead>
      <tbody>
        ${conteo.detalles.map(d => `
          <tr>
            <td>${d.nombre}</td>
            <td><span class="badge badge-info">${d.area}</span></td>
            <td>${d.stock}</td>
            <td>${d.contado}</td>
            <td style="color: ${d.diferencia === 0 ? 'green' : 'red'}; font-weight: bold;">
              ${d.diferencia === 0 ? '‚úÖ' : (d.diferencia < 0 ? d.diferencia : '+' + d.diferencia)}
            </td>
            <td>${d.estado || 'OK'}</td>
            <td>${d.observacion || '-'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <button onclick="cargarHistorial()" class="btn btn-secondary">‚Üê Volver</button>
  `;
  
  document.getElementById('listaHistorial').innerHTML = html;
}

function exportarConteo(id) {
  const conteos = getConteos();
  const conteo = conteos.find(c => c.id === id);
  
  if (!conteo) return;
  
  let html = '<h1>PLAN DE SANEAMIENTO Y MANTENIMIENTO - EL RINC√ìN DEL BARRIL</h1>';
  html += '<h2>Conteo de Utensilios</h2>';
  html += `<p><strong>Fecha:</strong> ${conteo.fecha}</p>`;
  html += `<p><strong>Responsable:</strong> ${conteo.responsable}</p><br>`;
  html += '<table border="1"><tr><th>C√≥digo</th><th>Utensilio</th><th>√Årea</th><th>Stock</th><th>Contado</th><th>Diferencia</th><th>Estado</th><th>Observaci√≥n</th></tr>';
  
  conteo.detalles.forEach(d => {
    html += `<tr>
      <td>${d.codigo}</td>
      <td>${d.nombre}</td>
      <td>${d.area}</td>
      <td>${d.stock}</td>
      <td>${d.contado}</td>
      <td>${d.diferencia}</td>
      <td>${d.estado || 'OK'}</td>
      <td>${d.observacion || '-'}</td>
    </tr>`;
  });
  
  html += '</table>';
  
  const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Conteo_${conteo.fecha}_${conteo.responsable}.xls`;
  a.click();
}

function eliminarConteo(id) {
  if (!confirm('¬øSeguro que quieres eliminar este conteo?')) return;
  
  const conteos = getConteos();
  const nuevos = conteos.filter(c => c.id !== id);
  saveConteos(nuevos);
  cargarHistorial();
  alert('‚úÖ Conteo eliminado');
}

function exportarUtensilios() {
  const utensilios = getUtensilios();
  
  let html = '<h1>PLAN DE SANEAMIENTO Y MANTENIMIENTO - EL RINC√ìN DEL BARRIL</h1>';
  html += '<h2>Listado de Utensilios</h2><br>';
  html += '<table border="1"><tr><th>C√≥digo</th><th>Nombre</th><th>√Årea</th><th>Stock</th><th>M√≠nimo</th><th>Responsable</th></tr>';
  
  utensilios.forEach(ut => {
    html += `<tr><td>${ut.codigo}</td><td>${ut.nombre}</td><td>${ut.area}</td><td>${ut.stock}</td><td>${ut.minimo}</td><td>${ut.responsable || '-'}</td></tr>`;
  });
  
  html += '</table>';
  
  const blob = new Blob([html], {type: 'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Utensilios_Saneamiento.xls';
  a.click();
}

// RESUMEN
function cargarResumen() {
  const utensilios = getUtensilios();
  const conteos = getConteos();
  
  document.getElementById('totalUtensilios').textContent = utensilios.length;
  document.getElementById('totalConteos').textContent = conteos.length;
  
  const porArea = {};
  utensilios.forEach(ut => {
    if (!porArea[ut.area]) porArea[ut.area] = [];
    porArea[ut.area].push(ut);
  });
  
  document.getElementById('totalAreas').textContent = Object.keys(porArea).length;
  
  const container = document.getElementById('porArea');
  container.innerHTML = Object.keys(porArea).sort().map(area => `
    <div class="conteo-card">
      <h4>${area}</h4>
      <p><strong>${porArea[area].length}</strong> utensilios registrados</p>
      <p style="font-size: 12px; color: #666;">
        Stock total: ${porArea[area].reduce((sum, u) => sum + u.stock, 0)}
      </p>
    </div>
  `).join('');
}

function resetearSistema() {
  if (!confirm('‚ö†Ô∏è ADVERTENCIA: Esto borrar√° TODOS los datos. ¬øEst√°s seguro?')) return;
  if (!confirm('¬øREALMENTE SEGURO? Esta acci√≥n NO se puede deshacer')) return;
  
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(CONTEOS_KEY);
  location.reload();
}

// Inicializar
window.onload = function() {
  inicializar();
  cargarTablaUtensilios();
  document.getElementById('codigoUtensilio').value = generarCodigo();
  document.getElementById('fechaConteo').value = new Date().toISOString().split('T')[0];
};
</script>

</body>
</html>
