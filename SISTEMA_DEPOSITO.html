<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Deposito General | El Rinc√≥n del Barril</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1810 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #C41E3A 0%, #8B1528 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .logo {
            position: absolute;
            top: 20px;
            left: 30px;
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #C41E3A;
            font-size: 1.5em;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #C41E3A;
            overflow-x: auto;
        }

        .tab {
            padding: 18px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -3px;
            white-space: nowrap;
        }

        .tab:hover {
            background: rgba(196, 30, 58, 0.1);
            color: #C41E3A;
        }

        .tab.active {
            background: white;
            color: #C41E3A;
            border-bottom-color: #C41E3A;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.6em;
            color: #C41E3A;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #C41E3A;
            color: white;
        }

        .btn-primary:hover {
            background: #8B1528;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.3);
        }

        .btn-secondary {
            background: #666;
            color: white;
        }

        .btn-secondary:hover {
            background: #444;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #C41E3A;
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        .card {
            background: white;
            border: 2px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #C41E3A;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #C41E3A 0%, #8B1528 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr {
            transition: background 0.2s ease;
        }

        tbody tr:hover {
            background: rgba(196, 30, 58, 0.05);
        }

        .status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            display: inline-block;
        }

        .status.entrada {
            background: #d4edda;
            color: #155724;
        }

        .status.salida {
            background: #f8d7da;
            color: #721c24;
        }

        .status.bajo {
            background: #fff3cd;
            color: #856404;
        }

        .status.optimo {
            background: #d4edda;
            color: #155724;
        }

        .status.critico {
            background: #f8d7da;
            color: #721c24;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin: 0 3px;
            transition: all 0.2s ease;
        }

        .action-btn.edit {
            background: #ffc107;
            color: #333;
        }

        .action-btn.edit:hover {
            background: #e0a800;
        }

        .action-btn.delete {
            background: #dc3545;
            color: white;
        }

        .action-btn.delete:hover {
            background: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 4px solid #C41E3A;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #C41E3A;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #C41E3A 0%, #8B1528 100%);
            color: white;
            padding: 25px;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            font-size: 1.5em;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .search-filter input,
        .search-filter select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            flex: 1;
            min-width: 200px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-carbon {
            background: #424242;
            color: white;
        }

        .badge-limpieza {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-desinfectante {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .badge-cocina {
            background: #fff3e0;
            color: #ef6c00;
        }

        .badge-desechable {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge-uniforme {
            background: #fce4ec;
            color: #c2185b;
        }

        .badge-bolsa {
            background: #e0e0e0;
            color: #424242;
        }

        .badge-papel {
            background: #fff9c4;
            color: #f57f17;
        }

        .badge-vajilla {
            background: #e1f5fe;
            color: #0277bd;
        }

        .badge-herramienta {
            background: #ffebee;
            color: #c62828;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            color: #1565c0;
            margin-bottom: 8px;
        }

        .info-box p {
            color: #424242;
            margin: 5px 0;
            font-size: 0.95em;
        }

        .info-box.critical {
            background: #ffebee;
            border-left-color: #c62828;
        }

        .info-box.critical h4 {
            color: #c62828;
        }

        /* Grid de 2 columnas para producto y proveedor */
        .form-row-2cols {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5em;
            }

            .logo {
                position: static;
                margin: 0 auto 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
                text-align: left;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            /* En m√≥vil, grid de 2 columnas se vuelve 1 columna */
            .form-row-2cols {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .search-filter {
                flex-direction: column;
            }

            .search-filter input,
            .search-filter select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üì¶</div>
            <h1>Gesti√≥n de Deposito General</h1>
            <p>El Rinc√≥n del Barril - Control de Insumos Operativos</p>
            <button onclick="limpiarTodoAHORA()" style="position:absolute;top:30px;right:210px;background:#ff4444;border:3px solid white;color:white;padding:12px 25px;border-radius:10px;cursor:pointer;font-weight:bold;font-size:16px;box-shadow:0 4px 8px rgba(0,0,0,0.3);">‚ö†Ô∏è RESETEAR TODO</button>
            <button onclick="if(confirm('¬øVolver al men√∫ principal de sistemas? (No perder√°s los datos guardados)')) window.location.href='index.html';" style="position:absolute;top:30px;right:30px;background:rgba(255,255,255,0.3);border:2px solid white;color:white;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold;">üè† Men√∫ Principal</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('reportes')">üìä Reportes</button>
            <button class="tab" onclick="showTab('entrada')">üì• Registrar Entrada</button>
            <button class="tab" onclick="showTab('salida')">üì§ Registrar Salida</button>
            <button class="tab" onclick="showTab('conteo')">üìã Conteo F√≠sico</button>
            <button class="tab" onclick="showTab('productos')">üì¶ Gesti√≥n de Productos</button>
            <button class="tab" onclick="showTab('inventario')">üóÉÔ∏è Inventario Actual</button>
            <button class="tab" onclick="showTab('proveedores')">üöö Proveedores</button>
        </div>

        <div class="content">
            <div id="alert-container"></div>

            <!-- TAB: REPORTES -->
            <div id="reportes" class="tab-content active">
                <div class="section-title">
                    <span>üìä Reportes de Movimientos</span>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="exportarExcel('completo')">
                            üì• Exportar Todo
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Productos</h3>
                        <div class="value" id="stat-total-productos">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Entradas del Mes</h3>
                        <div class="value" id="stat-entradas-mes">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Salidas del Mes</h3>
                        <div class="value" id="stat-salidas-mes">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Proveedores Activos</h3>
                        <div class="value" id="stat-proveedores">0</div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-bottom: 15px;">Filtros de Reporte</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Fecha Inicio</label>
                            <input type="date" id="filtro-fecha-inicio">
                        </div>
                        <div class="form-group">
                            <label>Fecha Fin</label>
                            <input type="date" id="filtro-fecha-fin">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Movimiento</label>
                            <select id="filtro-tipo">
                                <option value="todos">Todos</option>
                                <option value="entrada">Entradas</option>
                                <option value="salida">Salidas</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Responsable</label>
                            <input type="text" id="filtro-responsable" placeholder="Nombre del responsable">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="filtrarReportes()">üîç Filtrar</button>
                        <button class="btn btn-success" onclick="exportarExcel('filtrado')">üì• Exportar Filtrado</button>
                        <button class="btn btn-secondary" onclick="limpiarFiltros()">üîÑ Limpiar</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Unidad</th>
                                <th>Proveedor/√Årea</th>
                                <th>Responsable</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-reportes">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div>
                                        <h3>No hay movimientos registrados</h3>
                                        <p>Los movimientos de entrada y salida aparecer√°n aqu√≠</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: ENTRADA -->
            <div id="entrada" class="tab-content">
                <div class="section-title">
                    <span>üì• Registrar Entrada de Productos</span>
                </div>

                <div class="info-box critical">
                    <h4>üî• Productos Cr√≠ticos para Operaci√≥n</h4>
                    <p>‚Ä¢ <strong>CARB√ìN:</strong> Sin carb√≥n no hay parrilla - Revisar stock diariamente</p>
                    <p>‚Ä¢ <strong>GAS:</strong> Para cocina y preparaciones</p>
                    <p>‚Ä¢ <strong>ACEITE:</strong> Para fritura y preparaciones</p>
                    <p>‚Ä¢ <strong>Desinfectantes:</strong> Requeridos por INVIMA</p>
                </div>

                <form id="form-entrada" onsubmit="registrarEntrada(event)">
                    <div class="form-row-2cols">
                        <div class="form-group">
                            <label class="required">Producto</label>
                            <div style="display: flex; gap: 8px; align-items: flex-end;">
                                <select id="entrada-producto" required style="flex: 1;">
                                    <option value="">Seleccione un producto...</option>
                                </select>
                                <button type="button" class="btn btn-success" onclick="abrirCreacionRapidaProducto()" 
                                        style="padding: 12px 16px; white-space: nowrap; font-size: 0.9em;" 
                                        title="Crear producto nuevo sin salir del formulario">
                                    ‚ûï Nuevo
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="required">Proveedor</label>
                            <div style="display: flex; gap: 8px; align-items: flex-end;">
                                <select id="entrada-proveedor" required style="flex: 1;">
                                    <option value="">Seleccione un proveedor...</option>
                                </select>
                                <button type="button" class="btn btn-success" onclick="abrirCreacionRapidaProveedor()" 
                                        style="padding: 12px 16px; white-space: nowrap; font-size: 0.9em;" 
                                        title="Crear proveedor nuevo sin salir del formulario">
                                    ‚ûï Nuevo
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Cantidad</label>
                            <input type="number" id="entrada-cantidad" min="0.01" step="0.01" required 
                                   placeholder="Ej: 50">
                        </div>

                        <div class="form-group">
                            <label class="required">Unidad de Medida</label>
                            <select id="entrada-unidad" required>
                                <option value="unidades">Unidades</option>
                                <option value="kg">Kilogramos</option>
                                <option value="gramos">Gramos</option>
                                <option value="litros">Litros</option>
                                <option value="ml">Mililitros</option>
                                <option value="cajas">Cajas</option>
                                <option value="paquetes">Paquetes</option>
                                <option value="bultos">Bultos</option>
                                <option value="galones">Galones</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Costo Unitario ($)</label>
                            <input type="number" id="entrada-costo" min="0" step="1" 
                                   placeholder="Opcional">
                        </div>

                        <div class="form-group">
                            <label>Costo Total ($)</label>
                            <input type="number" id="entrada-costo-total" min="0" step="1" 
                                   placeholder="Calculado autom√°ticamente" readonly>
                        </div>

                        <div class="form-group">
                            <label class="required">Fecha de Entrada</label>
                            <input type="date" id="entrada-fecha" required>
                        </div>

                        <div class="form-group">
                            <label class="required">Responsable del Registro</label>
                            <input type="text" id="entrada-responsable" required 
                                   placeholder="Tu nombre completo">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="entrada-observaciones" 
                                  placeholder="Notas: estado del producto, n√∫mero de factura, condiciones de entrega, etc."></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">‚úÖ Registrar Entrada</button>
                        <button type="button" class="btn btn-success" onclick="registrarYContinuar('entrada')">
                            ‚úÖ‚ûï Registrar y Continuar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormulario('entrada')">
                            üîÑ Limpiar
                        </button>
                    </div>
                </form>
            </div>

            <!-- TAB: SALIDA -->
            <div id="salida" class="tab-content">
                <div class="section-title">
                    <span>üì§ Registrar Salida de Productos</span>
                </div>

                <div class="info-box">
                    <h4>‚ÑπÔ∏è ¬øCu√°ndo registrar salidas?</h4>
                    <p>‚Ä¢ <strong>Uso en cocina:</strong> Carb√≥n para parrilla, aceite, condimentos</p>
                    <p>‚Ä¢ <strong>Limpieza y aseo:</strong> Productos usados en limpieza diaria</p>
                    <p>‚Ä¢ <strong>Servicio al cliente:</strong> Desechables, servilletas, bolsas</p>
                    <p>‚Ä¢ <strong>√Årea espec√≠fica:</strong> Indica cocina, bar, ba√±os, sal√≥n, etc.</p>
                </div>

                <form id="form-salida" onsubmit="registrarSalida(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">Producto</label>
                            <select id="salida-producto" required onchange="verificarStock(this.value)">
                                <option value="">Seleccione un producto...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Stock Disponible</label>
                            <input type="text" id="salida-stock-disponible" readonly 
                                   placeholder="Seleccione un producto"
                                   style="background: #f8f9fa; font-weight: bold;">
                        </div>

                        <div class="form-group">
                            <label class="required">Cantidad</label>
                            <input type="number" id="salida-cantidad" min="0.01" step="0.01" required 
                                   placeholder="Ej: 5">
                        </div>

                        <div class="form-group">
                            <label class="required">Unidad de Medida</label>
                            <select id="salida-unidad" required>
                                <option value="unidades">Unidades</option>
                                <option value="kg">Kilogramos</option>
                                <option value="gramos">Gramos</option>
                                <option value="litros">Litros</option>
                                <option value="ml">Mililitros</option>
                                <option value="paquetes">Paquetes</option>
                                <option value="bultos">Bultos</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">√Årea de Uso</label>
                            <select id="salida-area" required>
                                <option value="">Seleccione un √°rea...</option>
                                <option value="cocina">Cocina</option>
                                <option value="parrilla">Parrilla/Asador</option>
                                <option value="bar">Bar</option>
                                <option value="salon">Sal√≥n/Mesas</option>
                                <option value="banos">Ba√±os</option>
                                <option value="almacen">Almac√©n</option>
                                <option value="domicilios">Domicilios</option>
                                <option value="general">Limpieza General</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">Motivo de Salida</label>
                            <select id="salida-motivo" required>
                                <option value="">Seleccione un motivo...</option>
                                <option value="uso-operativo">Uso Operativo</option>
                                <option value="limpieza">Limpieza y Aseo</option>
                                <option value="servicio-cliente">Servicio al Cliente</option>
                                <option value="merma">Merma/P√©rdida</option>
                                <option value="consumo-interno">Consumo Interno</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">Fecha de Salida</label>
                            <input type="date" id="salida-fecha" required>
                        </div>

                        <div class="form-group">
                            <label class="required">Responsable del Registro</label>
                            <input type="text" id="salida-responsable" required 
                                   placeholder="Tu nombre completo">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="salida-observaciones" 
                                  placeholder="Detalles: turno, evento especial, uso espec√≠fico, etc."></textarea>
                    </div>

                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">‚úÖ Registrar Salida</button>
                        <button type="button" class="btn btn-success" onclick="registrarYContinuar('salida')">
                            ‚úÖ‚ûï Registrar y Continuar
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limpiarFormulario('salida')">
                            üîÑ Limpiar
                        </button>
                    </div>
                </form>
            </div>

            <!-- TAB: PRODUCTOS -->
            <div id="productos" class="tab-content">
                <div class="section-title">
                    <span>üì¶ Gesti√≥n de Productos de Deposito</span>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="abrirModalProducto()">
                            ‚ûï Nuevo Producto
                        </button>
                        <button class="btn btn-success" onclick="cargarProductosEjemplo()">
                            üì• Cargar Productos de Ejemplo
                        </button>
                    </div>
                </div>

                <div class="search-filter">
                    <input type="text" id="buscar-producto" placeholder="üîç Buscar por nombre..."
                           oninput="filtrarProductos()">
                    <select id="filtro-categoria-producto" onchange="filtrarProductos()">
                        <option value="">Todas las categor√≠as</option>
                        <option value="carbon">üî• Carb√≥n y Combustibles</option>
                        <option value="limpieza">üß¥ Productos de Limpieza</option>
                        <option value="desinfectante">üßº Desinfectantes</option>
                        <option value="cocina">üç≥ Insumos de Cocina</option>
                        <option value="desechable">üì¶ Desechables y Empaques</option>
                        <option value="uniforme">üëï Uniformes y EPP</option>
                        <option value="bolsa">üóëÔ∏è Bolsas y Residuos</option>
                        <option value="papel">üßª Papel y Toallas</option>
                        <option value="vajilla">üçΩÔ∏è Productos para Vajilla</option>
                        <option value="herramienta">üõ†Ô∏è Herramientas</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Categor√≠a</th>
                                <th>Stock Actual</th>
                                <th>Unidad</th>
                                <th>Estado Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div>
                                        <h3>No hay productos registrados</h3>
                                        <p>Presione "Nuevo Producto" o "Cargar Productos de Ejemplo"</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: CONTEO F√çSICO -->
            <div id="conteo" class="tab-content">
                <div class="section-title">
                    <span>üìã Conteo F√≠sico - Dep√≥sito</span>
                    <button class="btn btn-success" onclick="exportarConteoFisico()">
                        üìä EXPORTAR CONTEO
                    </button>
                </div>

                <!-- Formulario de Conteo -->
                <div class="card">
                    <h3>Registrar Conteo F√≠sico</h3>
                    <form id="form-conteo" onsubmit="registrarConteoFisico(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="conteo-producto">Producto *</label>
                                <select id="conteo-producto" required>
                                    <option value="">Seleccione un producto...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="conteo-cantidad-fisica">Cantidad F√≠sica *</label>
                                <input type="number" id="conteo-cantidad-fisica" step="0.01" required placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="conteo-cantidad-sistema">Cantidad en Sistema</label>
                                <input type="text" id="conteo-cantidad-sistema" readonly style="background: #f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label for="conteo-diferencia">Diferencia</label>
                                <input type="text" id="conteo-diferencia" readonly style="background: #fff3cd;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="conteo-responsable">Responsable *</label>
                                <input type="text" id="conteo-responsable" required placeholder="Nombre del responsable">
                            </div>
                            <div class="form-group">
                                <label for="conteo-fecha">Fecha *</label>
                                <input type="date" id="conteo-fecha" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="conteo-observaciones">Observaciones</label>
                            <textarea id="conteo-observaciones" rows="2" placeholder="Opcional"></textarea>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            ‚úÖ REGISTRAR CONTEO
                        </button>
                    </form>
                </div>

                <!-- Tabla de Conteos -->
                <div class="card">
                    <h3>Conteos Registrados</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Producto</th>
                                    <th>Cant. Sistema</th>
                                    <th>Cant. F√≠sica</th>
                                    <th>Diferencia</th>
                                    <th>% Dif</th>
                                    <th>Responsable</th>
                                    <th>Observaciones</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-conteos"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB: INVENTARIO -->
            <div id="inventario" class="tab-content">
                <div class="section-title">
                    <span>üóÉÔ∏è Inventario Actual</span>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="abrirModalProducto()">
                            ‚ûï Nuevo Producto
                        </button>
                        <button class="btn btn-success" onclick="exportarExcel('inventario')">
                            üì• Exportar Inventario
                        </button>
                        <button class="btn btn-warning" onclick="generarAlertasStock()">
                            ‚ö†Ô∏è Alertas de Stock
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Producto</th>
                                <th>Categor√≠a</th>
                                <th>Stock Actual</th>
                                <th>Unidad</th>
                                <th>Stock M√≠nimo</th>
                                <th>Estado</th>
                                <th>√öltima Actualizaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-inventario">
                            <tr>
                                <td colspan="9" class="empty-state">
                                    <div>
                                        <h3>No hay inventario registrado</h3>
                                        <p>Registre entradas de productos para ver el inventario</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: PROVEEDORES -->
            <div id="proveedores" class="tab-content">
                <div class="section-title">
                    <span>üöö Gesti√≥n de Proveedores</span>
                    <button class="btn btn-primary" onclick="abrirModalProveedor()">
                        ‚ûï Nuevo Proveedor
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Contacto</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Productos</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-proveedores">
                            <tr>
                                <td colspan="7" class="empty-state">
                                    <div>
                                        <h3>No hay proveedores registrados</h3>
                                        <p>Presione "Nuevo Proveedor" para comenzar</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: PRODUCTO -->
    <div id="modal-producto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-producto-titulo">Nuevo Producto</h2>
            </div>
            <form id="form-producto" onsubmit="guardarProducto(event)">
                <div class="modal-body">
                    <input type="hidden" id="producto-id">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">C√≥digo</label>
                            <input type="text" id="producto-codigo" required 
                                   placeholder="Ej: CARB-001">
                        </div>

                        <div class="form-group">
                            <label class="required">Nombre</label>
                            <input type="text" id="producto-nombre" required 
                                   placeholder="Ej: Carb√≥n Vegetal">
                        </div>

                        <div class="form-group">
                            <label class="required">Categor√≠a</label>
                            <select id="producto-categoria" required>
                                <option value="">Seleccione...</option>
                                <option value="carbon">üî• Carb√≥n y Combustibles</option>
                                <option value="limpieza">üß¥ Productos de Limpieza</option>
                                <option value="desinfectante">üßº Desinfectantes</option>
                                <option value="cocina">üç≥ Insumos de Cocina</option>
                                <option value="desechable">üì¶ Desechables y Empaques</option>
                                <option value="uniforme">üëï Uniformes y EPP</option>
                                <option value="bolsa">üóëÔ∏è Bolsas y Residuos</option>
                                <option value="papel">üßª Papel y Toallas</option>
                                <option value="vajilla">üçΩÔ∏è Productos para Vajilla</option>
                                <option value="herramienta">üõ†Ô∏è Herramientas</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="required">Unidad de Medida</label>
                            <select id="producto-unidad" required>
                                <option value="unidades">Unidades</option>
                                <option value="kg">Kilogramos</option>
                                <option value="gramos">Gramos</option>
                                <option value="litros">Litros</option>
                                <option value="ml">Mililitros</option>
                                <option value="paquetes">Paquetes</option>
                                <option value="bultos">Bultos</option>
                                <option value="cajas">Cajas</option>
                                <option value="galones">Galones</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Stock Inicial</label>
                            <input type="number" id="producto-stock" min="0" step="0.01" 
                                   placeholder="Opcional - Por defecto 0">
                        </div>

                        <div class="form-group">
                            <label>Stock M√≠nimo (Alerta)</label>
                            <input type="number" id="producto-stock-minimo" min="0" step="0.01" 
                                   placeholder="Deja en blanco si no aplica">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Descripci√≥n/Notas</label>
                        <textarea id="producto-descripcion" 
                                  placeholder="Detalles: marca, presentaci√≥n, uso espec√≠fico, etc."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('producto')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: PROVEEDOR -->
    <div id="modal-proveedor" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-proveedor-titulo">Nuevo Proveedor</h2>
            </div>
            <form id="form-proveedor" onsubmit="guardarProveedor(event)">
                <div class="modal-body">
                    <input type="hidden" id="proveedor-id">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="required">C√≥digo</label>
                            <input type="text" id="proveedor-codigo" required 
                                   placeholder="Ej: PROV-001">
                        </div>

                        <div class="form-group">
                            <label class="required">Nombre/Raz√≥n Social</label>
                            <input type="text" id="proveedor-nombre" required 
                                   placeholder="Ej: Distribuidora La Econ√≥mica">
                        </div>

                        <div class="form-group">
                            <label>NIT/RUT</label>
                            <input type="text" id="proveedor-nit" 
                                   placeholder="Ej: 900.123.456-7">
                        </div>

                        <div class="form-group">
                            <label class="required">Contacto</label>
                            <input type="text" id="proveedor-contacto" required 
                                   placeholder="Nombre del contacto">
                        </div>

                        <div class="form-group">
                            <label class="required">Tel√©fono</label>
                            <input type="tel" id="proveedor-telefono" required 
                                   placeholder="Ej: 3001234567">
                        </div>

                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="proveedor-email" 
                                   placeholder="proveedor@ejemplo.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Direcci√≥n</label>
                        <textarea id="proveedor-direccion" 
                                  placeholder="Direcci√≥n completa del proveedor"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Productos que Suministra</label>
                        <textarea id="proveedor-productos" 
                                  placeholder="Lista de productos: carb√≥n, productos de limpieza, desechables, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="proveedor-notas" 
                                  placeholder="Informaci√≥n adicional, t√©rminos de pago, d√≠as de entrega, etc."></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">üíæ Guardar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal('proveedor')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // JavaScript integrado en el mismo archivo
    </script>
    <script>
// ==============================================
// ALMACENAMIENTO LOCAL
// ==============================================
const storage = {
    productos: JSON.parse(localStorage.getItem('bodega_productos') || '[]'),
    movimientos: JSON.parse(localStorage.getItem('bodega_movimientos') || '[]'),
    proveedores: JSON.parse(localStorage.getItem('bodega_proveedores') || '[]'),
    inventario: JSON.parse(localStorage.getItem('bodega_inventario') || '{}')
};

console.log('üîß STORAGE INICIAL CARGADO:');
console.log('- Productos:', storage.productos.length);
console.log('- Movimientos:', storage.movimientos.length);
console.log('- Proveedores:', storage.proveedores.length);
console.log('- Movimientos detalle:', storage.movimientos);

let camposPersistentes = {
    responsable: '',
    fecha: ''
};

// ==============================================
// INICIALIZACI√ìN
// ==============================================
document.addEventListener('DOMContentLoaded', function() {
    inicializarDatos();
    
    // ‚úÖ RECALCULAR INVENTARIO si hay movimientos pero inventario vac√≠o o desincronizado
    if (storage.movimientos.length > 0) {
        console.log('üîç Verificando sincronizaci√≥n de inventario...');
        console.log('- Movimientos registrados:', storage.movimientos.length);
        console.log('- Items en inventario:', Object.keys(storage.inventario).length);
        
        // Siempre recalcular para asegurar sincronizaci√≥n
        recalcularInventarioDesdeMovimientos();
    }
    
    cargarSelects();
    actualizarEstadisticas();
    actualizarTablas();
    establecerFechaHoy();
    calcularCostoTotal();
    cargarProductosConteo();
    cargarTablaConteos();
    
    // Establecer fecha de hoy en conteo
    const fechaConteo = document.getElementById('conteo-fecha');
    if (fechaConteo) {
        fechaConteo.value = new Date().toISOString().split('T')[0];
    }
});

// ==============================================
// FUNCI√ìN PARA CAMBIAR ENTRE PESTA√ëAS
// ==============================================
function showTab(tabId) {
    // Ocultar todos los tab-content
    const allTabs = document.querySelectorAll('.tab-content');
    allTabs.forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Mostrar el tab seleccionado
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.add('active');
    }
    
    // Actualizar botones de tabs
    const allButtons = document.querySelectorAll('.tab');
    allButtons.forEach(button => {
        button.classList.remove('active');
    });
    
    // Marcar bot√≥n activo
    const activeButton = document.querySelector(`button[onclick="showTab('${tabId}')"]`);
    if (activeButton) {
        activeButton.classList.add('active');
    }

    // ‚úÖ AUTO-LLENAR FECHA Y RESPONSABLE EN CONTEO F√çSICO
    if (tabId === 'conteo') {
        cargarTablaConteos();
        if (!document.getElementById('conteo-fecha').value) {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('conteo-fecha').value = hoy;
        }
        if (camposPersistentes.responsable && !document.getElementById('conteo-responsable').value) {
            document.getElementById('conteo-responsable').value = camposPersistentes.responsable;
        }
    }
}

function inicializarDatos() {
    // Inicializar con productos de ejemplo si no hay datos
    if (storage.productos.length === 0) {
        cargarProductosEjemploInicial();
    }

    // Inicializar proveedores de ejemplo
    if (storage.proveedores.length === 0) {
        const proveedoresIniciales = [
            {
                id: 1,
                codigo: 'PROV-CARB-001',
                nombre: 'Carbonera El Buen Asado',
                nit: '',
                contacto: 'Proveedor de Carb√≥n',
                telefono: '3101234567',
                email: '',
                direccion: 'C√∫cuta, Norte de Santander',
                productos: 'Carb√≥n vegetal, carb√≥n de madera, le√±a',
                notas: 'Entrega cada 3 d√≠as. Pedido m√≠nimo: 5 bultos'
            },
            {
                id: 2,
                codigo: 'PROV-LIMP-001',
                nombre: 'Distribuidora La Econ√≥mica',
                nit: '',
                contacto: '√Årea de Aseo',
                telefono: '3209876543',
                email: 'laeconomica@email.com',
                direccion: 'Centro, C√∫cuta',
                productos: 'Productos de limpieza, desinfectantes, escobas, trapeadores',
                notas: 'Cr√©dito 30 d√≠as. Entrega a domicilio sin costo'
            },
            {
                id: 3,
                codigo: 'PROV-DESE-001',
                nombre: 'Empaques y Desechables del Norte',
                nit: '',
                contacto: 'Ventas',
                telefono: '3156789012',
                email: '',
                direccion: 'Av. Libertadores, C√∫cuta',
                productos: 'Bolsas, cajas para domicilio, servilletas, vasos desechables',
                notas: 'Mayorista. Pedido m√≠nimo: $100.000'
            }
        ];
        
        storage.proveedores = proveedoresIniciales;
        localStorage.setItem('bodega_proveedores', JSON.stringify(storage.proveedores));
    }
}

function cargarProductosEjemploInicial() {
    const productosEjemplo = [
        {id: 1, codigo: 'DEPO-001', nombre: 'Vasos plasticos 12 onzas', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 2, codigo: 'DEPO-002', nombre: 'Vasos con tapa 12 onzas', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 3, codigo: 'DEPO-003', nombre: 'Servilletas', categoria: 'desechables', unidad: 'Un', stock: 0, stockMinimo: 100, proveedor: 'PLASTICOS'},
        {id: 4, codigo: 'DEPO-004', nombre: 'Tarteros 1 onza', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 200, proveedor: 'PLASTICOS'},
        {id: 5, codigo: 'DEPO-005', nombre: 'Potes de 4 onzas', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 100, proveedor: 'PLASTICOS'},
        {id: 6, codigo: 'DEPO-006', nombre: 'Icopor P1', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 7, codigo: 'DEPO-007', nombre: 'Icopor J1', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 8, codigo: 'DEPO-008', nombre: 'Icopor C1', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 9, codigo: 'DEPO-009', nombre: 'Contenedor de 24onzas', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 10, codigo: 'DEPO-010', nombre: 'Contenedor de 16onzas', categoria: 'empaques', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 11, codigo: 'DEPO-011', nombre: 'Caja ref. #6 bajita', categoria: 'cajas', unidad: 'Un', stock: 0, stockMinimo: 30, proveedor: 'PLASTICOS'},
        {id: 12, codigo: 'DEPO-012', nombre: 'Caja ref. 4841 hamburguesa', categoria: 'cajas', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'},
        {id: 13, codigo: 'DEPO-013', nombre: 'Caja ref. #3 pollo', categoria: 'cajas', unidad: 'Un', stock: 0, stockMinimo: 50, proveedor: 'PLASTICOS'}
    ];

    // GUARDAR los productos en storage
    storage.productos = productosEjemplo;
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    
    console.log('‚úÖ Productos iniciales cargados: ' + storage.productos.length + ' productos');
}

// ==============================================
// ESTABLECER FECHA DE HOY EN FORMULARIOS
// ==============================================
function establecerFechaHoy() {
    const hoy = new Date().toISOString().split('T')[0];
    const campoEntrada = document.getElementById('entrada-fecha');
    const campoSalida = document.getElementById('salida-fecha');
    
    if (campoEntrada) campoEntrada.value = hoy;
    if (campoSalida) campoSalida.value = hoy;
}

// ==============================================
// CALCULAR COSTO TOTAL
// ==============================================
function calcularCostoTotal() {
    const cantidad = document.getElementById('entrada-cantidad');
    const costo = document.getElementById('entrada-costo');
    const costoTotal = document.getElementById('entrada-costo-total');

    [cantidad, costo].forEach(input => {
        input.addEventListener('input', () => {
            const cant = parseFloat(cantidad.value) || 0;
            const precio = parseFloat(costo.value) || 0;
            costoTotal.value = (cant * precio).toFixed(0);
        });
    });
}

// ==============================================
// CARGAR SELECTS DE PRODUCTOS Y PROVEEDORES
// ==============================================
function cargarSelects() {
    // Cargar productos en select de entrada
    const selectEntradaProducto = document.getElementById('entrada-producto');
    if (selectEntradaProducto) {
        selectEntradaProducto.innerHTML = '<option value="">Seleccione producto...</option>';
        storage.productos.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.id;
            option.textContent = `${prod.nombre} (${prod.codigo})`;
            selectEntradaProducto.appendChild(option);
        });
    }

    // Cargar productos en select de salida
    const selectSalidaProducto = document.getElementById('salida-producto');
    if (selectSalidaProducto) {
        selectSalidaProducto.innerHTML = '<option value="">Seleccione producto...</option>';
        storage.productos.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.id;
            option.textContent = `${prod.nombre} (${prod.codigo})`;
            selectSalidaProducto.appendChild(option);
        });
    }

    // Cargar proveedores en select
    const selectProveedor = document.getElementById('entrada-proveedor');
    if (selectProveedor) {
        selectProveedor.innerHTML = '<option value="">Seleccione proveedor...</option>';
        storage.proveedores.forEach(prov => {
            const option = document.createElement('option');
            option.value = prov.id;
            option.textContent = `${prov.nombre}`;
            selectProveedor.appendChild(option);
        });
    }
}

// ==============================================
// VERIFICAR STOCK
// ==============================================
function verificarStock(productoId) {
    const stockDisplay = document.getElementById('salida-stock-disponible');
    if (!productoId) {
        stockDisplay.value = '';
        return;
    }

    const producto = storage.productos.find(p => p.id == productoId);
    if (producto) {
        const stock = storage.inventario[productoId] || 0;
        stockDisplay.value = `${stock} ${producto.unidad}`;
        
        if (stock <= 0) {
            mostrarAlerta('‚ö†Ô∏è No hay stock disponible de este producto', 'warning');
        } else if (producto.stockMinimo && stock <= producto.stockMinimo) {
            mostrarAlerta(`‚ö†Ô∏è Stock bajo: ${stock} ${producto.unidad}`, 'warning');
        }
    }
}

// ==============================================
// REGISTRO DE ENTRADA
// ==============================================
function registrarEntrada(event) {
    event.preventDefault();

    const form = event.target;
    const editandoId = form.dataset.editandoId ? parseInt(form.dataset.editandoId) : null;

    const productoId = parseInt(document.getElementById('entrada-producto').value);
    const cantidad = parseFloat(document.getElementById('entrada-cantidad').value);
    const unidad = document.getElementById('entrada-unidad').value;
    const proveedorId = parseInt(document.getElementById('entrada-proveedor').value);
    const costoUnitario = parseFloat(document.getElementById('entrada-costo').value) || 0;
    const costoTotal = parseFloat(document.getElementById('entrada-costo-total').value) || 0;
    const fecha = document.getElementById('entrada-fecha').value;
    const responsable = document.getElementById('entrada-responsable').value.trim();
    const observaciones = document.getElementById('entrada-observaciones').value;

    if (!responsable) {
        mostrarAlerta('Por favor ingrese el nombre del responsable', 'error');
        return;
    }

    camposPersistentes.responsable = responsable;
    camposPersistentes.fecha = fecha;

    const producto = storage.productos.find(p => p.id === productoId);
    const proveedor = storage.proveedores.find(p => p.id === proveedorId);

    if (editandoId) {
        // MODO EDICI√ìN
        const movimientoAnterior = storage.movimientos.find(m => m.id === editandoId);
        if (!movimientoAnterior) {
            mostrarAlerta('‚ùå Error: Movimiento no encontrado', 'error');
            return;
        }

        // Revertir inventario anterior
        const productoAnterior = storage.productos.find(p => p.id === movimientoAnterior.productoId);
        if (productoAnterior) {
            productoAnterior.stock -= movimientoAnterior.cantidad;
            storage.inventario[movimientoAnterior.productoId] = (storage.inventario[movimientoAnterior.productoId] || 0) - movimientoAnterior.cantidad;
        }

        // Actualizar movimiento
        movimientoAnterior.productoId = productoId;
        movimientoAnterior.productoNombre = producto.nombre;
        movimientoAnterior.cantidad = cantidad;
        movimientoAnterior.unidad = unidad;
        movimientoAnterior.proveedorId = proveedorId;
        movimientoAnterior.proveedorNombre = proveedor.nombre;
        movimientoAnterior.costoUnitario = costoUnitario;
        movimientoAnterior.costoTotal = costoTotal;
        movimientoAnterior.fecha = fecha;
        movimientoAnterior.responsable = responsable;
        movimientoAnterior.observaciones = observaciones;
        movimientoAnterior.fechaModificacion = new Date().toISOString();

        // ‚úÖ APLICAR NUEVO INVENTARIO EN AMBOS LUGARES
        producto.stock = (producto.stock || 0) + cantidad;
        storage.inventario[productoId] = (storage.inventario[productoId] || 0) + cantidad;

        // Limpiar modo edici√≥n
        delete form.dataset.editandoId;

        mostrarAlerta('‚úÖ Entrada actualizada exitosamente', 'success');

    } else {
        // MODO CREACI√ìN
        const movimiento = {
            id: Date.now(),
            tipo: 'entrada',
            productoId: productoId,
            productoNombre: producto.nombre,
            cantidad: cantidad,
            unidad: unidad,
            proveedorId: proveedorId,
            proveedorNombre: proveedor.nombre,
            costoUnitario: costoUnitario,
            costoTotal: costoTotal,
            fecha: fecha,
            responsable: responsable,
            observaciones: observaciones,
            fechaRegistro: new Date().toISOString()
        };

        storage.movimientos.push(movimiento);
        console.log('‚úÖ ENTRADA CREADA:', movimiento);
        console.log('üìä Total movimientos en memoria:', storage.movimientos.length);

        // ‚úÖ ACTUALIZAR INVENTARIO EN AMBOS LUGARES
        producto.stock = (producto.stock || 0) + cantidad;
        storage.inventario[productoId] = (storage.inventario[productoId] || 0) + cantidad;

        mostrarAlerta('‚úÖ Entrada registrada exitosamente', 'success');
    }

    // Guardar cambios en localStorage
    localStorage.setItem('bodega_movimientos', JSON.stringify(storage.movimientos));
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    console.log('üíæ GUARDADO EN LOCALSTORAGE - Movimientos:', storage.movimientos.length);
    
    document.getElementById('entrada-producto').value = '';
    document.getElementById('entrada-cantidad').value = '';
    document.getElementById('entrada-unidad').value = 'unidades';
    document.getElementById('entrada-proveedor').value = '';
    document.getElementById('entrada-costo').value = '';
    document.getElementById('entrada-costo-total').value = '';
    document.getElementById('entrada-observaciones').value = '';
    
    actualizarTablas();
    actualizarEstadisticas();
}

// ==============================================
// REGISTRO DE SALIDA
// ==============================================
function registrarSalida(event) {
    event.preventDefault();

    const form = event.target;
    const editandoId = form.dataset.editandoId ? parseInt(form.dataset.editandoId) : null;

    const productoId = parseInt(document.getElementById('salida-producto').value);
    const cantidad = parseFloat(document.getElementById('salida-cantidad').value);
    const unidad = document.getElementById('salida-unidad').value;
    const area = document.getElementById('salida-area').value;
    const motivo = document.getElementById('salida-motivo').value;
    const fecha = document.getElementById('salida-fecha').value;
    const responsable = document.getElementById('salida-responsable').value.trim();
    const observaciones = document.getElementById('salida-observaciones').value;

    if (!responsable) {
        mostrarAlerta('Por favor ingrese el nombre del responsable', 'error');
        return;
    }

    camposPersistentes.responsable = responsable;
    camposPersistentes.fecha = fecha;

    const producto = storage.productos.find(p => p.id === productoId);

    if (editandoId) {
        // MODO EDICI√ìN
        const movimientoAnterior = storage.movimientos.find(m => m.id === editandoId);
        if (!movimientoAnterior) {
            mostrarAlerta('‚ùå Error: Movimiento no encontrado', 'error');
            return;
        }

        // Revertir inventario anterior (devolver lo que se hab√≠a restado)
        const productoAnterior = storage.productos.find(p => p.id === movimientoAnterior.productoId);
        if (productoAnterior) {
            productoAnterior.stock += movimientoAnterior.cantidad;
            storage.inventario[movimientoAnterior.productoId] = (storage.inventario[movimientoAnterior.productoId] || 0) + movimientoAnterior.cantidad;
        }

        // Verificar stock con la nueva cantidad
        const stockActual = storage.inventario[productoId] || 0;
        if (cantidad > stockActual) {
            mostrarAlerta('‚ùå La cantidad excede el stock disponible', 'error');
            // Revertir el cambio anterior
            if (productoAnterior) {
                productoAnterior.stock -= movimientoAnterior.cantidad;
                storage.inventario[movimientoAnterior.productoId] = (storage.inventario[movimientoAnterior.productoId] || 0) - movimientoAnterior.cantidad;
            }
            return;
        }

        // Actualizar movimiento
        movimientoAnterior.productoId = productoId;
        movimientoAnterior.productoNombre = producto.nombre;
        movimientoAnterior.cantidad = cantidad;
        movimientoAnterior.unidad = unidad;
        movimientoAnterior.area = area;
        movimientoAnterior.motivo = motivo;
        movimientoAnterior.fecha = fecha;
        movimientoAnterior.responsable = responsable;
        movimientoAnterior.observaciones = observaciones;
        movimientoAnterior.fechaModificacion = new Date().toISOString();

        // ‚úÖ APLICAR NUEVA SALIDA DE INVENTARIO EN AMBOS LUGARES
        producto.stock -= cantidad;
        storage.inventario[productoId] = (storage.inventario[productoId] || 0) - cantidad;

        // Limpiar modo edici√≥n
        delete form.dataset.editandoId;

        mostrarAlerta('‚úÖ Salida actualizada exitosamente', 'success');

    } else {
        // MODO CREACI√ìN
        // Verificar stock usando storage.inventario
        const stockActual = storage.inventario[productoId] || 0;
        if (cantidad > stockActual) {
            mostrarAlerta('‚ùå La cantidad excede el stock disponible', 'error');
            return;
        }

        const movimiento = {
            id: Date.now(),
            tipo: 'salida',
            productoId: productoId,
            productoNombre: producto.nombre,
            cantidad: cantidad,
            unidad: unidad,
            area: area,
            motivo: motivo,
            fecha: fecha,
            responsable: responsable,
            observaciones: observaciones,
            fechaRegistro: new Date().toISOString()
        };

        storage.movimientos.push(movimiento);

        // ‚úÖ ACTUALIZAR INVENTARIO EN AMBOS LUGARES
        producto.stock -= cantidad;
        storage.inventario[productoId] = (storage.inventario[productoId] || 0) - cantidad;

        mostrarAlerta('‚úÖ Salida registrada exitosamente', 'success');
    }

    // Guardar cambios en localStorage
    localStorage.setItem('bodega_movimientos', JSON.stringify(storage.movimientos));
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    
    document.getElementById('salida-producto').value = '';
    document.getElementById('salida-cantidad').value = '';
    document.getElementById('salida-unidad').value = 'unidades';
    document.getElementById('salida-area').value = '';
    document.getElementById('salida-motivo').value = '';
    document.getElementById('salida-observaciones').value = '';
    document.getElementById('salida-stock-disponible').value = '';
    
    actualizarTablas();
    actualizarEstadisticas();
}

// ==============================================
// REGISTRAR Y CONTINUAR
// ==============================================
function registrarYContinuar(tipo) {
    if (tipo === 'entrada') {
        const form = document.getElementById('form-entrada');
        const submitEvent = new Event('submit', { cancelable: true });
        form.dispatchEvent(submitEvent);
        
        setTimeout(() => {
            if (camposPersistentes.responsable) {
                document.getElementById('entrada-responsable').value = camposPersistentes.responsable;
            }
            if (camposPersistentes.fecha) {
                document.getElementById('entrada-fecha').value = camposPersistentes.fecha;
            }
        }, 100);
    } else if (tipo === 'salida') {
        const form = document.getElementById('form-salida');
        const submitEvent = new Event('submit', { cancelable: true });
        form.dispatchEvent(submitEvent);
        
        setTimeout(() => {
            if (camposPersistentes.responsable) {
                document.getElementById('salida-responsable').value = camposPersistentes.responsable;
            }
            if (camposPersistentes.fecha) {
                document.getElementById('salida-fecha').value = camposPersistentes.fecha;
            }
        }, 100);
    }
}

// ==============================================
// GESTI√ìN DE PRODUCTOS
// ==============================================
function abrirModalProducto(id = null) {
    const modal = document.getElementById('modal-producto');
    const titulo = document.getElementById('modal-producto-titulo');
    
    if (id) {
        titulo.textContent = 'Editar Producto';
        const producto = storage.productos.find(p => p.id === id);
        document.getElementById('producto-id').value = producto.id;
        document.getElementById('producto-codigo').value = producto.codigo;
        document.getElementById('producto-nombre').value = producto.nombre;
        document.getElementById('producto-categoria').value = producto.categoria;
        document.getElementById('producto-unidad').value = producto.unidad;
        document.getElementById('producto-stock').value = producto.stock || 0;
        document.getElementById('producto-stock-minimo').value = producto.stockMinimo || '';
        document.getElementById('producto-descripcion').value = producto.descripcion || '';
    } else {
        titulo.textContent = 'Nuevo Producto';
        document.getElementById('form-producto').reset();
        document.getElementById('producto-id').value = '';
    }
    
    modal.classList.add('active');
}

function guardarProducto(event) {
    event.preventDefault();

    const id = document.getElementById('producto-id').value;
    const producto = {
        id: id ? parseInt(id) : Date.now(),
        codigo: document.getElementById('producto-codigo').value,
        nombre: document.getElementById('producto-nombre').value,
        categoria: document.getElementById('producto-categoria').value,
        unidad: document.getElementById('producto-unidad').value,
        stock: parseFloat(document.getElementById('producto-stock').value) || 0,
        stockMinimo: parseFloat(document.getElementById('producto-stock-minimo').value) || null,
        descripcion: document.getElementById('producto-descripcion').value
    };

    if (id) {
        const index = storage.productos.findIndex(p => p.id === parseInt(id));
        storage.productos[index] = producto;
        mostrarAlerta('‚úÖ Producto actualizado exitosamente', 'success');
    } else {
        storage.productos.push(producto);
        storage.inventario[producto.id] = producto.stock;
        mostrarAlerta('‚úÖ Producto creado exitosamente', 'success');
    }

    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    
    cerrarModal('producto');
    
    cargarTablaProductos();
    actualizarEstadisticas();
}

function eliminarProducto(id) {
    if (!confirm('¬øEst√° seguro de eliminar este producto?')) return;

    storage.productos = storage.productos.filter(p => p.id !== id);
    delete storage.inventario[id];
    
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    
    mostrarAlerta('‚úÖ Producto eliminado exitosamente', 'success');
    
    cargarTablaProductos();
    actualizarEstadisticas();
}

function cargarProductosEjemplo() {
    if (storage.productos.length > 0) {
        if (!confirm('Ya tienes productos guardados. ¬øDeseas reemplazarlos con los productos de ejemplo del restaurante?')) {
            return;
        }
    }

    cargarProductosEjemploInicial();
    mostrarAlerta('‚úÖ Se cargaron 52 productos de ejemplo exitosamente', 'success');
    
    cargarTablaProductos();
}

// ==============================================
// GESTI√ìN DE PROVEEDORES
// ==============================================
function abrirModalProveedor(id = null) {
    const modal = document.getElementById('modal-proveedor');
    const titulo = document.getElementById('modal-proveedor-titulo');
    
    if (id) {
        titulo.textContent = 'Editar Proveedor';
        const proveedor = storage.proveedores.find(p => p.id === id);
        document.getElementById('proveedor-id').value = proveedor.id;
        document.getElementById('proveedor-codigo').value = proveedor.codigo;
        document.getElementById('proveedor-nombre').value = proveedor.nombre;
        document.getElementById('proveedor-nit').value = proveedor.nit || '';
        document.getElementById('proveedor-contacto').value = proveedor.contacto;
        document.getElementById('proveedor-telefono').value = proveedor.telefono;
        document.getElementById('proveedor-email').value = proveedor.email || '';
        document.getElementById('proveedor-direccion').value = proveedor.direccion || '';
        document.getElementById('proveedor-productos').value = proveedor.productos || '';
        document.getElementById('proveedor-notas').value = proveedor.notas || '';
    } else {
        titulo.textContent = 'Nuevo Proveedor';
        document.getElementById('form-proveedor').reset();
        document.getElementById('proveedor-id').value = '';
    }
    
    modal.classList.add('active');
}

function guardarProveedor(event) {
    event.preventDefault();

    const id = document.getElementById('proveedor-id').value;
    const proveedor = {
        id: id ? parseInt(id) : Date.now(),
        codigo: document.getElementById('proveedor-codigo').value,
        nombre: document.getElementById('proveedor-nombre').value,
        nit: document.getElementById('proveedor-nit').value,
        contacto: document.getElementById('proveedor-contacto').value,
        telefono: document.getElementById('proveedor-telefono').value,
        email: document.getElementById('proveedor-email').value,
        direccion: document.getElementById('proveedor-direccion').value,
        productos: document.getElementById('proveedor-productos').value,
        notas: document.getElementById('proveedor-notas').value
    };

    if (id) {
        const index = storage.proveedores.findIndex(p => p.id === parseInt(id));
        storage.proveedores[index] = proveedor;
        mostrarAlerta('‚úÖ Proveedor actualizado exitosamente', 'success');
    } else {
        storage.proveedores.push(proveedor);
        mostrarAlerta('‚úÖ Proveedor creado exitosamente', 'success');
    }

    localStorage.setItem('bodega_proveedores', JSON.stringify(storage.proveedores));
    
    cerrarModal('proveedor');
    
    cargarTablaProveedores();
    actualizarEstadisticas();
}

function eliminarProveedor(id) {
    if (!confirm('¬øEst√° seguro de eliminar este proveedor?')) return;

    storage.proveedores = storage.proveedores.filter(p => p.id !== id);
    localStorage.setItem('bodega_proveedores', JSON.stringify(storage.proveedores));
    
    mostrarAlerta('‚úÖ Proveedor eliminado exitosamente', 'success');
    
    cargarTablaProveedores();
    actualizarEstadisticas();
}

// ==============================================
// ACTUALIZAR TABLAS
// ==============================================
function cargarTablaProductos() {
    const tbody = document.getElementById('tabla-productos');
    
    if (storage.productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <div>
                        <h3>No hay productos registrados</h3>
                        <p>Presione "Nuevo Producto" o "Cargar Productos de Ejemplo"</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    storage.productos.forEach(producto => {
        const stock = storage.inventario[producto.id] || 0;
        let estadoStock = 'optimo';
        let textoStock = '√ìptimo';
        
        if (stock === 0) {
            estadoStock = 'bajo';
            textoStock = '‚ùå Agotado';
        } else if (producto.stockMinimo && stock <= producto.stockMinimo) {
            estadoStock = 'critico';
            textoStock = '‚ö†Ô∏è Cr√≠tico';
        }

        const categoriaLabel = {
            'carbon': 'üî• Carb√≥n',
            'limpieza': 'üß¥ Limpieza',
            'desinfectante': 'üßº Desinfectante',
            'cocina': 'üç≥ Cocina',
            'desechable': 'üì¶ Desechable',
            'uniforme': 'üëï Uniforme',
            'bolsa': 'üóëÔ∏è Bolsas',
            'papel': 'üßª Papel',
            'vajilla': 'üçΩÔ∏è Vajilla',
            'herramienta': 'üõ†Ô∏è Herramienta'
        };

        const row = `
            <tr>
                <td>${producto.codigo}</td>
                <td><strong>${producto.nombre}</strong></td>
                <td><span class="badge badge-${producto.categoria}">${categoriaLabel[producto.categoria]}</span></td>
                <td><strong>${stock}</strong></td>
                <td>${producto.unidad}</td>
                <td><span class="status ${estadoStock}">${textoStock}</span></td>
                <td>
                    <button class="action-btn edit" onclick="abrirModalProducto(${producto.id})">‚úèÔ∏è</button>
                    <button class="action-btn delete" onclick="eliminarProducto(${producto.id})">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function cargarTablaInventario() {
    const tbody = document.getElementById('tabla-inventario');
    
    if (storage.productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <div>
                        <h3>No hay inventario registrado</h3>
                        <p>Registre entradas de productos para ver el inventario</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    storage.productos.forEach(producto => {
        const stock = storage.inventario[producto.id] || 0;
        let estadoStock = 'optimo';
        let textoStock = '√ìptimo';
        
        if (stock === 0) {
            estadoStock = 'bajo';
            textoStock = '‚ùå Agotado';
        } else if (producto.stockMinimo && stock <= producto.stockMinimo) {
            estadoStock = 'critico';
            textoStock = '‚ö†Ô∏è Cr√≠tico';
        }

        const ultimosMovimientos = storage.movimientos
            .filter(m => m.productoId === producto.id)
            .sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));
        
        const ultimaActualizacion = ultimosMovimientos.length > 0 
            ? new Date(ultimosMovimientos[0].fechaRegistro).toLocaleString()
            : 'Sin movimientos';

        const categoriaLabel = {
            'carbon': 'üî• Carb√≥n',
            'limpieza': 'üß¥ Limpieza',
            'desinfectante': 'üßº Desinfectante',
            'cocina': 'üç≥ Cocina',
            'desechable': 'üì¶ Desechable',
            'uniforme': 'üëï Uniforme',
            'bolsa': 'üóëÔ∏è Bolsas',
            'papel': 'üßª Papel',
            'vajilla': 'üçΩÔ∏è Vajilla',
            'herramienta': 'üõ†Ô∏è Herramienta'
        };

        const row = `
            <tr>
                <td>${producto.codigo}</td>
                <td><strong>${producto.nombre}</strong></td>
                <td><span class="badge badge-${producto.categoria}">${categoriaLabel[producto.categoria]}</span></td>
                <td><strong>${stock}</strong></td>
                <td>${producto.unidad}</td>
                <td>${producto.stockMinimo || '-'}</td>
                <td><span class="status ${estadoStock}">${textoStock}</span></td>
                <td><small>${ultimaActualizacion}</small></td>
                <td>
                    <button class="action-btn edit" onclick="abrirModalProducto(${producto.id})" title="Editar producto">‚úèÔ∏è</button>
                    <button class="action-btn delete" onclick="eliminarProducto(${producto.id})" title="Eliminar producto">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function cargarTablaProveedores() {
    const tbody = document.getElementById('tabla-proveedores');
    
    if (storage.proveedores.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <div>
                        <h3>No hay proveedores registrados</h3>
                        <p>Presione "Nuevo Proveedor" para comenzar</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    storage.proveedores.forEach(proveedor => {
        const row = `
            <tr>
                <td>${proveedor.codigo}</td>
                <td><strong>${proveedor.nombre}</strong></td>
                <td>${proveedor.contacto}</td>
                <td>${proveedor.telefono}</td>
                <td>${proveedor.email || '-'}</td>
                <td><small>${proveedor.productos || '-'}</small></td>
                <td>
                    <button class="action-btn edit" onclick="abrirModalProveedor(${proveedor.id})">‚úèÔ∏è</button>
                    <button class="action-btn delete" onclick="eliminarProveedor(${proveedor.id})">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function cargarReportes() {
    const tbody = document.getElementById('tabla-reportes');
    
    console.log('üìã CARGANDO REPORTES');
    console.log('üìä Movimientos en storage:', storage.movimientos.length);
    console.log('üìä Movimientos:', storage.movimientos);
    
    if (storage.movimientos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="empty-state">
                    <div>
                        <h3>No hay movimientos registrados</h3>
                        <p>Los movimientos de entrada y salida aparecer√°n aqu√≠</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    const movimientosOrdenados = [...storage.movimientos].sort((a, b) => 
        new Date(b.fecha) - new Date(a.fecha)
    );
    
    console.log('üìä Movimientos ordenados:', movimientosOrdenados.length);

    movimientosOrdenados.forEach(mov => {
        const provArea = mov.tipo === 'entrada' 
            ? mov.proveedorNombre 
            : mov.area;

        const row = `
            <tr>
                <td>${mov.fecha}</td>
                <td><span class="status ${mov.tipo}">${mov.tipo.toUpperCase()}</span></td>
                <td><strong>${mov.productoNombre}</strong></td>
                <td>${mov.cantidad}</td>
                <td>${mov.unidad}</td>
                <td>${provArea}</td>
                <td>${mov.responsable}</td>
                <td><small>${mov.observaciones || '-'}</small></td>
                <td>
                    <button class="action-btn edit" onclick="editarMovimiento(${mov.id})" title="Editar">‚úèÔ∏è</button>
                    <button class="action-btn delete" onclick="eliminarMovimiento(${mov.id})" title="Eliminar">üóëÔ∏è</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// ==============================================
// ESTAD√çSTICAS
// ==============================================
function actualizarEstadisticas() {
    document.getElementById('stat-total-productos').textContent = storage.productos.length;
    
    const hoy = new Date();
    const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    const entradasMes = storage.movimientos.filter(m => 
        m.tipo === 'entrada' && new Date(m.fecha) >= primerDiaMes
    ).length;
    
    const salidasMes = storage.movimientos.filter(m => 
        m.tipo === 'salida' && new Date(m.fecha) >= primerDiaMes
    ).length;
    
    document.getElementById('stat-entradas-mes').textContent = entradasMes;
    document.getElementById('stat-salidas-mes').textContent = salidasMes;
    document.getElementById('stat-proveedores').textContent = storage.proveedores.length;
}

function actualizarTablas() {
    cargarTablaProductos();
    cargarTablaInventario();
    cargarTablaProveedores();
    cargarReportes();
}

// ==============================================
// FILTROS Y B√öSQUEDAS
// ==============================================
function filtrarProductos() {
    const busqueda = document.getElementById('buscar-producto').value.toLowerCase();
    const categoria = document.getElementById('filtro-categoria-producto').value;
    
    const tbody = document.getElementById('tabla-productos');
    const rows = tbody.getElementsByTagName('tr');
    
    Array.from(rows).forEach(row => {
        if (row.querySelector('.empty-state')) return;
        
        const nombre = row.cells[1]?.textContent.toLowerCase() || '';
        const cat = row.cells[2]?.querySelector('.badge')?.className.includes(categoria) || categoria === '';
        const matchBusqueda = nombre.includes(busqueda);
        
        if (matchBusqueda && (categoria === '' || cat)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function filtrarReportes() {
    const fechaInicio = document.getElementById('filtro-fecha-inicio').value;
    const fechaFin = document.getElementById('filtro-fecha-fin').value;
    const tipo = document.getElementById('filtro-tipo').value;
    const responsable = document.getElementById('filtro-responsable').value.toLowerCase();
    
    let movimientosFiltrados = [...storage.movimientos];
    
    if (fechaInicio) {
        movimientosFiltrados = movimientosFiltrados.filter(m => m.fecha >= fechaInicio);
    }
    if (fechaFin) {
        movimientosFiltrados = movimientosFiltrados.filter(m => m.fecha <= fechaFin);
    }
    if (tipo !== 'todos') {
        movimientosFiltrados = movimientosFiltrados.filter(m => m.tipo === tipo);
    }
    if (responsable) {
        movimientosFiltrados = movimientosFiltrados.filter(m => 
            m.responsable.toLowerCase().includes(responsable)
        );
    }
    
    const tbody = document.getElementById('tabla-reportes');
    tbody.innerHTML = '';
    
    if (movimientosFiltrados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <div>
                        <h3>No se encontraron movimientos</h3>
                        <p>Intente con otros filtros</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    movimientosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    movimientosFiltrados.forEach(mov => {
        const provArea = mov.tipo === 'entrada' 
            ? mov.proveedorNombre 
            : mov.area;

        const row = `
            <tr>
                <td>${mov.fecha}</td>
                <td><span class="status ${mov.tipo}">${mov.tipo.toUpperCase()}</span></td>
                <td><strong>${mov.productoNombre}</strong></td>
                <td>${mov.cantidad}</td>
                <td>${mov.unidad}</td>
                <td>${provArea}</td>
                <td>${mov.responsable}</td>
                <td><small>${mov.observaciones || '-'}</small></td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function limpiarFiltros() {
    document.getElementById('filtro-fecha-inicio').value = new Date(new Date().setDate(1)).toISOString().split('T')[0];
    document.getElementById('filtro-fecha-fin').value = new Date().toISOString().split('T')[0];
    document.getElementById('filtro-tipo').value = 'todos';
    document.getElementById('filtro-responsable').value = '';
    cargarReportes();
}

// ==============================================
// LIMPIAR TODO AHORA - VERSI√ìN AGRESIVA
// ==============================================
function limpiarTodoAHORA() {
    const confirmacion = prompt('‚ö†Ô∏è RESETEAR TODO EL SISTEMA\n\nEsto borrar√°:\n‚Ä¢ Todos los productos actuales (52)\n‚Ä¢ Todos los movimientos\n‚Ä¢ Todo el inventario\n‚Ä¢ Todos los proveedores\n\nY cargar√° los 13 productos nuevos.\n\nüëâ Escribe "SI" para confirmar:');
    
    if (confirmacion === 'SI' || confirmacion === 'si' || confirmacion === 'Si') {
        console.log('üóëÔ∏è LIMPIANDO TODO...');
        
        // Limpiar TODO el localStorage relacionado con bodega/deposito
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
            if (key.includes('bodega') || key.includes('deposito')) {
                localStorage.removeItem(key);
                console.log('Eliminado:', key);
            }
        });
        
        // Tambi√©n limpiar espec√≠ficamente estas claves
        localStorage.removeItem('bodega_productos');
        localStorage.removeItem('bodega_movimientos');
        localStorage.removeItem('bodega_inventario');
        localStorage.removeItem('bodega_proveedores');
        localStorage.removeItem('ultima_sync_inventario_bodega');
        
        console.log('‚úÖ localStorage limpiado');
        
        // Forzar recarga completa (sin cach√©)
        alert('‚úÖ TODO BORRADO\n\nLa p√°gina se recargar√° y ver√°s SOLO 13 productos nuevos.\n\nSi sigues viendo 52, cierra el navegador completamente y abre de nuevo.');
        
        // Recarga forzada
        window.location.href = window.location.href + '?t=' + Date.now();
    } else {
        alert('‚ùå Cancelado. No escribiste "SI".');
    }
}

// ==============================================
// LIMPIAR TODOS LOS DATOS (RESET)
// ==============================================
function limpiarTodosDatos() {
    if (confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto borrar√°:\n‚Ä¢ Todos los productos\n‚Ä¢ Todos los movimientos\n‚Ä¢ Todo el inventario\n‚Ä¢ Todos los proveedores\n\n¬øContinuar?')) {
        if (confirm('‚ö†Ô∏è √öLTIMA ADVERTENCIA\n\n¬øRealmente quieres borrar TODOS los datos del sistema?\n\nEsta acci√≥n NO se puede deshacer.')) {
            // Limpiar localStorage
            localStorage.removeItem('bodega_productos');
            localStorage.removeItem('bodega_movimientos');
            localStorage.removeItem('bodega_inventario');
            localStorage.removeItem('bodega_proveedores');
            
            // Recargar p√°gina
            alert('‚úÖ Datos eliminados. La p√°gina se recargar√° con los 13 productos nuevos.');
            location.reload();
        }
    }
}

// ==============================================
// CONTEO F√çSICO
// ==============================================

// Inicializar almacenamiento de conteos
if (!localStorage.getItem('bodega_conteos')) {
    localStorage.setItem('bodega_conteos', JSON.stringify([]));
}

function cargarProductosConteo() {
    const select = document.getElementById('conteo-producto');
    if (!select) return;
    
    select.innerHTML = '<option value="">Seleccione un producto...</option>';
    
    storage.productos.forEach(producto => {
        const option = document.createElement('option');
        option.value = producto.id;
        option.textContent = `${producto.nombre} (${producto.codigo})`;
        select.appendChild(option);
    });
}

// Cuando se selecciona un producto, mostrar cantidad del sistema
document.addEventListener('DOMContentLoaded', function() {
    const selectProducto = document.getElementById('conteo-producto');
    if (selectProducto) {
        selectProducto.addEventListener('change', function() {
            const productoId = parseInt(this.value);
            const cantidadFisicaInput = document.getElementById('conteo-cantidad-fisica');
            const cantidadSistemaInput = document.getElementById('conteo-cantidad-sistema');
            const diferenciaInput = document.getElementById('conteo-diferencia');
            
            if (productoId) {
                const producto = storage.productos.find(p => p.id === productoId);
                const cantidadSistema = storage.inventario[productoId] || 0;
                
                cantidadSistemaInput.value = `${cantidadSistema} ${producto.unidad}`;
                
                // Calcular diferencia cuando se ingrese cantidad f√≠sica
                cantidadFisicaInput.addEventListener('input', function() {
                    const cantidadFisica = parseFloat(this.value) || 0;
                    const diferencia = cantidadFisica - cantidadSistema;
                    diferenciaInput.value = `${diferencia > 0 ? '+' : ''}${diferencia.toFixed(2)} ${producto.unidad}`;
                    
                    // Color seg√∫n diferencia
                    if (Math.abs(diferencia) < 0.1) {
                        diferenciaInput.style.background = '#e8f5e9'; // Verde claro
                    } else if (Math.abs(diferencia) > 5) {
                        diferenciaInput.style.background = '#ffebee'; // Rojo claro
                    } else {
                        diferenciaInput.style.background = '#fff9c4'; // Amarillo
                    }
                });
            } else {
                cantidadSistemaInput.value = '';
                diferenciaInput.value = '';
            }
        });
    }
});

function registrarConteoFisico(event) {
    event.preventDefault();
    
    const productoId = parseInt(document.getElementById('conteo-producto').value);
    const cantidadFisica = parseFloat(document.getElementById('conteo-cantidad-fisica').value);
    const responsable = document.getElementById('conteo-responsable').value.trim();
    const fecha = document.getElementById('conteo-fecha').value;
    const observaciones = document.getElementById('conteo-observaciones').value;
    
    if (!productoId || !cantidadFisica || !responsable || !fecha) {
        mostrarAlerta('‚ö†Ô∏è Por favor complete todos los campos obligatorios', 'error');
        return;
    }

    // ‚úÖ GUARDAR CAMPOS PERSISTENTES
    camposPersistentes.responsable = responsable;
    camposPersistentes.fecha = fecha;
    
    const producto = storage.productos.find(p => p.id === productoId);
    const cantidadSistema = storage.inventario[productoId] || 0;
    const diferencia = cantidadFisica - cantidadSistema;
    const porcentajeDif = cantidadSistema > 0 ? ((diferencia / cantidadSistema) * 100).toFixed(2) : 0;
    
    // Obtener conteos existentes
    const conteos = JSON.parse(localStorage.getItem('bodega_conteos') || '[]');
    
    const conteo = {
        id: Date.now(),
        fecha: fecha,
        productoId: productoId,
        productoNombre: producto.nombre,
        productoCodigo: producto.codigo,
        unidad: producto.unidad,
        cantidadSistema: cantidadSistema,
        cantidadFisica: cantidadFisica,
        diferencia: diferencia,
        porcentajeDif: porcentajeDif,
        responsable: responsable,
        observaciones: observaciones,
        fechaRegistro: new Date().toISOString()
    };
    
    conteos.push(conteo);
    localStorage.setItem('bodega_conteos', JSON.stringify(conteos));
    
    mostrarAlerta('‚úÖ Conteo f√≠sico registrado exitosamente', 'success');
    
    // ‚úÖ LIMPIAR SOLO CAMPOS DE PRODUCTO - MANTENER RESPONSABLE Y FECHA
    document.getElementById('conteo-producto').value = '';
    document.getElementById('conteo-cantidad-fisica').value = '';
    document.getElementById('conteo-observaciones').value = '';
    document.getElementById('conteo-cantidad-sistema').value = '';
    document.getElementById('conteo-diferencia').value = '';
    document.getElementById('conteo-diferencia').style.background = '#fff9c4';

    // ‚úÖ RESTAURAR RESPONSABLE Y FECHA (mantienen valores)
    document.getElementById('conteo-responsable').value = camposPersistentes.responsable;
    document.getElementById('conteo-fecha').value = camposPersistentes.fecha;
    
    // Recargar tabla
    cargarTablaConteos();
}

function cargarTablaConteos() {
    const tbody = document.getElementById('tabla-conteos');
    if (!tbody) return;
    
    const conteos = JSON.parse(localStorage.getItem('bodega_conteos') || '[]');
    
    if (conteos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" style="text-align:center;padding:20px;color:#999;">
                    No hay conteos registrados
                </td>
            </tr>
        `;
        return;
    }
    
    // Ordenar por fecha descendente
    conteos.sort((a, b) => new Date(b.fechaRegistro) - new Date(a.fechaRegistro));
    
    tbody.innerHTML = '';
    conteos.forEach(conteo => {
        const diferencia = conteo.diferencia;
        let colorDif = '#fff9c4'; // Amarillo por defecto
        
        if (Math.abs(diferencia) < 0.1) {
            colorDif = '#e8f5e9'; // Verde
        } else if (Math.abs(diferencia) > 5) {
            colorDif = '#ffebee'; // Rojo
        }
        
        const row = `
            <tr>
                <td>${conteo.fecha}</td>
                <td><strong>${conteo.productoNombre}</strong><br><small>${conteo.productoCodigo}</small></td>
                <td>${conteo.cantidadSistema} ${conteo.unidad}</td>
                <td>${conteo.cantidadFisica} ${conteo.unidad}</td>
                <td style="background:${colorDif};font-weight:bold;">
                    ${diferencia > 0 ? '+' : ''}${diferencia.toFixed(2)} ${conteo.unidad}
                </td>
                <td style="background:${colorDif};">${conteo.porcentajeDif}%</td>
                <td>${conteo.responsable}</td>
                <td>${conteo.observaciones || '-'}</td>
                <td>
                    <button class="action-btn delete" onclick="eliminarConteo(${conteo.id})" title="Eliminar">
                        üóëÔ∏è
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function eliminarConteo(id) {
    if (!confirm('¬øEliminar este conteo?')) return;
    
    let conteos = JSON.parse(localStorage.getItem('bodega_conteos') || '[]');
    conteos = conteos.filter(c => c.id !== id);
    localStorage.setItem('bodega_conteos', JSON.stringify(conteos));
    
    mostrarAlerta('‚úÖ Conteo eliminado', 'success');
    cargarTablaConteos();
}

function exportarConteoFisico() {
    const conteos = JSON.parse(localStorage.getItem('bodega_conteos') || '[]');
    
    if (conteos.length === 0) {
        mostrarAlerta('‚ö†Ô∏è No hay conteos para exportar', 'warning');
        return;
    }
    
    const datos = [
        ['CONTEO F√çSICO - DEP√ìSITO GENERAL - EL RINC√ìN DEL BARRIL'],
        ['Fecha de Exportaci√≥n:', new Date().toLocaleString('es-CO')],
        [],
        ['Fecha', 'C√≥digo', 'Producto', 'Cant. Sistema', 'Cant. F√≠sica', 'Diferencia', '% Dif', 'Unidad', 'Responsable', 'Observaciones']
    ];
    
    conteos.forEach(conteo => {
        datos.push([
            conteo.fecha,
            conteo.productoCodigo,
            conteo.productoNombre,
            conteo.cantidadSistema,
            conteo.cantidadFisica,
            conteo.diferencia,
            conteo.porcentajeDif + '%',
            conteo.unidad,
            conteo.responsable,
            conteo.observaciones || ''
        ]);
    });
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datos);
    
    // Ajustar ancho de columnas
    const colWidths = datos[3].map((_, i) => {
        const maxLength = Math.max(...datos.map(row => row[i] ? String(row[i]).length : 0));
        return { wch: Math.min(Math.max(maxLength + 2, 10), 50) };
    });
    ws['!cols'] = colWidths;
    
    // Agregar hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, 'Conteo F√≠sico');
    
    // Descargar archivo
    const nombreArchivo = `Conteo_Fisico_Deposito_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(wb, nombreArchivo);
    
    mostrarAlerta('üì• Conteo f√≠sico exportado exitosamente', 'success');
}

// ==============================================
// EXPORTAR A EXCEL
// ==============================================
function exportarExcel(tipo) {
    let datos = [];
    let nombreArchivo = '';
    let nombreHoja = '';
    
    if (tipo === 'completo' || tipo === 'filtrado') {
        nombreArchivo = `Reporte_Movimientos_Deposito_${new Date().toISOString().split('T')[0]}.xlsx`;
        nombreHoja = 'Movimientos';
        
        let movimientos = [...storage.movimientos];
        if (tipo === 'filtrado') {
            const fechaInicio = document.getElementById('filtro-fecha-inicio').value;
            const fechaFin = document.getElementById('filtro-fecha-fin').value;
            const tipoFiltro = document.getElementById('filtro-tipo').value;
            const responsable = document.getElementById('filtro-responsable').value.toLowerCase();
            
            if (fechaInicio) movimientos = movimientos.filter(m => m.fecha >= fechaInicio);
            if (fechaFin) movimientos = movimientos.filter(m => m.fecha <= fechaFin);
            if (tipoFiltro !== 'todos') movimientos = movimientos.filter(m => m.tipo === tipoFiltro);
            if (responsable) movimientos = movimientos.filter(m => m.responsable.toLowerCase().includes(responsable));
        }
        
        datos = [
            ['REPORTE DE MOVIMIENTOS - DEPOSITO GENERAL - EL RINC√ìN DEL BARRIL'],
            ['Fecha de Generaci√≥n:', new Date().toLocaleString('es-CO')],
            [],
            ['Fecha', 'Tipo', 'Producto', 'Cantidad', 'Unidad', 'Proveedor/√Årea', 'Responsable', 'Costo Total', 'Observaciones']
        ];
        
        movimientos.forEach(mov => {
            datos.push([
                mov.fecha,
                mov.tipo.toUpperCase(),
                mov.productoNombre,
                mov.cantidad,
                mov.unidad,
                mov.tipo === 'entrada' ? mov.proveedorNombre : mov.area,
                mov.responsable,
                mov.costoTotal || '',
                mov.observaciones || ''
            ]);
        });
    } else if (tipo === 'inventario') {
        nombreArchivo = `Inventario_Deposito_${new Date().toISOString().split('T')[0]}.xlsx`;
        nombreHoja = 'Inventario';
        
        datos = [
            ['INVENTARIO ACTUAL - DEPOSITO GENERAL - EL RINC√ìN DEL BARRIL'],
            ['Fecha de Generaci√≥n:', new Date().toLocaleString('es-CO')],
            [],
            ['C√≥digo', 'Producto', 'Categor√≠a', 'Stock Actual', 'Unidad', 'Stock M√≠nimo', 'Estado']
        ];
        
        storage.productos.forEach(producto => {
            const stock = storage.inventario[producto.id] || 0;
            let estado = '√ìptimo';
            if (stock === 0) estado = 'Agotado';
            else if (producto.stockMinimo && stock <= producto.stockMinimo) estado = 'Cr√≠tico';
            
            datos.push([
                producto.codigo,
                producto.nombre,
                producto.categoria,
                stock,
                producto.unidad,
                producto.stockMinimo || '-',
                estado
            ]);
        });
    }
    
    // Crear libro de Excel
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(datos);
    
    // Ajustar ancho de columnas
    const colWidths = datos[3].map((_, i) => {
        const maxLength = Math.max(
            ...datos.map(row => row[i] ? String(row[i]).length : 0)
        );
        return { wch: Math.min(Math.max(maxLength + 2, 10), 50) };
    });
    ws['!cols'] = colWidths;
    
    // Agregar hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
    
    // Descargar archivo
    XLSX.writeFile(wb, nombreArchivo);
    
    mostrarAlerta('üì• Archivo Excel exportado exitosamente', 'success');
}

// ==============================================
// ALERTAS DE STOCK
// ==============================================
function generarAlertasStock() {
    const alertas = [];
    
    storage.productos.forEach(producto => {
        const stock = storage.inventario[producto.id] || 0;
        
        if (stock === 0) {
            alertas.push({
                tipo: 'agotado',
                producto: producto.nombre,
                categoria: producto.categoria,
                stock: stock,
                unidad: producto.unidad
            });
        } else if (producto.stockMinimo && stock <= producto.stockMinimo) {
            alertas.push({
                tipo: 'critico',
                producto: producto.nombre,
                categoria: producto.categoria,
                stock: stock,
                unidad: producto.unidad,
                minimo: producto.stockMinimo
            });
        }
    });
    
    if (alertas.length === 0) {
        mostrarAlerta('‚úÖ No hay alertas de stock. Todo est√° en niveles √≥ptimos.', 'success');
        return;
    }
    
    // Agrupar por categor√≠a
    const alertasPorCategoria = {
        'carbon': [],
        'otros': []
    };
    
    alertas.forEach(alerta => {
        if (alerta.categoria === 'carbon') {
            alertasPorCategoria.carbon.push(alerta);
        } else {
            alertasPorCategoria.otros.push(alerta);
        }
    });
    
    let mensaje = 'ALERTAS DE STOCK:\n\n';
    
    if (alertasPorCategoria.carbon.length > 0) {
        mensaje += 'üî• CR√çTICO - CARB√ìN Y COMBUSTIBLES:\n';
        alertasPorCategoria.carbon.forEach(alerta => {
            if (alerta.tipo === 'agotado') {
                mensaje += `‚ùå ${alerta.producto}: AGOTADO (0 ${alerta.unidad}) - ¬°SIN CARB√ìN NO HAY PARRILLA!\n`;
            } else {
                mensaje += `‚ö†Ô∏è ${alerta.producto}: ${alerta.stock} ${alerta.unidad} (M√≠nimo: ${alerta.minimo})\n`;
            }
        });
        mensaje += '\n';
    }
    
    if (alertasPorCategoria.otros.length > 0) {
        mensaje += 'OTROS PRODUCTOS:\n';
        alertasPorCategoria.otros.forEach(alerta => {
            if (alerta.tipo === 'agotado') {
                mensaje += `‚ùå ${alerta.producto}: AGOTADO (0 ${alerta.unidad})\n`;
            } else {
                mensaje += `‚ö†Ô∏è ${alerta.producto}: ${alerta.stock} ${alerta.unidad} (M√≠nimo: ${alerta.minimo})\n`;
            }
        });
    }
    
    alert(mensaje);
}

// ==============================================
// EDITAR Y ELIMINAR MOVIMIENTOS
// ==============================================
function editarMovimiento(id) {
    const movimiento = storage.movimientos.find(m => m.id === id);
    if (!movimiento) {
        mostrarAlerta('‚ùå Movimiento no encontrado', 'error');
        return;
    }

    if (movimiento.tipo === 'entrada') {
        // Pre-llenar formulario de entrada
        document.getElementById('entrada-producto').value = movimiento.productoId;
        document.getElementById('entrada-proveedor').value = movimiento.proveedorId;
        document.getElementById('entrada-cantidad').value = movimiento.cantidad;
        document.getElementById('entrada-unidad').value = movimiento.unidad;
        document.getElementById('entrada-costo').value = movimiento.costoUnitario || '';
        document.getElementById('entrada-costo-total').value = movimiento.costoTotal || '';
        document.getElementById('entrada-fecha').value = movimiento.fecha;
        document.getElementById('entrada-responsable').value = movimiento.responsable;
        document.getElementById('entrada-observaciones').value = movimiento.observaciones || '';

        // Cambiar a tab de entrada
        showTab('entrada');
        
        // Guardar ID para actualizar en lugar de crear nuevo
        document.getElementById('form-entrada').dataset.editandoId = id;
        
        mostrarAlerta('üìù Editando entrada. Modifica los campos y guarda los cambios.', 'info');
        
    } else if (movimiento.tipo === 'salida') {
        // Pre-llenar formulario de salida
        document.getElementById('salida-producto').value = movimiento.productoId;
        verificarStock(movimiento.productoId);
        document.getElementById('salida-cantidad').value = movimiento.cantidad;
        document.getElementById('salida-unidad').value = movimiento.unidad;
        document.getElementById('salida-area').value = movimiento.area;
        document.getElementById('salida-fecha').value = movimiento.fecha;
        document.getElementById('salida-responsable').value = movimiento.responsable;
        document.getElementById('salida-observaciones').value = movimiento.observaciones || '';

        // Cambiar a tab de salida
        showTab('salida');
        
        // Guardar ID para actualizar en lugar de crear nuevo
        document.getElementById('form-salida').dataset.editandoId = id;
        
        mostrarAlerta('üìù Editando salida. Modifica los campos y guarda los cambios.', 'info');
    }

    // Scroll al formulario
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function eliminarMovimiento(id) {
    const movimiento = storage.movimientos.find(m => m.id === id);
    if (!movimiento) {
        mostrarAlerta('‚ùå Movimiento no encontrado', 'error');
        return;
    }

    const tipo = movimiento.tipo.toUpperCase();
    const confirmMsg = `¬øEliminar este ${tipo}?

üìÖ Fecha: ${movimiento.fecha}
üì¶ Producto: ${movimiento.productoNombre}
üìä Cantidad: ${movimiento.cantidad} ${movimiento.unidad}
üë§ Responsable: ${movimiento.responsable}

‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.
‚ö†Ô∏è El inventario se ajustar√° autom√°ticamente.`;

    if (!confirm(confirmMsg)) return;

    // Revertir el movimiento en el inventario
    const producto = storage.productos.find(p => p.id === movimiento.productoId);
    if (producto) {
        if (movimiento.tipo === 'entrada') {
            // Restar cantidad que se hab√≠a sumado
            producto.stock -= movimiento.cantidad;
            storage.inventario[movimiento.productoId] = (storage.inventario[movimiento.productoId] || 0) - movimiento.cantidad;
        } else if (movimiento.tipo === 'salida') {
            // Sumar cantidad que se hab√≠a restado
            producto.stock += movimiento.cantidad;
            storage.inventario[movimiento.productoId] = (storage.inventario[movimiento.productoId] || 0) + movimiento.cantidad;
        }
    }

    // Eliminar movimiento
    storage.movimientos = storage.movimientos.filter(m => m.id !== id);
    
    // Guardar cambios en localStorage
    localStorage.setItem('bodega_movimientos', JSON.stringify(storage.movimientos));
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    
    actualizarTablas();
    actualizarEstadisticas();
    mostrarAlerta(`‚úÖ ${tipo} eliminado correctamente`, 'success');
}

// ==============================================
// UTILIDADES
// ==============================================

// ‚úÖ FUNCI√ìN PARA RECALCULAR INVENTARIO DESDE MOVIMIENTOS
function recalcularInventarioDesdeMovimientos() {
    console.log('üîÑ RECALCULANDO INVENTARIO desde movimientos...');
    
    // Limpiar inventario actual
    storage.inventario = {};
    
    // Inicializar todos los productos con stock 0
    storage.productos.forEach(producto => {
        storage.inventario[producto.id] = 0;
        producto.stock = 0;
    });
    
    // Procesar todos los movimientos en orden cronol√≥gico
    const movimientosOrdenados = [...storage.movimientos].sort((a, b) => 
        new Date(a.fechaRegistro || a.fecha) - new Date(b.fechaRegistro || b.fecha)
    );
    
    movimientosOrdenados.forEach(mov => {
        if (mov.tipo === 'entrada') {
            storage.inventario[mov.productoId] = (storage.inventario[mov.productoId] || 0) + mov.cantidad;
        } else if (mov.tipo === 'salida') {
            storage.inventario[mov.productoId] = (storage.inventario[mov.productoId] || 0) - mov.cantidad;
        }
    });
    
    // Sincronizar producto.stock con inventario
    storage.productos.forEach(producto => {
        producto.stock = storage.inventario[producto.id] || 0;
    });
    
    // Guardar
    localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
    localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
    
    console.log('‚úÖ INVENTARIO RECALCULADO:', storage.inventario);
    console.log('‚úÖ Total movimientos procesados:', movimientosOrdenados.length);
    
    // Actualizar tablas
    actualizarTablas();
    actualizarEstadisticas();
    
    mostrarAlerta('‚úÖ Inventario recalculado exitosamente desde ' + movimientosOrdenados.length + ' movimientos', 'success');
}

// ==============================================
function limpiarFormulario(tipo) {
    if (tipo === 'entrada') {
        const responsable = document.getElementById('entrada-responsable').value;
        const fecha = document.getElementById('entrada-fecha').value;
        
        document.getElementById('form-entrada').reset();
        
        if (camposPersistentes.responsable) {
            document.getElementById('entrada-responsable').value = camposPersistentes.responsable;
        }
        if (camposPersistentes.fecha) {
            document.getElementById('entrada-fecha').value = camposPersistentes.fecha;
        } else {
            establecerFechaHoy();
        }
    } else if (tipo === 'salida') {
        const responsable = document.getElementById('salida-responsable').value;
        const fecha = document.getElementById('salida-fecha').value;
        
        document.getElementById('form-salida').reset();
        document.getElementById('salida-stock-disponible').value = '';
        
        if (camposPersistentes.responsable) {
            document.getElementById('salida-responsable').value = camposPersistentes.responsable;
        }
        if (camposPersistentes.fecha) {
            document.getElementById('salida-fecha').value = camposPersistentes.fecha;
        } else {
            establecerFechaHoy();
        }
    }
}

function cerrarModal(tipo) {
    document.getElementById(`modal-${tipo}`).classList.remove('active');
    document.getElementById(`form-${tipo}`).reset();
}

function mostrarAlerta(mensaje, tipo) {
    const container = document.getElementById('alert-container');
    const alert = document.createElement('div');
    alert.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'error' : 'warning'} show`;
    alert.textContent = mensaje;
    
    container.innerHTML = '';
    container.appendChild(alert);
    
    setTimeout(() => {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 300);
    }, 5000);
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.classList.remove('active');
    }
}
    
        // ==============================================
        // CREACI√ìN R√ÅPIDA (SIN SALIR DEL FORMULARIO)
        // ==============================================

        function abrirCreacionRapidaProducto() {
            document.getElementById('modal-rapido-producto').classList.add('active');
            document.getElementById('rapido-producto-nombre').focus();
        }

        function abrirCreacionRapidaProveedor() {
            document.getElementById('modal-rapido-proveedor').classList.add('active');
            document.getElementById('rapido-proveedor-nombre').focus();
        }

        function cerrarModalRapido(tipo) {
            document.getElementById(`modal-rapido-${tipo}`).classList.remove('active');
            document.getElementById(`form-rapido-${tipo}`).reset();
        }

        function guardarProductoRapido(event) {
            event.preventDefault();

            const codigo = 'PROD-' + Date.now();
            const nombre = document.getElementById('rapido-producto-nombre').value;
            const categoria = document.getElementById('rapido-producto-categoria').value;
            const unidad = document.getElementById('rapido-producto-unidad').value;
            const stockInicial = parseFloat(document.getElementById('rapido-producto-stock').value) || 0;

            const nuevoProducto = {
                id: Date.now(),
                codigo: codigo,
                nombre: nombre,
                categoria: categoria,
                unidad: unidad,
                stock: stockInicial,
                stockMinimo: null,
                descripcion: 'Creado con creaci√≥n r√°pida - Edite para agregar m√°s detalles'
            };

            storage.productos.push(nuevoProducto);
            localStorage.setItem('bodega_productos', JSON.stringify(storage.productos));
            storage.inventario[nuevoProducto.id] = stockInicial;
            localStorage.setItem('bodega_inventario', JSON.stringify(storage.inventario));
            
            // Si hay stock inicial, registrar como entrada inicial
            if (stockInicial > 0) {
                const movimientoInicial = {
                    id: Date.now() + 1,
                    tipo: 'entrada',
                    productoId: nuevoProducto.id,
                    productoNombre: nuevoProducto.nombre,
                    cantidad: stockInicial,
                    unidad: unidad,
                    proveedorId: null,
                    proveedorNombre: 'Stock Inicial',
                    costo: 0,
                    costoTotal: 0,
                    fecha: new Date().toISOString().split('T')[0],
                    responsable: 'Sistema - Creaci√≥n Inicial',
                    observaciones: 'Stock inicial al crear el producto',
                    fechaRegistro: new Date().toISOString()
                };
                storage.movimientos.push(movimientoInicial);
                localStorage.setItem('bodega_movimientos', JSON.stringify(storage.movimientos));
            }

            
            document.getElementById('entrada-producto').value = nuevoProducto.id;

            cerrarModalRapido('producto');
            mostrarAlerta(`‚úÖ Producto "${nombre}" creado y seleccionado`, 'success');
        }

        function guardarProveedorRapido(event) {
            event.preventDefault();

            const codigo = 'PROV-' + Date.now();
            const nombre = document.getElementById('rapido-proveedor-nombre').value;
            const contacto = document.getElementById('rapido-proveedor-contacto').value;
            const telefono = document.getElementById('rapido-proveedor-telefono').value;

            const nuevoProveedor = {
                id: Date.now(),
                codigo: codigo,
                nombre: nombre,
                nit: '',
                contacto: contacto,
                telefono: telefono,
                email: '',
                direccion: '',
                productos: '',
                notas: 'Creado con creaci√≥n r√°pida - Edite para agregar m√°s detalles'
            };

            storage.proveedores.push(nuevoProveedor);
            localStorage.setItem('bodega_proveedores', JSON.stringify(storage.proveedores));

            
            document.getElementById('entrada-proveedor').value = nuevoProveedor.id;

            cerrarModalRapido('proveedor');
            mostrarAlerta(`‚úÖ Proveedor "${nombre}" creado y seleccionado`, 'success');
        }



        // ============================================
        // SINCRONIZACI√ìN CON GOOGLE SHEETS - INVENTARIO BODEGA
        // ============================================
        
        const GOOGLE_SCRIPT_URL = 'PEGAR_AQUI_LA_URL_DEL_GOOGLE_SCRIPT';
        
        async function sincronizarInventarioConGoogleSheets() {
            if (GOOGLE_SCRIPT_URL === 'PEGAR_AQUI_LA_URL_DEL_GOOGLE_SCRIPT') {
                alert('‚ö†Ô∏è Debes configurar la URL del Google Script en el c√≥digo');
                return;
            }
            
            const btnSync = document.getElementById('btn-sync-sheets');
            if (!btnSync) return;
            
            btnSync.disabled = true;
            btnSync.textContent = '‚è≥ Sincronizando...';
            btnSync.style.background = '#FFC107';
            
            try {
                const productosStorage = JSON.parse(localStorage.getItem('bodega_productos')) || [];
                const inventario = JSON.parse(localStorage.getItem('bodega_inventario')) || {};
                
                if (productosStorage.length === 0) {
                    alert('‚ö†Ô∏è No hay inventario para sincronizar');
                    return;
                }
                
                const productos = productosStorage.map(prod => ({
                    codigo: prod.id,
                    nombre: prod.nombre,
                    categoria: prod.categoria,
                    stock: inventario[prod.id] || 0,
                    unidad: prod.unidadMedida || 'unidades',
                    stockMinimo: prod.stockMinimo || 0
                }));
                
                const datos = {
                    accion: 'sync_inventario_bodega',
                    productos: productos,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Enviando inventario bodega:', productos.length, 'productos');
                
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                
                localStorage.setItem('ultima_sync_inventario_bodega', new Date().toISOString());
                mostrarNotificacionSync('‚úÖ Sincronizaci√≥n Exitosa', 'Inventario Deposito enviado a Google Sheets', 'success');
                actualizarInfoSyncDeposito();
                
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacionSync('‚ùå Error al Sincronizar', error.message, 'error');
            } finally {
                btnSync.disabled = false;
                btnSync.textContent = '‚òÅÔ∏è Sincronizar Inventario';
                btnSync.style.background = '#FF9800';
            }
        }
        
        function mostrarNotificacionSync(titulo, mensaje, tipo) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${tipo === 'success' ? '#4CAF50' : '#f44336'};
                color: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 16px;
            `;
            notif.innerHTML = `<strong>${titulo}</strong><br><span style="font-size: 14px;">${mensaje}</span>`;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        function agregarBotonSyncDeposito() {
            const headerRight = document.querySelector('.header-right');
            if (!headerRight) return;
            
            const btnContainer = document.createElement('div');
            btnContainer.style.cssText = 'margin-left: 15px;';
            
            const btn = document.createElement('button');
            btn.id = 'btn-sync-sheets';
            btn.textContent = '‚òÅÔ∏è Sincronizar Inventario';
            btn.style.cssText = `
                background: #FF9800;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            btn.onclick = sincronizarInventarioConGoogleSheets;
            
            const info = document.createElement('div');
            info.id = 'info-sync-bodega';
            info.style.cssText = 'font-size: 11px; color: white; margin-top: 5px; opacity: 0.8;';
            actualizarInfoSyncDeposito();
            
            btnContainer.appendChild(btn);
            btnContainer.appendChild(info);
            headerRight.appendChild(btnContainer);
        }
        
        function actualizarInfoSyncDeposito() {
            const info = document.getElementById('info-sync-bodega');
            if (!info) return;
            
            const ultimaSync = localStorage.getItem('ultima_sync_inventario_bodega');
            if (ultimaSync) {
                const fecha = new Date(ultimaSync);
                info.textContent = `Sync: ${fecha.toLocaleDateString('es-CO')} ${fecha.toLocaleTimeString('es-CO')}`;
            } else {
                info.textContent = 'No sincronizado';
            }
        }
        
        window.addEventListener('load', () => {
            setTimeout(agregarBotonSyncDeposito, 500);
        });

</script>

    <!-- MODAL: CREACI√ìN R√ÅPIDA DE PRODUCTO -->
    <div id="modal-rapido-producto" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚ûï Crear Producto R√°pido</h2>
            </div>
            <form id="form-rapido-producto" onsubmit="guardarProductoRapido(event)">
                <div class="modal-body">
                    <div class="info-box">
                        <h4>‚ÑπÔ∏è Creaci√≥n R√°pida</h4>
                        <p>Solo campos esenciales. Puedes editar detalles despu√©s en el tab "Gesti√≥n de Productos".</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Nombre del Producto</label>
                        <input type="text" id="rapido-producto-nombre" required 
                               placeholder="Ej: Carb√≥n Vegetal Premium">
                    </div>

                    <div class="form-group">
                        <label class="required">Categor√≠a</label>
                        <select id="rapido-producto-categoria" required>
                            <option value="">Seleccione...</option>
                            <option value="carbon">üî• Carb√≥n y Combustibles</option>
                            <option value="limpieza">üß¥ Productos de Limpieza</option>
                            <option value="desinfectante">üßº Desinfectantes</option>
                            <option value="cocina">üç≥ Insumos de Cocina</option>
                            <option value="desechable">üì¶ Desechables y Empaques</option>
                            <option value="uniforme">üëï Uniformes y EPP</option>
                            <option value="bolsa">üóëÔ∏è Bolsas y Residuos</option>
                            <option value="papel">üßª Papel y Toallas</option>
                            <option value="vajilla">üçΩÔ∏è Productos para Vajilla</option>
                            <option value="herramienta">üõ†Ô∏è Herramientas</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="required">Unidad de Medida</label>
                        <select id="rapido-producto-unidad" required>
                            <option value="unidades">Unidades</option>
                            <option value="kg">Kilogramos</option>
                            <option value="gramos">Gramos</option>
                            <option value="litros">Litros</option>
                            <option value="ml">Mililitros</option>
                            <option value="paquetes">Paquetes</option>
                            <option value="bultos">Bultos</option>
                            <option value="cajas">Cajas</option>
                            <option value="galones">Galones</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Stock Inicial (Opcional)</label>
                        <input type="number" id="rapido-producto-stock" min="0" step="0.01" 
                               placeholder="0" value="0">
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">
                            üí° Si ya tienes existencias, ingresa la cantidad. D√©jalo en 0 si a√∫n no tienes.
                        </small>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">‚úÖ Crear y Usar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalRapido('producto')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: CREACI√ìN R√ÅPIDA DE PROVEEDOR -->
    <div id="modal-rapido-proveedor" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>‚ûï Crear Proveedor R√°pido</h2>
            </div>
            <form id="form-rapido-proveedor" onsubmit="guardarProveedorRapido(event)">
                <div class="modal-body">
                    <div class="info-box">
                        <h4>‚ÑπÔ∏è Creaci√≥n R√°pida</h4>
                        <p>Solo campos esenciales. Puedes agregar m√°s detalles despu√©s en el tab "Proveedores".</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Nombre del Proveedor</label>
                        <input type="text" id="rapido-proveedor-nombre" required 
                               placeholder="Ej: Carbonera El Buen Asado">
                    </div>

                    <div class="form-group">
                        <label class="required">Contacto</label>
                        <input type="text" id="rapido-proveedor-contacto" required 
                               placeholder="Nombre del contacto">
                    </div>

                    <div class="form-group">
                        <label class="required">Tel√©fono</label>
                        <input type="tel" id="rapido-proveedor-telefono" required 
                               placeholder="Ej: 3001234567">
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">‚úÖ Crear y Usar</button>
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalRapido('proveedor')">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</body>
</html>
